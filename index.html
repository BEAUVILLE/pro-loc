<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>DIGIY LOC PRO ‚ôæÔ∏è ‚Äî Cockpit Propri√©taire</title>
<meta name="theme-color" content="#0b1020" />

<!-- ‚úÖ Supabase CDN (obligatoire: guard.js construit sb via supabase.createClient) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="./guard.js?v=locpro-wave-ultra-full"></script>

<style>
:root{
  --bg:#020617;
  --bg2:#0b1020;
  --card:rgba(255,255,255,.03);
  --line:#1f2937;
  --ink:#f9fafb;
  --muted:#cbd5f5;
  --gold:#facc15;
  --green:#22c55e;
  --danger:#ef4444;
  --shadow:0 22px 50px rgba(0,0,0,.55);
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  min-height:100vh;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  color:var(--ink);
  background:
    radial-gradient(900px 520px at 12% -10%, rgba(250,204,21,.16), transparent 60%),
    radial-gradient(900px 520px at 90% 0%, rgba(34,197,94,.12), transparent 60%),
    linear-gradient(180deg, var(--bg2), var(--bg));
}
a{color:inherit}
.wrap{max-width:1100px;margin:0 auto;padding:14px}
.top{
  display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
  padding:10px 12px;border:1px solid var(--line);border-radius:18px;background:var(--card);
  box-shadow:var(--shadow);
}
.brand{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.logo{
  width:40px;height:40px;border-radius:14px;
  background:linear-gradient(135deg, rgba(250,204,21,.35), rgba(34,197,94,.2));
  border:1px solid rgba(250,204,21,.35);
  box-shadow:0 0 22px rgba(250,204,21,.12);
}
.brand h1{margin:0;font-size:1.05rem;letter-spacing:.2px}
.brand .infinity{font-size:1.5rem;font-weight:900;margin-left:4px}
.brand .sub{color:var(--muted);font-weight:800;font-size:.92rem;margin-top:2px}

.pills{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.pill{
  border:1px solid rgba(148,163,184,.35);
  padding:7px 10px;border-radius:999px;background:rgba(255,255,255,.02);
  color:var(--muted);font-weight:900;font-size:.86rem;
}
.pill strong{color:#fff}
.pill.ok{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.10);color:#bbf7d0}
.pill.warn{border-color:rgba(250,204,21,.35);background:rgba(250,204,21,.10);color:#fde68a}

.btn{
  border:0; cursor:pointer;
  border-radius:14px;
  padding:11px 12px;
  font-weight:1000;
  background:rgba(255,255,255,.03);
  border:1px solid var(--line);
  color:var(--muted);
  transition:all 0.2s ease;
  text-decoration:none;
  display:inline-flex;align-items:center;justify-content:center;
}
.btn:hover:not(:disabled){filter:brightness(1.08);transform:translateY(-1px)}
.btn:active:not(:disabled){transform:translateY(0)}
.btn:disabled{opacity:0.5;cursor:not-allowed}
.btn.primary{background:var(--green);border-color:rgba(34,197,94,.25);color:#022c22}
.btn.gold{background:rgba(250,204,21,.14);border-color:rgba(250,204,21,.35);color:#fde68a}
.btn.danger{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.35);color:#fecaca}
.btn.ghost{background:rgba(255,255,255,.02)}
.btn.small{padding:9px 10px;border-radius:12px;min-height:44px}

.navRow{
  width:100%;
  display:flex;gap:10px;flex-wrap:wrap;
  align-items:center;justify-content:space-between;
  margin-top:10px;
}
.navLeft,.navRight{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.navLabel{
  color:var(--muted);
  font-weight:900;
  font-size:.86rem;
  padding:7px 10px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,.25);
  background:rgba(255,255,255,.02);
}

.grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:14px}
@media (max-width: 980px){ .grid{grid-template-columns:1fr} }

.card{
  border:1px solid var(--line);
  background:rgba(255,255,255,.03);
  border-radius:20px;
  box-shadow:var(--shadow);
  overflow:hidden;
}
.cardHead{
  padding:12px 14px;
  border-bottom:1px solid var(--line);
  display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
  background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.01));
}
.cardHead h2{margin:0;font-size:1.02rem}
.cardHead small{color:var(--muted);font-weight:800}
.cardBody{padding:14px}

.note{
  margin-top:10px;
  padding:10px 12px;border-radius:14px;
  border:1px solid rgba(148,163,184,.25);
  background:rgba(255,255,255,.03);
  color:var(--muted);
  white-space:pre-wrap;
  display:none;
}
.note.ok{display:block;border-color:rgba(34,197,94,.35);color:#bbf7d0;background:rgba(34,197,94,.09)}
.note.bad{display:block;border-color:rgba(239,68,68,.35);color:#fecaca;background:rgba(239,68,68,.09)}
.note.warn{display:block;border-color:rgba(250,204,21,.35);color:#fde68a;background:rgba(250,204,21,.09)}

.kv{display:grid;grid-template-columns:160px 1fr;gap:8px;margin-top:10px}
.kv div{padding:8px 10px;border:1px solid rgba(148,163,184,.18);border-radius:12px;background:rgba(255,255,255,.02)}
.kv .k{color:var(--muted);font-weight:900}
.kv .v{font-weight:1000;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

@media (max-width: 720px){
  .wrap{padding:12px}
  .btn{width:100%}
  .navRight .btn{width:100%}
  .kv{grid-template-columns:1fr}
}

.table{display:flex;flex-direction:column;gap:10px;margin-top:12px}
.row{
  border:1px solid rgba(148,163,184,.18);
  background:rgba(255,255,255,.02);
  border-radius:16px;
  padding:10px 12px;
}
.rowTop{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center}
.row b{font-weight:1100}
.mini{font-size:12px;color:var(--muted);font-weight:850;line-height:1.35}
.badge{
  padding:6px 10px;border-radius:999px;
  border:1px solid rgba(148,163,184,.25);
  background:rgba(255,255,255,.02);
  font-weight:950;font-size:12px;color:var(--muted);
}
.badge.ok{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.10);color:#bbf7d0}
.badge.warn{border-color:rgba(250,204,21,.35);background:rgba(250,204,21,.10);color:#fde68a}
.badge.bad{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.10);color:#fecaca}
</style>
</head>

<body>
<div class="wrap">

  <div class="top">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>DIGIY LOC PRO <span class="infinity">‚àû</span></h1>
        <div class="sub">Cockpit propri√©taire ‚Ä¢ s√©curis√© ‚Ä¢ 0% commission ‚Ä¢ paiement direct</div>
      </div>
    </div>

    <div class="pills">
      <div class="pill" id="pillUser">üë§ <strong>‚Äî</strong></div>
      <div class="pill warn" id="pillState">üîí D√©connect√©</div>
      <button class="btn danger small" id="btnLogout" style="display:none">üö™ D√©connexion</button>
    </div>

    <div class="navRow">
      <div class="navLeft">
        <a class="btn ghost small" id="btnBack" href="#">‚¨ÖÔ∏è Retour</a>
        <div class="navLabel" id="navPlace">Lieu : ‚Äî</div>
      </div>
      <div class="navRight">
        <a class="btn small" id="goToday" href="#">üìÖ Vue du jour</a>
        <button class="btn small" id="goApp" type="button">üè† APP</button>
        <a class="btn small" id="goPulse" href="#">üì≤ Pulse</a>
        <a class="btn small" id="goPlanning" href="#">üóìÔ∏è Planning</a>
        <a class="btn small" id="goListing" href="#">üìã Liste du jour</a>
        <a class="btn small" id="goLinks" href="#">üîó Liens / QR</a>
        <a class="btn small" id="goHealth" href="#">üß™ V√©rifier mon acc√®s</a>
      </div>
    </div>
  </div>

  <div class="grid">
    <!-- LEFT -->
    <section class="card">
      <div class="cardHead">
        <div>
          <h2>‚ö° Vue rapide</h2>
          <small>Ton acc√®s + tes infos en 10 secondes.</small>
        </div>
        <button class="btn" id="btnRefresh" type="button">‚Üª Recharger</button>
      </div>
      <div class="cardBody">
        <div class="kv">
          <div class="k">Lieu</div><div class="v" id="kvSlug">‚Äî</div>
          <div class="k">T√©l√©phone</div><div class="v" id="kvPhone">‚Äî</div>
          <div class="k">Owner ID</div><div class="v" id="kvOwner">‚Äî</div>
          <div class="k">Session</div><div class="v" id="kvSess">‚Äî</div>
        </div>

        <div class="note" id="noteMain"></div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
          <a class="btn gold" id="btnPublic" href="#" target="_blank" rel="noopener noreferrer">üëÅÔ∏è Ma fiche publique</a>
          <a class="btn" id="btnOpenPin" href="#">üîë Ouvrir l‚Äôacc√®s (PIN)</a>
        </div>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="card">
      <div class="cardHead">
        <div>
          <h2>üí≥ Cockpit Wave</h2>
          <small>D√©clarations ‚Üí v√©rification ‚Üí preuves (bient√¥t).</small>
        </div>
        <button class="btn gold" id="btnDeclareOwner" type="button">‚ûï Ajouter un paiement</button>
      </div>
      <div class="cardBody">
        <div class="kv">
          <div class="k">Total d√©clar√©s</div><div class="v" id="stTotal">‚Äî</div>
          <div class="k">Total v√©rifi√©s</div><div class="v" id="stVerified">‚Äî</div>
          <div class="k">Somme d√©clar√©e</div><div class="v" id="stSumTotal">‚Äî</div>
          <div class="k">Somme v√©rifi√©e</div><div class="v" id="stSumVerified">‚Äî</div>
        </div>

        <div class="note" id="noteWave"></div>
        <div class="table" id="waveList"></div>
      </div>
    </section>
  </div>

</div>

<script>
(async function(){
  "use strict";

  // Boot guard (bloque si pas de session)
  window.DIGIY_GUARD.requireSession({
    module: "loc_pro",
    redirect: "./pin.html"
  });

  const $ = (id)=>document.getElementById(id);
  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

  function money(v){
    const n = Number(v);
    if(Number.isFinite(n)) return n.toLocaleString("fr-FR") + " FCFA";
    return "‚Äî";
  }

  function showNote(elId, msg, type){
    const el = $(elId);
    if(!el) return;
    el.style.display = msg ? "block" : "none";
    el.classList.remove("ok","bad","warn");
    if(type) el.classList.add(type);
    el.textContent = msg || "";
  }

  const slug = (window.DIGIY_GUARD?.getSlug?.() || "").trim();
  if($("navPlace")) $("navPlace").textContent = "Lieu : " + (slug || "‚Äî");
  if($("kvSlug")) $("kvSlug").textContent = slug || "‚Äî";

  function withSlug(path){
    return window.DIGIY_GUARD?.withSlug ? window.DIGIY_GUARD.withSlug(path) : path;
  }
  function go(path){
    location.href = withSlug(path);
  }

  // ‚úÖ Nav links internes (slug conserv√©)
  const links = [
    ["btnBack","./index.html"],
    ["goToday","./today.html"],
    ["goPulse","./proprio-loc.html"],
    ["goPlanning","./planning.html"],
    ["goListing","./listing.html"],
    ["goLinks","./manage-links.html"],
    ["goHealth","./health-loc.html"],
    ["btnOpenPin","./pin.html"],
  ];
  links.forEach(([id, path])=>{
    const el = $(id);
    if(el && el.tagName === "A") el.href = withSlug(path);
  });

  // ‚úÖ Bouton APP (button)
  $("goApp")?.addEventListener("click", (e)=>{
    e.preventDefault();
    go("./app.html");
  });

  // ‚úÖ Fiche publique client
  if ($("btnPublic")) {
    const url = "https://beauville.github.io/digiy-loc/fiche.html"
      + (slug ? `?slug=${encodeURIComponent(slug)}` : "");
    $("btnPublic").href = url;
    $("btnPublic").target = "_blank";
    $("btnPublic").rel = "noopener noreferrer";
    $("btnPublic").textContent = "üëÅÔ∏è Ma fiche publique";
  }

  // Logout
  $("btnLogout")?.addEventListener("click", ()=>{
    window.DIGIY_GUARD?.logout?.(withSlug("./pin.html"));
  });

  // ---- SB SAFE (attend guard, jamais fig√© null)
  async function getSb(){
    for(let i=0;i<80;i++){
      const s = window.DIGIY_GUARD?.getSupabase?.() || window.DIGIY_GUARD?.sb || window.sb || window.__sb;
      if(s?.rpc) return s;
      await sleep(50);
    }
    throw new Error("Supabase pas pr√™t (guard non pr√™t). Recharge ou reconnecte-toi.");
  }

  async function rpcSafe(fn, params){
    const sb = await getSb();
    const { data, error } = await sb.rpc(fn, params);
    if(error) throw error;
    return data;
  }

  // ---- UI Session
  function refreshSessionUI(){
    const sess = window.DIGIY_GUARD?.getSession?.();
    const phone = sess?.phone || "‚Äî";
    const ownerId = sess?.owner_id || "‚Äî";
    const exp = sess?.exp ? new Date(Number(sess.exp)).toISOString().slice(0,16).replace("T"," ") : "";

    if($("kvPhone")) $("kvPhone").textContent = phone;
    if($("kvOwner")) $("kvOwner").textContent = ownerId;
    if($("kvSess")) $("kvSess").textContent = sess?.ok ? ("OK" + (exp ? " (expire : " + exp + ")" : "")) : "‚Äî";

    if(sess?.ok && sess?.phone){
      if($("pillUser")) $("pillUser").innerHTML = `üë§ <strong>${phone}</strong>`;
      if($("pillState")){
        $("pillState").textContent = "‚úÖ Connect√©";
        $("pillState").classList.remove("warn");
        $("pillState").classList.add("ok");
      }
      if($("btnLogout")) $("btnLogout").style.display = "inline-flex";

      showNote("noteMain",
        "‚úÖ Tout est OK.\nAstuce : partage la fiche publique au client. Il voit la galerie + WhatsApp direct.",
        "ok"
      );
      return true;
    }

    if($("pillUser")) $("pillUser").innerHTML = `üë§ <strong>‚Äî</strong>`;
    if($("pillState")){
      $("pillState").textContent = "üîí D√©connect√©";
      $("pillState").classList.remove("ok");
      $("pillState").classList.add("warn");
    }
    if($("btnLogout")) $("btnLogout").style.display = "none";
    showNote("noteMain", "üîí Acc√®s non ouvert. Entre ton t√©l√©phone + PIN.", "warn");
    return false;
  }

  $("btnRefresh")?.addEventListener("click", async ()=>{
    refreshSessionUI();
    await loadWave();
  });

  // ===== helpers =====
  function rowBadge(status){
    status = String(status || "declared").toLowerCase();
    if(status === "verified") return `<span class="badge ok">‚úÖ V√©rifi√©</span>`;
    if(status === "rejected") return `<span class="badge bad">‚õî Refus√©</span>`;
    return `<span class="badge warn">‚è≥ D√©clar√©</span>`;
  }

  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function escapeAttr(str){
    return escapeHtml(str).replaceAll("`","&#096;");
  }

   // ‚úÖ FIX: renderList utilise ownerId + verify_v2 + UUID
  function renderList(rows, ownerId){
    const box = $("waveList");
    if(!box) return;

    if(!rows || !rows.length){
      box.innerHTML = `<div class="row"><div class="mini">Aucun paiement d√©clar√© pour ce logement.</div></div>`;
      return;
    }

    box.innerHTML = rows.map(r=>{
      const dt = r.created_at ? new Date(r.created_at).toLocaleString("fr-FR") : "";
      const who = (r.client_name || "Client") + (r.client_phone ? " ¬∑ " + r.client_phone : "");
      const status = String(r.status || "declared").toLowerCase();

      const raw = (r.amount_fcfa ?? r.amount ?? 0);
      const amt = Number(raw);
      const amtTxt = (Number.isFinite(amt) && amt > 0) ? amt.toLocaleString("fr-FR") + " F" : (raw || "‚Äî");

      const proof = r.proof_url
        ? `<div style="margin-top:6px"><a href="${escapeAttr(r.proof_url)}" target="_blank" rel="noopener" style="font-size:12px;color:#facc15;font-weight:900">üìé Voir preuve</a></div>`
        : "";

      const verifyBtn = (status === "verified")
        ? `<button class="btn small" disabled>‚úÖ D√©j√† v√©rifi√©</button>`
        : `<button class="btn small primary jsVerify" data-id="${escapeAttr(r.id)}">‚úÖ V√©rifier</button>`;

      return `
        <div class="row">
          <div class="rowTop">
            <div>
              <b>${escapeHtml(amtTxt)}</b>
              <div class="mini">${escapeHtml(dt)}</div>
            </div>
            ${rowBadge(status)}
          </div>

          <div style="margin-top:8px;font-weight:950">${escapeHtml(who)}</div>
          ${proof}

          <div style="display:flex;justify-content:flex-end;margin-top:10px">
            ${verifyBtn}
          </div>
        </div>
      `;
    }).join("");

    // ‚úÖ EVENTS VERIFY (UUID)
    box.querySelectorAll(".jsVerify").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = String(btn.getAttribute("data-id") || "").trim(); // ‚úÖ UUID
        if(!id) return;

        const old = btn.textContent;
        btn.disabled = true;
        btn.textContent = "‚è≥ V√©rification‚Ä¶";

        try{
          await rpcSafe("loc_wave_payment_verify_v2", {
            p_id: id,
            p_slug: slug,
            p_owner_id: ownerId
          });

          showNote("noteWave", "‚úÖ Paiement v√©rifi√©.", "ok");
          await loadWave();
        }catch(e){
          console.error(e);
          showNote("noteWave", "‚ùå Erreur v√©rification : " + (e?.message || e), "bad");
          btn.disabled = false;
          btn.textContent = old;
        }
      });
    });
  }

  async function loadWave(){
    const sessOk = refreshSessionUI();
    if(!sessOk){
      showNote("noteWave", "üîí Connecte-toi (PIN) pour voir le cockpit Wave.", "warn");
      if($("waveList")) $("waveList").innerHTML = "";
      return;
    }

    const sess = window.DIGIY_GUARD?.getSession?.() || {};
    const ownerPhone = sess.phone || "";
    const ownerId = sess.owner_id || "";

    if(!ownerPhone || !slug){
      showNote("noteWave", "‚ö†Ô∏è T√©l√©phone ou slug manquant. Reconnecte-toi via PIN.", "bad");
      return;
    }

    try{
      showNote("noteWave", "‚è≥ Chargement des paiements‚Ä¶", "warn");

      const st = await rpcSafe("loc_wave_payments_stats_owner", {
        p_slug: slug,
        p_owner_phone: ownerPhone
      });

      $("stTotal").textContent = String(st.total_declared ?? st.count_total ?? 0);
      $("stVerified").textContent = String(st.total_verified ?? st.count_verified ?? 0);
      $("stSumTotal").textContent = money(st.sum_declared_fcfa ?? st.sum_total ?? 0);
      $("stSumVerified").textContent = money(st.sum_verified_fcfa ?? st.sum_verified ?? 0);

      const rows = await rpcSafe("loc_wave_payments_list_owner", {
        p_slug: slug,
        p_owner_id: ownerId
      });

      renderList(Array.isArray(rows) ? rows : [], ownerId);
      showNote("noteWave", "", "");
    }catch(e){
      console.error(e);
      showNote("noteWave", "‚ùå Erreur Wave : " + (e?.message || e), "bad");
    }

    if(ownerId && $("kvOwner")) $("kvOwner").textContent = ownerId;
  }

  // ===== DECLARE (V2 avec owner_id UUID) =====
  $("btnDeclareOwner")?.addEventListener("click", async ()=>{
    const sessOk = refreshSessionUI();
    if(!sessOk) return;

    const sess = window.DIGIY_GUARD?.getSession?.() || {};
    const ownerId = sess.owner_id || "";
    const placeSlug = (window.DIGIY_GUARD?.getSlug?.() || "").trim();

    if(!ownerId || !placeSlug){
      showNote("noteWave", "‚ö†Ô∏è owner_id ou slug manquant. Reconnecte-toi via PIN.", "bad");
      return;
    }

    const amount = prompt("Montant re√ßu (FCFA) ?");
    if(!amount) return;

    const amt = Number(String(amount).replace(/[^\d]/g,""));
    if(!Number.isFinite(amt) || amt <= 0){
      showNote("noteWave", "‚ùå Montant invalide.", "bad");
      return;
    }

    const clientName = prompt("Nom du client (optionnel) ?") || "";
    const clientPhone = prompt("T√©l√©phone client (optionnel) ?") || "";
    const note = prompt("Note (optionnel) ?") || "";

    try{
      showNote("noteWave", "‚è≥ D√©claration en cours‚Ä¶", "warn");

      const data = await rpcSafe("loc_wave_payment_declare_owner_v2", {
        p_slug: placeSlug,
        p_owner_id: ownerId,
        p_amount_fcfa: amt,
        p_client_name: clientName,
        p_client_phone: clientPhone,
        p_note: note
      });

      if(!data?.ok) throw new Error(data?.reason || "declare_failed");

      showNote("noteWave", "‚úÖ Paiement d√©clar√©. Tu peux le v√©rifier ensuite.", "ok");
      await loadWave();
    }catch(e){
      console.error(e);
      showNote("noteWave", "‚ùå Impossible d‚Äôenregistrer.\nD√©tail: " + (e?.message || e), "bad");
    }
  });

  // Boot final
  refreshSessionUI();
  await getSb();
  await loadWave();

})();
</script>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js')
        .then(reg => console.log('‚úÖ SW OK:', reg.scope))
        .catch(err => console.log('‚ö†Ô∏è SW error:', err.message));
    });
  }
</script>

</body>
</html>
