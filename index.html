<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>DIGIY LOC PRO â™¾ï¸ â€” Cockpit PropriÃ©taire</title>
<meta name="theme-color" content="#0b1020" />

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="./guard.js?v=locpro-final"></script>

<style>
:root{
  --bg:#020617;
  --bg2:#0b1020;
  --card:rgba(255,255,255,.03);
  --line:#1f2937;
  --ink:#f9fafb;
  --muted:#cbd5f5;
  --gold:#facc15;
  --green:#22c55e;
  --danger:#ef4444;
  --shadow:0 22px 50px rgba(0,0,0,.55);
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  min-height:100vh;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  color:var(--ink);
  background:
    radial-gradient(900px 520px at 12% -10%, rgba(250,204,21,.16), transparent 60%),
    radial-gradient(900px 520px at 90% 0%, rgba(34,197,94,.12), transparent 60%),
    linear-gradient(180deg, var(--bg2), var(--bg));
}
a{color:inherit}
.wrap{max-width:1100px;margin:0 auto;padding:14px}
.top{
  display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
  padding:10px 12px;border:1px solid var(--line);border-radius:18px;background:var(--card);
  box-shadow:var(--shadow);
}
.brand{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.logo{
  width:40px;height:40px;border-radius:14px;
  background:linear-gradient(135deg, rgba(250,204,21,.35), rgba(34,197,94,.2));
  border:1px solid rgba(250,204,21,.35);
  box-shadow:0 0 22px rgba(250,204,21,.12);
}
.brand h1{margin:0;font-size:1.05rem;letter-spacing:.2px}
.brand .infinity{font-size:1.5rem;font-weight:900;margin-left:4px}
.brand .sub{color:var(--muted);font-weight:800;font-size:.92rem;margin-top:2px}

.pills{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.pill{
  border:1px solid rgba(148,163,184,.35);
  padding:7px 10px;border-radius:999px;background:rgba(255,255,255,.02);
  color:var(--muted);font-weight:900;font-size:.86rem;
}
.pill strong{color:#fff}
.pill.ok{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.10);color:#bbf7d0}
.pill.warn{border-color:rgba(250,204,21,.35);background:rgba(250,204,21,.10);color:#fde68a}

.btn{
  border:0; cursor:pointer;
  border-radius:14px;
  padding:11px 12px;
  font-weight:1000;
  background:rgba(255,255,255,.03);
  border:1px solid var(--line);
  color:var(--muted);
  transition:all 0.2s ease;
  text-decoration:none;
  display:inline-flex;align-items:center;justify-content:center;
}
.btn:hover:not(:disabled){filter:brightness(1.08);transform:translateY(-1px)}
.btn:active:not(:disabled){transform:translateY(0)}
.btn:disabled{opacity:0.5;cursor:not-allowed}
.btn.primary{background:var(--green);border-color:rgba(34,197,94,.25);color:#022c22}
.btn.gold{background:rgba(250,204,21,.14);border-color:rgba(250,204,21,.35);color:#fde68a}
.btn.danger{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.35);color:#fecaca}
.btn.ghost{background:rgba(255,255,255,.02)}
.btn.small{padding:9px 10px;border-radius:12px;min-height:44px}

.navRow{
  width:100%;
  display:flex;gap:10px;flex-wrap:wrap;
  align-items:center;justify-content:space-between;
  margin-top:10px;
}
.navLeft,.navRight{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.navLabel{
  color:var(--muted);
  font-weight:900;
  font-size:.86rem;
  padding:7px 10px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,.25);
  background:rgba(255,255,255,.02);
}

.grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:14px}
@media (max-width: 980px){ .grid{grid-template-columns:1fr} }

.card{
  border:1px solid var(--line);
  background:rgba(255,255,255,.03);
  border-radius:20px;
  box-shadow:var(--shadow);
  overflow:hidden;
}
.cardHead{
  padding:12px 14px;
  border-bottom:1px solid var(--line);
  display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
  background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.01));
}
.cardHead h2{margin:0;font-size:1.02rem}
.cardHead small{color:var(--muted);font-weight:800}
.cardBody{padding:14px}

.note{
  margin-top:10px;
  padding:10px 12px;border-radius:14px;
  border:1px solid rgba(148,163,184,.25);
  background:rgba(255,255,255,.03);
  color:var(--muted);
  white-space:pre-wrap;
  display:none;
}
.note.ok{border-color:rgba(34,197,94,.35);color:#bbf7d0;background:rgba(34,197,94,.09)}
.note.bad{border-color:rgba(239,68,68,.35);color:#fecaca;background:rgba(239,68,68,.09)}
.note.warn{border-color:rgba(250,204,21,.35);color:#fde68a;background:rgba(250,204,21,.09)}

.kv{display:grid;grid-template-columns:160px 1fr;gap:8px;margin-top:10px}
.kv div{padding:8px 10px;border:1px solid rgba(148,163,184,.18);border-radius:12px;background:rgba(255,255,255,.02)}
.kv .k{color:var(--muted);font-weight:900}
.kv .v{font-weight:1000;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

@media (max-width: 720px){
  .wrap{padding:12px}
  .btn{width:100%}
  .navRight .btn{width:100%}
  .kv{grid-template-columns:1fr}
}
</style>
</head>

<body>
<div class="wrap">

  <div class="top">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>DIGIY LOC PRO <span class="infinity">âˆ</span></h1>
        <div class="sub">Cockpit propriÃ©taire â€¢ sÃ©curisÃ© â€¢ 0% commission â€¢ paiement direct</div>
      </div>
    </div>

    <div class="pills">
      <div class="pill" id="pillUser">ğŸ‘¤ <strong>â€”</strong></div>
      <div class="pill warn" id="pillState">ğŸ”’ DÃ©connectÃ©</div>
      <button class="btn danger small" id="btnLogout" style="display:none">ğŸšª DÃ©connexion</button>
    </div>

    <div class="navRow">
      <div class="navLeft">
        <a class="btn ghost small" id="btnBack" href="#">â¬…ï¸ Retour</a>
        <div class="navLabel" id="navPlace">Lieu : â€”</div>
      </div>
      <div class="navRight">
        <a class="btn small" id="goToday" href="#">ğŸ“… Vue du jour</a>
       <a class="btn small" id="goManage" href="#">ğŸ  GÃ©rer mes logements</a>
        <a class="btn small" id="goApp" href="#">ğŸ  GÃ©rer mes logements</a>
        <a class="btn small" id="goPulse" href="#">ğŸ“² Pulse</a>
        <a class="btn small" id="goPlanning" href="#">ğŸ—“ï¸ Planning</a>
        <a class="btn small" id="goListing" href="#">ğŸ“‹ Liste du jour</a>
        <a class="btn small" id="goLinks" href="#">ğŸ”— Liens / QR</a>
        <a class="btn small" id="goHealth" href="#">ğŸ§ª VÃ©rifier mon accÃ¨s</a>
      </div>
    </div>
  </div>

  <div class="grid">
    <section class="card">
      <div class="cardHead">
        <div>
          <h2>âš¡ Vue rapide</h2>
          <small>Ton accÃ¨s + tes infos en 10 secondes.</small>
        </div>
        <button class="btn" id="btnRefresh">â†» Recharger</button>
      </div>
      <div class="cardBody">
        <div class="kv">
          <div class="k">Lieu</div><div class="v" id="kvSlug">â€”</div>
          <div class="k">TÃ©lÃ©phone</div><div class="v" id="kvPhone">â€”</div>
          <div class="k">Owner ID</div><div class="v" id="kvOwner">â€”</div>
          <div class="k">Session</div><div class="v" id="kvSess">â€”</div>
        </div>

        <div class="note" id="noteMain"></div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
          <a class="btn gold" id="btnPublic" href="#" target="_blank" rel="noopener">ğŸ‘ï¸ GO PIN public</a>
          <a class="btn" id="btnOpenPin" href="#">ğŸ”‘ Ouvrir lâ€™accÃ¨s (PIN)</a>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="cardHead">
        <div>
          <h2>ğŸ¯ Actions rapides</h2>
          <small>Ce que tu fais le plus souvent.</small>
        </div>
      </div>
      <div class="cardBody">
        <div style="display:grid;grid-template-columns:1fr;gap:10px">
          <a class="btn primary" id="quickApp" href="#">ğŸ  Ajouter / modifier mes logements</a>
          <a class="btn" id="quickPlanning" href="#">ğŸ—“ï¸ Voir mon planning</a>
          <a class="btn" id="quickLinks" href="#">ğŸ”— Partager mes liens / QR</a>
          <a class="btn" id="quickHealth" href="#">ğŸ§ª Diagnostic (si Ã§a coince)</a>
          <a class="btn" id="quickNdimbal" href="#">ğŸ§­ NDIMBAL LOC â€” Mon bureau de poche</a>        </div>
      </div>
    </section>
  </div>

</div>

<script>
(function(){
  "use strict";

  // Boot guard (slug obligatoire)
  window.DIGIY_GUARD?.boot({
    module: "loc",
    login: "./pin.html",
    dashboard: "./index.html",
    requireSlug: true
  });

  const $ = (id)=>document.getElementById(id);

  function showNote(msg, type){
    const el = $("noteMain");
    if(!el) return;
    el.style.display = "block";
    el.classList.remove("ok","bad","warn");
    if(type) el.classList.add(type);
    el.textContent = msg;
  }
  function hideNote(){
    const el = $("noteMain");
    if(!el) return;
    el.style.display = "none";
    el.textContent = "";
    el.classList.remove("ok","bad","warn");
  }

  const slug = (window.DIGIY_GUARD?.getSlug?.() || "").trim();
  $("navPlace").textContent = "Lieu : " + (slug || "â€”");
  $("kvSlug").textContent = slug || "â€”";

  function withSlug(path){
    return window.DIGIY_GUARD?.withSlug ? window.DIGIY_GUARD.withSlug(path) : path;
  }

  // Nav href
  $("btnBack").href = withSlug("./index.html");
  $("goToday").href = withSlug("./today.html");
  $("goManage").href = withSlug("./app.html"); 
  $("goPulse").href = withSlug("./proprio-loc.html");
  $("goPlanning").href = withSlug("./planning.html");
  $("goListing").href = withSlug("./listing.html");
  $("goLinks").href = withSlug("./manage-links.html");
  $("goHealth").href = withSlug("./health-loc.html");
  $("quickApp").href = withSlug("./app.html");
  $("quickPlanning").href = withSlug("./planning.html");
  $("quickLinks").href = withSlug("./manage-links.html");
  $("quickHealth").href = withSlug("./health-loc.html");
  $("btnOpenPin").href = withSlug("./pin.html");

  // GO PIN public
  const pub = new URL("./go-pin.html", location.href);
  if(slug) pub.searchParams.set("slug", slug);
  $("btnPublic").href = pub.toString();
  // ğŸ” Force ouverture APP avec slug sÃ©curisÃ©
  document.getElementById("goApp")?.addEventListener("click", (e)=>{
    e.preventDefault();
    const url = window.DIGIY_GUARD.withSlug("./app.html");
    window.location.href = url;
  });
  function refresh(){
    hideNote();

    const sess = window.DIGIY_GUARD?.getSession?.();
    const phone = sess?.phone || "â€”";
    const owner = sess?.owner_id || "â€”";
    const exp = sess?.exp ? new Date(Number(sess.exp)).toISOString().slice(0,16).replace("T"," ") : "";

    $("kvPhone").textContent = phone;
    $("kvOwner").textContent = owner;
    $("kvSess").textContent = sess?.ok ? ("OK" + (exp ? " (expire : " + exp + ")" : "")) : "â€”";

    if(sess?.ok && sess?.phone){
      $("pillUser").innerHTML = `ğŸ‘¤ <strong>${phone}</strong>`;
      $("pillState").textContent = "âœ… ConnectÃ©";
      $("pillState").classList.remove("warn");
      $("pillState").classList.add("ok");
      $("btnLogout").style.display = "inline-flex";

      if(!sess?.owner_id){
        showNote(
          "âš ï¸ AccÃ¨s OK, mais ton identifiant propriÃ©taire nâ€™est pas chargÃ©.\n" +
          "â¡ï¸ DÃ©connecte-toi puis reconnecte-toi avec ton PIN.\n" +
          "âœ… Sinon tu peux continuer.",
          "warn"
        );
      } else {
        showNote("âœ… Tout est OK. Tu peux gÃ©rer tes logements.", "ok");
      }
      return;
    }

    // pas de session
    $("pillUser").innerHTML = `ğŸ‘¤ <strong>â€”</strong>`;
    $("pillState").textContent = "ğŸ”’ DÃ©connectÃ©";
    $("pillState").classList.remove("ok");
    $("pillState").classList.add("warn");
    $("btnLogout").style.display = "none";

    if(!slug){
      showNote("âš ï¸ Lien incomplet.\nâ¡ï¸ Ouvre le cockpit depuis le QR / GO PIN.", "bad");
    } else {
      showNote("ğŸ”’ AccÃ¨s non ouvert.\nâ¡ï¸ Mets ton tÃ©lÃ©phone + PIN pour entrer.", "warn");
    }
  }

  $("btnRefresh").addEventListener("click", refresh);

  $("btnLogout").addEventListener("click", ()=>{
  const url = window.DIGIY_GUARD.withSlug("./pin.html");
  window.DIGIY_GUARD.logout(url);
});

  refresh();
})();
</script>
</body>
</html>
