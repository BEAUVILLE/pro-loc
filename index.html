<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>DIGIY LOC PRO ‚àû ‚Äî Cockpit Propri√©taire</title>
  <meta name="theme-color" content="#0b1020" />

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
  :root{
    --bg:#020617;
    --bg2:#0b1020;
    --card:#0b1220;
    --line:#1f2937;
    --ink:#f9fafb;
    --muted:#cbd5f5;
    --gold:#facc15;
    --gold2:#f97316;
    --green:#22c55e;
    --danger:#ef4444;
    --soft:rgba(255,255,255,.04);
    --shadow:0 22px 50px rgba(0,0,0,.55);
  }
  *{box-sizing:border-box}
  body{
    margin:0; color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    background:
      radial-gradient(900px 520px at 12% -10%, rgba(250,204,21,.16), transparent 60%),
      radial-gradient(900px 520px at 90% 0%, rgba(34,197,94,.12), transparent 60%),
      linear-gradient(180deg, var(--bg2), var(--bg));
    min-height:100vh;
  }
  a{color:inherit}
  .wrap{max-width:1150px;margin:0 auto;padding:14px}

  .top{
    position:sticky; top:0; z-index:50;
    display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
    padding:10px 12px;border:1px solid var(--line);border-radius:18px;background:rgba(2,6,23,.72);
    box-shadow:var(--shadow);
    backdrop-filter: blur(10px);
  }
  .brand{display:flex;gap:10px;align-items:center;flex-wrap:wrap;min-width:0}
  .logo{
    width:40px;height:40px;border-radius:14px;
    background:linear-gradient(135deg, rgba(250,204,21,.35), rgba(34,197,94,.2));
    border:1px solid rgba(250,204,21,.35);
    box-shadow:0 0 22px rgba(250,204,21,.12);
    flex:0 0 auto;
  }
  .brand h1{margin:0;font-size:1.05rem;letter-spacing:.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:min(520px, 72vw)}
  .brand .infinity{font-size:1.5rem;font-weight:900;margin-left:4px}
  .brand .sub{color:var(--muted);font-weight:800;font-size:.92rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:min(520px, 72vw)}
  .pills{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .pill{
    border:1px solid rgba(148,163,184,.35);
    padding:7px 10px;border-radius:999px;background:rgba(255,255,255,.02);
    color:var(--muted);font-weight:900;font-size:.86rem;
  }
  .pill strong{color:#fff}
  .pill.ok{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.10);color:#bbf7d0}
  .pill.warn{border-color:rgba(250,204,21,.35);background:rgba(250,204,21,.10);color:#fde68a}

  .grid{display:grid;grid-template-columns:1fr 1.1fr;gap:14px;margin-top:14px}
  @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

  .card{
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    border-radius:20px;
    box-shadow:var(--shadow);
    overflow:hidden;
  }
  .cardHead{
    padding:12px 14px;
    border-bottom:1px solid var(--line);
    display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
    background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.01));
  }
  .cardHead h2{margin:0;font-size:1.02rem}
  .cardHead small{color:var(--muted);font-weight:800}
  .cardBody{padding:14px}
  hr.sep{border:none;border-top:1px solid rgba(148,163,184,.18);margin:12px 0}

  .btnRow{display:flex;gap:10px;flex-wrap:wrap}
  .btn{
    border:0; cursor:pointer;
    border-radius:14px;
    padding:11px 12px;
    font-weight:1000;
    background:rgba(255,255,255,.03);
    border:1px solid var(--line);
    color:var(--muted);
    transition:all 0.2s ease;
    min-height:44px;
    display:inline-flex;align-items:center;justify-content:center;
    gap:8px;
  }
  .btn:hover:not(:disabled){filter:brightness(1.08);transform:translateY(-1px)}
  .btn:active:not(:disabled){transform:translateY(0)}
  .btn:disabled{opacity:0.5;cursor:not-allowed}
  .btn.primary{background:var(--green);border-color:rgba(34,197,94,.25);color:#022c22}
  .btn.gold{background:rgba(250,204,21,.14);border-color:rgba(250,204,21,.35);color:#fde68a}
  .btn.danger{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.35);color:#fecaca}
  .btn.ghost{background:rgba(255,255,255,.02)}
  .btn.small{padding:9px 10px;border-radius:12px;min-height:38px}

  .note{
    margin-top:10px;
    padding:10px 12px;border-radius:14px;
    border:1px solid rgba(148,163,184,.25);
    background:rgba(255,255,255,.03);
    color:var(--muted);
    white-space:pre-wrap;
    display:none;
  }
  .note.ok{border-color:rgba(34,197,94,.35);color:#bbf7d0;background:rgba(34,197,94,.09)}
  .note.bad{border-color:rgba(239,68,68,.35);color:#fecaca;background:rgba(239,68,68,.09)}
  .note.warn{border-color:rgba(250,204,21,.35);color:#fde68a;background:rgba(250,204,21,.09)}

  .fieldGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width: 720px){ .fieldGrid{grid-template-columns:1fr} }

  label{display:block;font-size:.86rem;font-weight:950;color:#fff;margin:10px 0 6px}
  input, textarea, select{
    width:100%;
    border-radius:14px;
    border:1px solid var(--line);
    background:rgba(0,0,0,.18);
    color:var(--ink);
    padding:11px 12px;
    font-weight:850;
    outline:none;
    transition:all 0.2s ease;
  }
  input:focus, textarea:focus, select:focus{
    border-color:var(--gold);
    box-shadow:0 0 0 3px rgba(250,204,21,.15);
  }
  textarea{min-height:110px;resize:vertical}
  small.hint{display:block;color:var(--muted);font-weight:800;margin-top:6px;line-height:1.35}
  input[type="date"]{color-scheme:dark}

  .list{display:flex;flex-direction:column;gap:10px}
  .item{
    border:1px solid rgba(148,163,184,.25);
    background:rgba(255,255,255,.02);
    border-radius:16px;
    padding:12px;
    display:flex;gap:10px;align-items:flex-start;justify-content:space-between;
    transition:all 0.2s ease;
  }
  .item:hover{
    background:rgba(255,255,255,.04);
    border-color:rgba(250,204,21,.35);
  }
  .itemLeft{min-width:0}
  .itemTitle{font-weight:1000}
  .itemMeta{color:var(--muted);font-weight:800;font-size:.92rem;margin-top:3px}
  .tag{
    display:inline-flex;align-items:center;gap:7px;
    padding:6px 9px;border-radius:999px;
    border:1px solid rgba(148,163,184,.25);
    color:var(--muted);font-weight:950;font-size:.82rem;
  }
  .tag.dot::before{
    content:"";width:9px;height:9px;border-radius:99px;background:#94a3b8;display:inline-block;
  }
  .tag.live{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.10);color:#bbf7d0}
  .tag.live.dot::before{background:var(--green);box-shadow:0 0 10px rgba(34,197,94,.75)}
  .tag.draft{border-color:rgba(250,204,21,.35);background:rgba(250,204,21,.10);color:#fde68a}
  .tag.draft.dot::before{background:var(--gold)}
  .itemBtns{display:flex;flex-direction:column;gap:8px}
  .itemBtns .btn{padding:9px 10px;border-radius:12px}

  .previewBox{
    border:1px solid rgba(148,163,184,.25);
    background:rgba(255,255,255,.02);
    border-radius:18px;
    padding:12px;
  }
  .previewImg{
    width:100%;height:210px;object-fit:cover;border-radius:16px;
    border:1px solid rgba(148,163,184,.22);
    background:rgba(255,255,255,.03);
    display:block;
  }
  .videoWrap{
    margin-top:10px;border-radius:16px;overflow:hidden;
    border:1px solid rgba(148,163,184,.22);background:rgba(255,255,255,.03);
    display:none;
  }
  .videoWrap iframe{width:100%;height:230px;border:0;display:block}
  .miniRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .mini{
    border:1px solid rgba(148,163,184,.25);
    border-radius:999px;
    padding:8px 10px;
    font-weight:950;
    color:var(--muted);
    background:rgba(255,255,255,.02);
  }
  .mini strong{color:#fff}

  .simpleList{display:flex;flex-direction:column;gap:10px;margin-top:10px}
  .rowItem{
    border:1px solid rgba(148,163,184,.22);
    background:rgba(255,255,255,.02);
    border-radius:14px;
    padding:10px;
  }
  .rowTop{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
  .rowTop strong{font-weight:1100}
  .rowSub{color:var(--muted);font-weight:850;margin-top:4px;font-size:.92rem}

  .spinner{
    display:inline-block;
    width:16px;height:16px;
    border:2px solid rgba(255,255,255,.2);
    border-top-color:#fff;
    border-radius:50%;
    animation:spin 0.6s linear infinite;
  }
  @keyframes spin{ to{transform:rotate(360deg)} }

  .statsRow{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-top:10px}
  .statBox{
    border:1px solid rgba(148,163,184,.25);
    background:rgba(255,255,255,.02);
    border-radius:14px;
    padding:12px;
    text-align:center;
  }
  .statBox .num{font-size:1.8rem;font-weight:1100;color:var(--gold)}
  .statBox .lbl{color:var(--muted);font-weight:800;font-size:.82rem;margin-top:4px}

  /* Bar d'acc√®s rapide (simple, humain) */
  .quick{
    display:flex;gap:10px;flex-wrap:wrap;align-items:center;
    margin-top:12px;
  }
  .quick a.btn{ text-decoration:none }
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div class="brand">
      <div class="logo"></div>
      <div style="min-width:0">
        <h1>DIGIY LOC PRO <span class="infinity">‚àû</span></h1>
        <div class="sub">Cockpit Propri√©taire ‚Ä¢ simple, rapide, terrain</div>
      </div>
    </div>

    <div class="pills">
      <button class="btn ghost small" id="btnBack">‚Üê Retour</button>

      <div class="pill" id="pillUser">üë§ <strong>‚Äî</strong></div>
      <div class="pill warn" id="pillState">üîí D√©connect√©</div>
      <button class="btn ghost small" id="btnLogout" style="display:none">Se d√©connecter</button>
    </div>
  </div>

  <!-- Acc√®s rapides (humain, pas ing√©nieur) -->
  <div class="quick">
    <a class="btn small" href="./manage-links.html">üîó Mes liens</a>
    <a class="btn small" href="./listing.html?business=BEAUVILLE">üìã Listing du jour</a>
    <a class="btn small" href="./health-loc.html">ü©∫ Diagnostic</a>
    <a class="btn small" href="./create-pin.html">üß∑ Cr√©er GO PIN</a>
  </div>

  <div class="grid">
    <!-- LEFT -->
    <section class="card">
      <div class="cardHead">
        <div>
          <h2>üè° Mes logements</h2>
          <small>Cr√©er ‚Ä¢ √©diter ‚Ä¢ dupliquer ‚Ä¢ publier</small>
        </div>
        <div class="btnRow">
          <button class="btn gold" id="btnNew">+ Nouveau</button>
          <button class="btn" id="btnRefresh">‚Üª Actualiser</button>
        </div>
      </div>

      <div class="cardBody">
        <!-- AUTH -->
        <div id="authBox">
          <div class="previewBox">
            <div style="font-weight:1000;font-size:1.05rem;margin-bottom:6px;">üîê Connexion PRO</div>
            <div style="color:var(--muted);font-weight:800;">
              Connexion par email (Magic Link). Tu re√ßois un lien, tu cliques, termin√©.
            </div>

            <label>Email PRO</label>
            <input id="authEmail" type="email" placeholder="ex: ton-email@example.com" />

            <div class="btnRow" style="margin-top:12px">
              <button class="btn primary" id="btnSendOtp">üì© Envoyer le lien</button>
              <button class="btn" id="btnDemoFill">‚ö° Demo</button>
            </div>

            <small class="hint">Astuce: ouvre ton email sur ce m√™me navigateur.</small>
            <div class="note" id="authNote"></div>
          </div>
        </div>

        <!-- LIST -->
        <div id="listBox" style="display:none">
          <div class="statsRow" id="statsBox"></div>
          <div class="list" id="list"></div>
          <div class="note" id="listNote"></div>
        </div>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="card">
      <div class="cardHead">
        <div>
          <h2>‚ú® √âditeur Premium</h2>
          <small>Photo ‚Ä¢ vid√©o ‚Ä¢ Wave ‚Ä¢ tarifs ‚Ä¢ calendrier ‚Ä¢ acomptes</small>
        </div>
        <div class="btnRow">
          <button class="btn primary" id="btnSave" disabled>üíæ Enregistrer</button>
          <button class="btn gold" id="btnPublish" disabled>üöÄ Publier</button>
          <button class="btn" id="btnDraft" disabled>üìù Brouillon</button>
          <button class="btn danger small" id="btnDelete" disabled style="display:none">üóëÔ∏è Supprimer</button>
        </div>
      </div>

      <div class="cardBody">
        <div class="previewBox">
          <div style="font-weight:1000;margin-bottom:8px;">üëÅÔ∏è Pr√©visualisation</div>
          <img id="pvImg" class="previewImg" alt="photo logement" />
          <div class="videoWrap" id="pvVideoWrap">
            <iframe id="pvVideo" allow="autoplay; encrypted-media" allowfullscreen></iframe>
          </div>

          <div class="miniRow">
            <div class="mini">üìç <strong id="pvVille">‚Äî</strong></div>
            <div class="mini">üí≥ Wave: <strong id="pvWave">‚Äî</strong></div>
            <div class="mini">üè∑Ô∏è <strong id="pvStatus">‚Äî</strong></div>
          </div>

          <div class="btnRow" style="margin-top:10px">
            <button class="btn" id="btnOpenPublic" disabled>üëÅÔ∏è Ouvrir fiche publique</button>
            <button class="btn" id="btnTestMedia" disabled>üîé Tester m√©dias</button>
          </div>

          <div class="note" id="editNote"></div>
        </div>

        <hr class="sep" />

        <div class="fieldGrid">
          <div>
            <label>Nom du logement *</label>
            <input id="f_nom" placeholder="ex: Villa Paradise Saly" maxlength="100" />
            <small class="hint">Minimum 3 caract√®res</small>
          </div>
          <div>
            <label>Ville *</label>
            <input id="f_ville" placeholder="ex: Saly, Dakar, Saint-Louis" maxlength="50" />
          </div>
        </div>

        <div class="fieldGrid">
          <div>
            <label>Code business (unique)</label>
            <input id="f_business_code" placeholder="ex: VILLA_PARADISE_001" maxlength="50" />
            <small class="hint">Sert √† lier r√©servations + listing du jour</small>
          </div>
          <div>
            <label>Adresse (optionnel)</label>
            <input id="f_adresse" placeholder="Quartier, rep√®re..." maxlength="200" />
          </div>
        </div>

        <label>Description</label>
        <textarea id="f_desc" placeholder="D√©cris le lieu. Simple, vrai, rassurant." maxlength="2000"></textarea>
        <small class="hint">Max 2000 caract√®res</small>

        <div class="fieldGrid">
          <div>
            <label>Photo principale (URL) *</label>
            <input id="f_photo" placeholder="https://exemple.com/photo.jpg" />
            <small class="hint">jpg / jpeg / png / webp</small>
          </div>
          <div>
            <label>Vid√©o (Drive / YouTube / Vimeo)</label>
            <input id="f_video" placeholder="https://drive.google.com/file/d/..." />
          </div>
        </div>

        <div class="fieldGrid">
          <div>
            <label>Tarif nuit (FCFA) *</label>
            <input id="f_prix_nuit" type="number" min="1000" step="1000" placeholder="30000" />
            <small class="hint">Minimum 1000 FCFA</small>
          </div>
          <div>
            <label>Tarif semaine (FCFA)</label>
            <input id="f_prix_semaine" type="number" min="0" step="1000" placeholder="175000" />
          </div>
        </div>

        <div class="fieldGrid">
          <div>
            <label>Tarif mois (FCFA)</label>
            <input id="f_prix_mois" type="number" min="0" step="1000" placeholder="550000" />
          </div>
          <div>
            <label>Suppl√©ments / notes</label>
            <input id="f_frais" placeholder="ex: √âlectricit√© en sus selon conso" maxlength="200" />
          </div>
        </div>

        <hr class="sep" />

        <div class="fieldGrid">
          <div>
            <label>Wave ‚Äî Num√©ro *</label>
            <input id="f_wave_phone" placeholder="+221 77 123 45 67" />
            <small class="hint">+221 suivi de 9 chiffres</small>
          </div>
          <div>
            <label>Wave ‚Äî Nom affich√© *</label>
            <input id="f_wave_name" placeholder="ex: VILLA PARADISE" maxlength="50" />
            <small class="hint">Nom qui s'affiche sur Wave</small>
          </div>
        </div>

        <div class="fieldGrid">
          <div>
            <label>Lien Wave Pay (optionnel)</label>
            <input id="f_wave_link" placeholder="https://pay.wave.com/..." />
          </div>
          <div>
            <label>Acompte (%) *</label>
            <input id="f_deposit" type="number" min="0" max="100" step="5" placeholder="30" />
            <small class="hint">0 ‚Üí 100%</small>
          </div>
        </div>

        <label>Statut</label>
        <select id="f_status">
          <option value="brouillon">üìù Brouillon (non visible)</option>
          <option value="actif">‚úÖ Actif (visible publiquement)</option>
        </select>

        <div class="note" id="saveNote"></div>

        <hr class="sep"/>

        <!-- CALENDRIER -->
        <div class="previewBox">
          <div style="font-weight:1100">üìÖ Calendrier (bloquer dates)</div>
          <small class="hint">Bloque les p√©riodes occup√©es. La fiche publique affichera dispo/non dispo.</small>

          <div class="fieldGrid" style="margin-top:8px">
            <div>
              <label>D√©but *</label>
              <input type="date" id="calStart">
            </div>
            <div>
              <label>Fin *</label>
              <input type="date" id="calEnd">
            </div>
          </div>

          <label>Raison (optionnel)</label>
          <input id="calReason" placeholder="ex: Occup√© / Maintenance / R√©serv√© ailleurs" maxlength="100" />

          <div class="btnRow" style="margin-top:10px">
            <button class="btn primary" id="btnAddBlock" disabled>‚ûï Bloquer p√©riode</button>
            <button class="btn" id="btnReloadBlocks" disabled>‚Üª Recharger</button>
          </div>

          <div class="note" id="calNote"></div>
          <div class="simpleList" id="calList"></div>
        </div>

        <hr class="sep"/>

        <!-- ACOMPTES -->
        <div class="previewBox">
          <div style="font-weight:1100">üí≥ Acomptes (preuves Wave)</div>
          <small class="hint">Confirme ou rejette chaque paiement.</small>

          <div class="btnRow" style="margin-top:10px">
            <button class="btn" id="btnReloadPays" disabled>‚Üª Recharger</button>
          </div>

          <div class="note" id="payAdminNote"></div>
          <div class="simpleList" id="payList"></div>
        </div>

      </div>
    </section>
  </div>
</div>

<script>
/* =============================
   SUPABASE CONFIG
============================= */
const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";
const SB = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* =============================
   MAGIC LINK CLEAN (√©vite pages ‚Äúpollu√©es‚Äù)
============================= */
(function cleanMagicLink(){
  try{
    const h = location.hash || "";
    // Supabase met parfois des tokens dans le hash (#access_token=...)
    if(h.includes("access_token") || h.includes("refresh_token") || h.includes("type=recovery")){
      history.replaceState(null, "", location.pathname + location.search);
    }
  }catch(_){}
})();

/* =============================
   DOM ELEMENTS
============================= */
const authBox = document.getElementById("authBox");
const listBox = document.getElementById("listBox");
const listEl = document.getElementById("list");
const statsBox = document.getElementById("statsBox");
const pillUser = document.getElementById("pillUser");
const pillState = document.getElementById("pillState");
const btnLogout = document.getElementById("btnLogout");

const authEmail = document.getElementById("authEmail");
const btnSendOtp = document.getElementById("btnSendOtp");
const btnDemoFill = document.getElementById("btnDemoFill");
const authNote = document.getElementById("authNote");

const btnNew = document.getElementById("btnNew");
const btnRefresh = document.getElementById("btnRefresh");
const listNote = document.getElementById("listNote");

const btnSave = document.getElementById("btnSave");
const btnPublish = document.getElementById("btnPublish");
const btnDraft = document.getElementById("btnDraft");
const btnDelete = document.getElementById("btnDelete");
const btnOpenPublic = document.getElementById("btnOpenPublic");
const btnTestMedia = document.getElementById("btnTestMedia");

const pvImg = document.getElementById("pvImg");
const pvVille = document.getElementById("pvVille");
const pvWave = document.getElementById("pvWave");
const pvStatus = document.getElementById("pvStatus");
const pvVideoWrap = document.getElementById("pvVideoWrap");
const pvVideo = document.getElementById("pvVideo");
const editNote = document.getElementById("editNote");
const saveNote = document.getElementById("saveNote");

const f_nom = document.getElementById("f_nom");
const f_ville = document.getElementById("f_ville");
const f_business_code = document.getElementById("f_business_code");
const f_adresse = document.getElementById("f_adresse");
const f_desc = document.getElementById("f_desc");
const f_photo = document.getElementById("f_photo");
const f_video = document.getElementById("f_video");
const f_prix_nuit = document.getElementById("f_prix_nuit");
const f_prix_semaine = document.getElementById("f_prix_semaine");
const f_prix_mois = document.getElementById("f_prix_mois");
const f_frais = document.getElementById("f_frais");
const f_wave_phone = document.getElementById("f_wave_phone");
const f_wave_name = document.getElementById("f_wave_name");
const f_wave_link = document.getElementById("f_wave_link");
const f_deposit = document.getElementById("f_deposit");
const f_status = document.getElementById("f_status");

const calStart = document.getElementById("calStart");
const calEnd = document.getElementById("calEnd");
const calReason = document.getElementById("calReason");
const btnAddBlock = document.getElementById("btnAddBlock");
const btnReloadBlocks = document.getElementById("btnReloadBlocks");
const calNote = document.getElementById("calNote");
const calList = document.getElementById("calList");

const btnReloadPays = document.getElementById("btnReloadPays");
const payAdminNote = document.getElementById("payAdminNote");
const payList = document.getElementById("payList");

/* =============================
   STATE
============================= */
let sessionUser = null;
let current = null;
let hasUnsavedChanges = false;
const FALLBACK_PHOTO = "https://digiylyfe.com/wp-content/uploads/2025/06/042-BAPTISTE.png";

/* =============================
   APP BACK (reste dans l'app)
============================= */
(function appBack(){
  const btn = document.getElementById("btnBack");
  if(!btn) return;

  function safeBack(){
    if (window.history.length > 1) {
      window.history.back();
      return;
    }
    // fallback ‚Äúapp‚Äù
    window.location.href = "./app.html";
  }

  btn.addEventListener("click", (e)=>{
    e.preventDefault();
    if(hasUnsavedChanges){
      if(!confirm("‚ö†Ô∏è Modifications non sauvegard√©es. Revenir quand m√™me ?")) return;
    }
    safeBack();
  });
})();

/* =============================
   UTILITY FUNCTIONS
============================= */
function showNote(el, msg, type){
  el.style.display = "block";
  el.classList.remove("ok","bad","warn");
  if(type) el.classList.add(type);
  el.textContent = msg;
}
function hideNote(el){
  el.style.display="none";
  el.textContent="";
  el.classList.remove("ok","bad","warn");
}

function toEmbedUrl(u){
  const s = String(u||"").trim();
  if(!s) return "";
  let m = s.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([A-Za-z0-9_\-]+)/);
  if(m && m[1]) return "https://www.youtube.com/embed/" + m[1];
  m = s.match(/vimeo\.com\/(\d+)/);
  if(m && m[1]) return "https://player.vimeo.com/video/" + m[1];
  m = s.match(/drive\.google\.com\/file\/d\/([^/]+)/);
  if(m && m[1]) return "https://drive.google.com/file/d/" + m[1] + "/preview";
  m = s.match(/drive\.google\.com\/open\?id=([^&]+)/);
  if(m && m[1]) return "https://drive.google.com/file/d/" + m[1] + "/preview";
  return "";
}

function normalizeStatus(s){
  const v = String(s||"").toLowerCase().trim();
  if(["actif","active","published","online"].includes(v)) return "actif";
  return "brouillon";
}

function rowTag(status){
  const s = normalizeStatus(status);
  if(s==="actif") return `<span class="tag dot live">Actif</span>`;
  return `<span class="tag dot draft">Brouillon</span>`;
}

function generateBusinessCode(nom, ville){
  const n = (nom||"").toUpperCase().replace(/[^A-Z0-9]/g,"_").slice(0,20);
  const v = (ville||"").toUpperCase().replace(/[^A-Z0-9]/g,"_").slice(0,10);
  const rand = Math.random().toString(36).substr(2,3).toUpperCase();
  return `${n}_${v}_${rand}`;
}

/* =============================
   VALIDATION
============================= */
function validateListing(p){
  const errors = [];
  if(!p.nom || p.nom.length < 3) errors.push("‚ùå Nom trop court (minimum 3 caract√®res)");
  if(!p.ville || p.ville.length < 2) errors.push("‚ùå Ville invalide (minimum 2 caract√®res)");

  if(!p.photo_url){
    errors.push("‚ùå Photo URL obligatoire");
  }else if(!p.photo_url.match(/^https?:\/\/.+\.(jpg|jpeg|png|webp)(\?.*)?$/i)){
    errors.push("‚ùå Photo URL invalide (jpg/jpeg/png/webp + http)");
  }

  if(!p.wave_phone){
    errors.push("‚ùå Num√©ro Wave obligatoire");
  }else if(!/^\+?221\s?[7-9]\d{8}$/.test(p.wave_phone.replace(/\s/g,""))){
    errors.push("‚ùå Num√©ro Wave invalide (format: +221 7X XXX XX XX)");
  }

  if(!p.wave_name || p.wave_name.length < 2) errors.push("‚ùå Nom Wave obligatoire");
  if(!p.prix_nuit || p.prix_nuit < 1000) errors.push("‚ùå Prix nuit minimum: 1000 FCFA");
  if(p.deposit_percent < 0 || p.deposit_percent > 100) errors.push("‚ùå Acompte doit √™tre entre 0 et 100%");

  if(p.business_code && !/^[A-Z0-9_]{3,50}$/.test(p.business_code)){
    errors.push("‚ùå Code business invalide (A-Z, 0-9, _)");
  }
  return errors;
}

/* =============================
   UI STATE
============================= */
function enableEditorActions(yes){
  btnSave.disabled = !yes;
  btnPublish.disabled = !yes;
  btnDraft.disabled = !yes;
  btnOpenPublic.disabled = !yes;
  btnTestMedia.disabled = !yes;
  btnAddBlock.disabled = !yes;
  btnReloadBlocks.disabled = !yes;
  btnReloadPays.disabled = !yes;
}

function setConnectedUI(user){
  sessionUser = user || null;
  pillUser.innerHTML = `üë§ <strong>${user ? (user.email || "PRO") : "‚Äî"}</strong>`;

  if(user){
    pillState.textContent = "‚úÖ Connect√©";
    pillState.classList.remove("warn");
    pillState.classList.add("ok");
    btnLogout.style.display = "inline-flex";
    authBox.style.display = "none";
    listBox.style.display = "block";
    enableEditorActions(true);
  }else{
    pillState.textContent = "üîí D√©connect√©";
    pillState.classList.remove("ok");
    pillState.classList.add("warn");
    btnLogout.style.display = "none";
    authBox.style.display = "block";
    listBox.style.display = "none";
    enableEditorActions(false);
    btnDelete.style.display = "none";
  }
}

async function refreshSession(){
  const { data } = await SB.auth.getSession();
  setConnectedUI(data?.session?.user || null);
  if(data?.session?.user) await loadList();
}

/* =============================
   UNSAVED CHANGES WARNING
============================= */
function markDirty(){ hasUnsavedChanges = true; }
function markClean(){ hasUnsavedChanges = false; }

[
  f_nom,f_ville,f_business_code,f_adresse,f_desc,f_photo,f_video,
  f_prix_nuit,f_prix_semaine,f_prix_mois,f_frais,f_wave_phone,f_wave_name,
  f_wave_link,f_deposit,f_status
].forEach(input=>{
  input.addEventListener('input', markDirty);
  input.addEventListener('change', markDirty);
});

window.addEventListener('beforeunload', (e)=>{
  if(hasUnsavedChanges){
    e.preventDefault();
    e.returnValue = 'Tu as des modifications non sauvegard√©es!';
  }
});

/* =============================
   AUTH
============================= */
btnDemoFill.onclick = ()=>{
  authEmail.value = "baptistejb24@gmail.com";
  showNote(authNote, '‚úÖ Demo rempli. Clique "Envoyer le lien".', "ok");
};

btnSendOtp.onclick = async ()=>{
  hideNote(authNote);
  const email = authEmail.value.trim();
  if(!email || !email.includes("@")){
    return showNote(authNote, "‚ùå Email invalide.", "bad");
  }

  btnSendOtp.disabled = true;
  btnSendOtp.innerHTML = '<span class="spinner"></span> Envoi...';

  try{
    // IMPORTANT: on revient sur index.html (pas manage-links), c‚Äôest plus fluide
    const { error } = await SB.auth.signInWithOtp({
      email,
      options: { emailRedirectTo: location.origin + location.pathname }
    });
    if(error) throw error;
    showNote(authNote, "‚úÖ Lien envoy√©! Ouvre ton email et clique le lien magique.", "ok");
  }catch(e){
    console.error(e);
    showNote(authNote, "‚ùå Erreur: " + (e?.message || e), "bad");
  }finally{
    btnSendOtp.disabled = false;
    btnSendOtp.innerHTML = 'üì© Envoyer le lien';
  }
};

btnLogout.onclick = async ()=>{
  if(hasUnsavedChanges && !confirm("‚ö†Ô∏è Modifications non sauvegard√©es. D√©connexion quand m√™me ?")){
    return;
  }
  await SB.auth.signOut();
  current = null;
  paintEditor(null);
  setConnectedUI(null);
  markClean();
};

/* =============================
   LIST
============================= */
async function loadList(){
  hideNote(listNote);
  listEl.innerHTML = "";
  statsBox.innerHTML = "";

  btnRefresh.disabled = true;
  btnRefresh.innerHTML = '<span class="spinner"></span> Chargement...';

  try{
    const uid = sessionUser?.id;
    if(!uid) throw new Error("Non connect√©");

    const { data, error } = await SB
      .from("digiy_logements")
      .select("id,nom,ville,business_code,status,updated_at,created_at,owner_id,prix_nuit")
      .eq("owner_id", uid)
      .order("updated_at", { ascending:false })
      .limit(100);

    if(error) throw error;

    const total = data?.length || 0;
    const actifs = data?.filter(x=>normalizeStatus(x.status)==="actif").length || 0;
    const brouillons = total - actifs;

    if(total > 0){
      statsBox.innerHTML = `
        <div class="statBox"><div class="num">${total}</div><div class="lbl">Total</div></div>
        <div class="statBox"><div class="num">${actifs}</div><div class="lbl">Actifs</div></div>
        <div class="statBox"><div class="num">${brouillons}</div><div class="lbl">Brouillons</div></div>
      `;
    }

    if(!data || total===0){
      return showNote(listNote, '‚ú® Aucun logement. Clique "+ Nouveau" pour commencer.', "ok");
    }

    data.forEach(item=>{
      const div = document.createElement("div");
      div.className = "item";
      const dt = (item.updated_at || item.created_at || "").toString().slice(0,16).replace("T"," ");
      const bc = item.business_code ? `<span class="tag">üîë ${item.business_code}</span>` : "";

      div.innerHTML = `
        <div class="itemLeft">
          <div class="itemTitle">${item.nom || "Logement"}</div>
          <div class="itemMeta">${item.ville || ""} ‚Ä¢ ${item.prix_nuit ? Number(item.prix_nuit).toLocaleString("fr-FR") + " FCFA/nuit" : "‚Äî"}</div>
          <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
            ${rowTag(item.status)}
            ${bc}
            <span class="tag">üïí ${dt}</span>
          </div>
        </div>
        <div class="itemBtns">
          <button class="btn gold small" data-open="${item.id}">‚úèÔ∏è √âditer</button>
          <button class="btn small" data-dup="${item.id}">üìã Dupliquer</button>
          <button class="btn ghost small" data-view="${item.id}">üëÅÔ∏è Fiche</button>
        </div>
      `;
      listEl.appendChild(div);
    });

    listEl.querySelectorAll("[data-open]").forEach(b=>{
      b.onclick = ()=> openOne(b.getAttribute("data-open"));
    });
    listEl.querySelectorAll("[data-view]").forEach(b=>{
      b.onclick = ()=> window.open("loc.html?id=" + encodeURIComponent(b.getAttribute("data-view")), "_blank");
    });
    listEl.querySelectorAll("[data-dup]").forEach(b=>{
      b.onclick = ()=> duplicateOne(b.getAttribute("data-dup"));
    });

    showNote(listNote, `‚úÖ ${total} logement(s) charg√©(s).`, "ok");
  }catch(e){
    console.error(e);
    showNote(listNote, "‚ùå Erreur chargement:\n" + (e?.message || e), "bad");
  }finally{
    btnRefresh.disabled = false;
    btnRefresh.innerHTML = '‚Üª Actualiser';
  }
}
btnRefresh.onclick = async ()=>{ await loadList(); };

/* =============================
   OPEN / NEW
============================= */
async function openOne(id){
  if(hasUnsavedChanges && !confirm("‚ö†Ô∏è Modifications non sauvegard√©es. Continuer ?")){
    return;
  }

  hideNote(editNote); hideNote(saveNote); hideNote(calNote); hideNote(payAdminNote);
  calList.innerHTML = "";
  payList.innerHTML = "";

  const uid = sessionUser?.id;
  if(!uid) return showNote(editNote, "‚ùå Non connect√©.", "bad");

  const { data, error } = await SB
    .from("digiy_logements")
    .select("*")
    .eq("id", id)
    .eq("owner_id", uid)
    .single();

  if(error || !data){
    console.error(error);
    return showNote(editNote, "‚ùå Impossible d'ouvrir (pas √† toi / introuvable):\n" + (error?.message || ""), "bad");
  }

  current = data;
  paintEditor(current);
  markClean();

  btnDelete.style.display = "inline-flex";
  await loadBlocksForCurrent();
  await loadPaymentsForCurrent();
}

function newDraft(){
  if(hasUnsavedChanges && !confirm("‚ö†Ô∏è Modifications non sauvegard√©es. Continuer ?")){
    return;
  }

  const uid = sessionUser?.id || null;
  current = {
    id: null,
    owner_id: uid,
    nom: "",
    ville: "",
    business_code: "",
    adresse: "",
    description: "",
    photo_url: "",
    video_url: "",
    prix_nuit: 0,
    prix_semaine: 0,
    prix_mois: 0,
    frais_supplements: "",
    wave_phone: "",
    wave_name: "",
    wave_pay_link: "",
    deposit_percent: 30,
    status: "brouillon"
  };

  paintEditor(current);
  calList.innerHTML = "";
  payList.innerHTML = "";
  btnDelete.style.display = "none";
  markClean();
  showNote(editNote, "‚ú® Nouveau logement pr√™t. Remplis puis Enregistrer.", "ok");
}
btnNew.onclick = newDraft;

/* =============================
   PAINT EDITOR
============================= */
function paintEditor(x){
  hideNote(editNote); hideNote(saveNote);

  if(!x){
    pvImg.src = FALLBACK_PHOTO;
    pvVille.textContent = "‚Äî";
    pvWave.textContent = "‚Äî";
    pvStatus.textContent = "‚Äî";
    pvVideoWrap.style.display = "none";
    pvVideo.src = "";
    [
      f_nom,f_ville,f_business_code,f_adresse,f_desc,f_photo,f_video,
      f_prix_nuit,f_prix_semaine,f_prix_mois,f_frais,f_wave_phone,f_wave_name,f_wave_link,f_deposit
    ].forEach(i=>i.value="");
    f_status.value = "brouillon";
    return;
  }

  f_nom.value = x.nom || "";
  f_ville.value = x.ville || "";
  f_business_code.value = x.business_code || "";
  f_adresse.value = x.adresse || "";
  f_desc.value = x.description || "";
  f_photo.value = x.photo_url || "";
  f_video.value = x.video_url || "";
  f_prix_nuit.value = Number(x.prix_nuit || 0);
  f_prix_semaine.value = Number(x.prix_semaine || 0);
  f_prix_mois.value = Number(x.prix_mois || 0);
  f_frais.value = x.frais_supplements || "";
  f_wave_phone.value = x.wave_phone || "";
  f_wave_name.value = x.wave_name || "";
  f_wave_link.value = x.wave_pay_link || "";
  f_deposit.value = Number(x.deposit_percent || 30);
  f_status.value = normalizeStatus(x.status);

  const imgUrl = (x.photo_url && String(x.photo_url).startsWith("http")) ? x.photo_url : FALLBACK_PHOTO;
  pvImg.src = imgUrl;

  pvVille.textContent = x.ville || "‚Äî";
  const wn = (x.wave_name || "").trim();
  const wp = (x.wave_phone || "").trim();
  pvWave.textContent = (wn ? wn + " ‚Ä¢ " : "") + (wp || "‚Äî");
  pvStatus.textContent = normalizeStatus(x.status);

  const embed = toEmbedUrl(x.video_url);
  if(embed){
    pvVideo.src = embed;
    pvVideoWrap.style.display = "block";
  }else{
    pvVideo.src = "";
    pvVideoWrap.style.display = "none";
  }
}

/* =============================
   COLLECT FORM
============================= */
function collectForm(){
  const uid = sessionUser?.id || null;
  let businessCode = f_business_code.value.trim();

  if(!businessCode && f_nom.value && f_ville.value){
    businessCode = generateBusinessCode(f_nom.value, f_ville.value);
    f_business_code.value = businessCode;
  }

  return {
    owner_id: uid,
    nom: f_nom.value.trim(),
    ville: f_ville.value.trim(),
    business_code: businessCode,
    adresse: f_adresse.value.trim(),
    description: f_desc.value.trim(),
    photo_url: f_photo.value.trim(),
    video_url: f_video.value.trim(),
    prix_nuit: Number(f_prix_nuit.value || 0),
    prix_semaine: Number(f_prix_semaine.value || 0),
    prix_mois: Number(f_prix_mois.value || 0),
    frais_supplements: f_frais.value.trim(),
    wave_phone: f_wave_phone.value.trim(),
    wave_name: f_wave_name.value.trim(),
    wave_pay_link: f_wave_link.value.trim(),
    deposit_percent: Number(f_deposit.value || 30),
    status: normalizeStatus(f_status.value)
  };
}

/* =============================
   SAVE
============================= */
async function saveRecord(mode){
  hideNote(saveNote);
  if(!sessionUser) return showNote(saveNote, "‚ùå Connecte-toi d'abord.", "bad");

  const payload = collectForm();
  const errors = validateListing(payload);
  if(errors.length > 0) return showNote(saveNote, errors.join("\n"), "bad");

  if(mode==="publish") payload.status = "actif";
  if(mode==="draft") payload.status = "brouillon";

  btnSave.disabled = true;
  btnPublish.disabled = true;
  btnDraft.disabled = true;
  btnSave.innerHTML = '<span class="spinner"></span> Sauvegarde...';

  try{
    if(!current || !current.id){
      const { data, error } = await SB
        .from("digiy_logements")
        .insert(payload)
        .select("id")
        .single();
      if(error) throw error;

      current.id = data.id;
      showNote(saveNote, `‚úÖ Cr√©√©! ID: ${current.id}`, "ok");
    }else{
      const { error } = await SB
        .from("digiy_logements")
        .update(payload)
        .eq("id", current.id)
        .eq("owner_id", sessionUser.id);

      if(error) throw error;
      showNote(saveNote, "‚úÖ Sauvegard√©!", "ok");
    }

    markClean();
    await openOne(current.id);
    await loadList();
  }catch(e){
    console.error(e);
    showNote(saveNote, "‚ùå Erreur:\n" + (e?.message || e), "bad");
  }finally{
    btnSave.disabled = false;
    btnPublish.disabled = false;
    btnDraft.disabled = false;
    btnSave.innerHTML = 'üíæ Enregistrer';
  }
}
btnSave.onclick = ()=> saveRecord("save");
btnPublish.onclick = ()=> saveRecord("publish");
btnDraft.onclick = ()=> saveRecord("draft");

/* =============================
   DELETE
============================= */
btnDelete.onclick = async ()=>{
  if(!current || !current.id) return;

  if(!confirm(`‚ö†Ô∏è SUPPRIMER d√©finitivement "${current.nom}" ?\n\nCette action est irr√©versible!`)) return;
  if(!confirm("‚ö†Ô∏è DERNI√àRE CONFIRMATION: Supprimer ce logement ?")) return;

  btnDelete.disabled = true;
  btnDelete.innerHTML = '<span class="spinner"></span> Suppression...';

  try{
    const { error } = await SB
      .from("digiy_logements")
      .delete()
      .eq("id", current.id)
      .eq("owner_id", sessionUser.id);

    if(error) throw error;

    showNote(editNote, "‚úÖ Logement supprim√©!", "ok");
    current = null;
    paintEditor(null);
    markClean();
    btnDelete.style.display = "none";
    await loadList();
  }catch(e){
    console.error(e);
    showNote(editNote, "‚ùå Suppression refus√©e:\n" + (e?.message || e), "bad");
  }finally{
    btnDelete.disabled = false;
    btnDelete.innerHTML = 'üóëÔ∏è Supprimer';
  }
};

/* =============================
   TEST MEDIA
============================= */
btnTestMedia.onclick = ()=>{
  if(!current) return;
  hideNote(editNote);

  const payload = collectForm();
  pvImg.src = (payload.photo_url && payload.photo_url.startsWith("http")) ? payload.photo_url : FALLBACK_PHOTO;

  const embed = toEmbedUrl(payload.video_url);
  if(embed){
    pvVideo.src = embed;
    pvVideoWrap.style.display = "block";
    showNote(editNote, "‚úÖ M√©dias OK!", "ok");
  }else{
    pvVideo.src = "";
    pvVideoWrap.style.display = "none";
    if(payload.video_url){
      showNote(editNote, "‚ö†Ô∏è Vid√©o non reconnue. Mets un lien Drive/YouTube/Vimeo valide.", "warn");
    }else{
      showNote(editNote, "‚ÑπÔ∏è Pas de vid√©o. Photo OK.", "ok");
    }
  }

  const wn = payload.wave_name.trim();
  const wp = payload.wave_phone.trim();
  pvWave.textContent = (wn ? wn + " ‚Ä¢ " : "") + (wp || "‚Äî");
  pvVille.textContent = payload.ville || "‚Äî";
  pvStatus.textContent = payload.status || "‚Äî";
};

btnOpenPublic.onclick = ()=>{
  if(!current || !current.id) return showNote(editNote, "‚ùå Sauvegarde d'abord (pas d'ID).", "bad");
  window.open("loc.html?id=" + encodeURIComponent(current.id), "_blank");
};

/* =============================
   DUPLICATE
============================= */
async function duplicateOne(id){
  hideNote(listNote);
  if(!sessionUser) return showNote(listNote, "‚ùå Connecte-toi d'abord.", "bad");

  const { data: src, error: e1 } = await SB
    .from("digiy_logements")
    .select("*")
    .eq("id", id)
    .eq("owner_id", sessionUser.id)
    .single();

  if(e1 || !src){
    console.error(e1);
    return showNote(listNote, "‚ùå Duplication impossible:\n" + (e1?.message || "introuvable"), "bad");
  }

  const copy = {
    owner_id: sessionUser.id,
    nom: (src.nom || "Logement") + " (copie)",
    ville: src.ville || "",
    business_code: generateBusinessCode((src.nom || "Logement") + " copie", src.ville || ""),
    adresse: src.adresse || "",
    description: src.description || "",
    photo_url: src.photo_url || "",
    video_url: src.video_url || "",
    prix_nuit: Number(src.prix_nuit || 0),
    prix_semaine: Number(src.prix_semaine || 0),
    prix_mois: Number(src.prix_mois || 0),
    frais_supplements: src.frais_supplements || "",
    wave_phone: src.wave_phone || "",
    wave_name: src.wave_name || "",
    wave_pay_link: src.wave_pay_link || "",
    deposit_percent: Number(src.deposit_percent || 30),
    status: "brouillon"
  };

  const { data: created, error: e2 } = await SB
    .from("digiy_logements")
    .insert(copy)
    .select("id")
    .single();

  if(e2 || !created){
    console.error(e2);
    return showNote(listNote, "‚ùå Duplication refus√©e:\n" + (e2?.message || ""), "bad");
  }

  showNote(listNote, `‚úÖ Dupliqu√©! Nouveau logement: ${created.id}`, "ok");
  await loadList();
  await openOne(created.id);
  showNote(editNote, "‚ú® Copie pr√™te. Renomme + ajuste puis Publier.", "ok");
}

/* =============================
   CALENDRIER
============================= */
btnAddBlock.onclick = async ()=>{
  hideNote(calNote);
  if(!sessionUser) return showNote(calNote, "‚ùå Connecte-toi.", "bad");
  if(!current || !current.id) return showNote(calNote, "‚ùå Sauvegarde le logement avant.", "bad");

  const s = calStart.value;
  const e = calEnd.value;
  if(!s || !e) return showNote(calNote, "‚ùå Choisis d√©but + fin.", "bad");
  if(e < s) return showNote(calNote, "‚ùå Fin doit √™tre >= d√©but.", "bad");

  btnAddBlock.disabled = true;
  btnAddBlock.innerHTML = '<span class="spinner"></span> Ajout...';

  try{
    const insertPayload = {
      listing_id: current.id,
      owner_id: sessionUser.id,
      start_date: s,
      end_date: e,
      reason: calReason.value.trim() || null,
      business_code: current.business_code || null
    };

    const { error } = await SB.from("loc_availability_blocks").insert(insertPayload);
    if(error) throw error;

    showNote(calNote, "‚úÖ P√©riode bloqu√©e!", "ok");
    calStart.value = "";
    calEnd.value = "";
    calReason.value = "";
    await loadBlocksForCurrent();
  }catch(err){
    console.error(err);
    showNote(calNote, "‚ùå Blocage refus√©:\n" + (err?.message || err), "bad");
  }finally{
    btnAddBlock.disabled = false;
    btnAddBlock.innerHTML = '‚ûï Bloquer p√©riode';
  }
};

btnReloadBlocks.onclick = async ()=>{ await loadBlocksForCurrent(); };

async function loadBlocksForCurrent(){
  hideNote(calNote);
  calList.innerHTML = "";
  if(!current || !current.id) return;

  try{
    const { data, error } = await SB
      .from("loc_availability_blocks")
      .select("id,start_date,end_date,reason,created_at")
      .eq("listing_id", current.id)
      .eq("owner_id", sessionUser.id)
      .order("start_date", { ascending:true });

    if(error) throw error;

    if(!data || data.length===0){
      return showNote(calNote, "‚ÑπÔ∏è Aucun bloc. Logement disponible par d√©faut.", "ok");
    }

    data.forEach(b=>{
      const div = document.createElement("div");
      div.className = "rowItem";
      div.innerHTML = `
        <div class="rowTop">
          <strong>üö´ ${b.start_date} ‚Üí ${b.end_date}</strong>
          <button class="btn danger small" data-delblk="${b.id}">Supprimer</button>
        </div>
        <div class="rowSub">${b.reason || "‚Äî"}</div>
      `;
      calList.appendChild(div);
    });

    calList.querySelectorAll("[data-delblk]").forEach(btn=>{
      btn.onclick = async ()=>{
        const bid = btn.getAttribute("data-delblk");
        if(!confirm("Supprimer ce bloc de dates ?")) return;

        try{
          const { error } = await SB
            .from("loc_availability_blocks")
            .delete()
            .eq("id", bid)
            .eq("owner_id", sessionUser.id);

          if(error) throw error;
          showNote(calNote, "‚úÖ Bloc supprim√©!", "ok");
          await loadBlocksForCurrent();
        }catch(e){
          console.error(e);
          showNote(calNote, "‚ùå Suppression refus√©e:\n" + (e?.message || e), "bad");
        }
      };
    });

    showNote(calNote, `‚úÖ ${data.length} bloc(s) charg√©(s).`, "ok");
  }catch(e){
    console.error(e);
    showNote(calNote, "‚ùå Erreur calendrier:\n" + (e?.message || e), "bad");
  }
}

/* =============================
   ACOMPTES
============================= */
btnReloadPays.onclick = async ()=>{ await loadPaymentsForCurrent(); };

async function loadPaymentsForCurrent(){
  hideNote(payAdminNote);
  payList.innerHTML = "";
  if(!current || !current.id) return;

  try{
    const { data, error } = await SB
      .from("loc_payment_intents")
      .select("*")
      .eq("listing_id", current.id)
      .order("created_at", { ascending:false })
      .limit(50);

    if(error) throw error;

    if(!data || data.length===0){
      return showNote(payAdminNote, "‚ÑπÔ∏è Aucune preuve d'acompte.", "ok");
    }

    data.forEach(p=>{
      const div = document.createElement("div");
      div.className = "rowItem";
      const who = (p.client_name || "Client") + (p.client_phone ? " ‚Ä¢ " + p.client_phone : "");
      const when = (p.date_in && p.date_out) ? `${p.date_in} ‚Üí ${p.date_out} (${p.nights||0} nuit(s))` : "‚Äî";
      const amt = `${Number(p.amount_expected||0).toLocaleString("fr-FR")} ${p.currency||"XOF"}`;
      const st = (p.status || "pending").toUpperCase();

      div.innerHTML = `
        <div class="rowTop">
          <strong>${st} ‚Ä¢ ${amt}</strong>
          <div class="btnRow">
            <button class="btn primary small" data-okpay="${p.id}">‚úÖ Confirmer</button>
            <button class="btn danger small" data-badpay="${p.id}">‚ùå Rejeter</button>
          </div>
        </div>
        <div class="rowSub">
          üë§ ${who}<br>
          üìÖ ${when}<br>
          üí≥ Wave: ${p.wave_name || ""} ${p.wave_phone || ""}<br>
          üßæ Ref: <strong>${p.wave_tx_ref || "‚Äî"}</strong>
        </div>
      `;
      payList.appendChild(div);
    });

    payList.querySelectorAll("[data-okpay]").forEach(btn=>{
      btn.onclick = ()=> updatePayStatus(btn.getAttribute("data-okpay"), "confirmed");
    });
    payList.querySelectorAll("[data-badpay]").forEach(btn=>{
      btn.onclick = ()=> updatePayStatus(btn.getAttribute("data-badpay"), "rejected");
    });

    showNote(payAdminNote, `‚úÖ ${data.length} acompte(s) affich√©(s).`, "ok");
  }catch(e){
    console.error(e);
    showNote(payAdminNote,
      "‚ö†Ô∏è Paiements indisponibles (table manquante ?).\nErreur: " + (e?.message || e),
      "warn"
    );
  }
}

async function updatePayStatus(id, status){
  hideNote(payAdminNote);

  try{
    const { error } = await SB
      .from("loc_payment_intents")
      .update({ status })
      .eq("id", id);

    if(error) throw error;

    showNote(payAdminNote, `‚úÖ Statut mis √† jour: ${status}`, "ok");
    await loadPaymentsForCurrent();
  }catch(e){
    console.error(e);
    showNote(payAdminNote, "‚ùå Update refus√©:\n" + (e?.message || e), "bad");
  }
}

/* =============================
   AUTH LISTENER
============================= */
SB.auth.onAuthStateChange((_event, session)=>{
  setConnectedUI(session?.user || null);
  if(session?.user){
    loadList();
  }else{
    current = null;
    paintEditor(null);
  }
});

/* =============================
   INIT
============================= */
refreshSession();
paintEditor(null);
</script>
</body>
</html>
