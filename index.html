<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>DIGIY LOC PRO ‚ôæÔ∏è ‚Äî Cockpit Propri√©taire</title>
<meta name="theme-color" content="#0b1020" />

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="./guard.js?v=locpro-final"></script>

<style>
:root{
  --bg:#020617;
  --bg2:#0b1020;
  --card:rgba(255,255,255,.03);
  --line:#1f2937;
  --ink:#f9fafb;
  --muted:#cbd5f5;
  --gold:#facc15;
  --green:#22c55e;
  --danger:#ef4444;
  --shadow:0 22px 50px rgba(0,0,0,.55);
  --soft:rgba(255,255,255,.04);
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  min-height:100vh;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  color:var(--ink);
  background:
    radial-gradient(900px 520px at 12% -10%, rgba(250,204,21,.16), transparent 60%),
    radial-gradient(900px 520px at 90% 0%, rgba(34,197,94,.12), transparent 60%),
    linear-gradient(180deg, var(--bg2), var(--bg));
}
a{color:inherit}
.wrap{max-width:1100px;margin:0 auto;padding:14px}

.top{
  display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
  padding:10px 12px;border:1px solid var(--line);border-radius:18px;background:var(--card);
  box-shadow:var(--shadow);
}
.brand{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.logo{
  width:40px;height:40px;border-radius:14px;
  background:linear-gradient(135deg, rgba(250,204,21,.35), rgba(34,197,94,.2));
  border:1px solid rgba(250,204,21,.35);
  box-shadow:0 0 22px rgba(250,204,21,.12);
}
.brand h1{margin:0;font-size:1.05rem;letter-spacing:.2px}
.brand .infinity{font-size:1.5rem;font-weight:900;margin-left:4px}
.brand .sub{color:var(--muted);font-weight:800;font-size:.92rem;margin-top:2px}

.pills{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.pill{
  border:1px solid rgba(148,163,184,.35);
  padding:7px 10px;border-radius:999px;background:rgba(255,255,255,.02);
  color:var(--muted);font-weight:900;font-size:.86rem;
}
.pill strong{color:#fff}
.pill.ok{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.10);color:#bbf7d0}
.pill.warn{border-color:rgba(250,204,21,.35);background:rgba(250,204,21,.10);color:#fde68a}

.btn{
  border:0; cursor:pointer;
  border-radius:14px;
  padding:11px 12px;
  font-weight:1000;
  background:rgba(255,255,255,.03);
  border:1px solid var(--line);
  color:var(--muted);
  transition:all 0.18s ease;
  text-decoration:none;
  display:inline-flex;align-items:center;justify-content:center;
  gap:8px;
  user-select:none;
  -webkit-tap-highlight-color:transparent;
}
.btn:hover:not(:disabled){filter:brightness(1.08);transform:translateY(-1px)}
.btn:active:not(:disabled){transform:translateY(0)}
.btn:disabled{opacity:0.5;cursor:not-allowed}
.btn.primary{background:rgba(34,197,94,.16);border-color:rgba(34,197,94,.35);color:#bbf7d0}
.btn.gold{background:rgba(250,204,21,.14);border-color:rgba(250,204,21,.35);color:#fde68a}
.btn.danger{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.35);color:#fecaca}
.btn.ghost{background:rgba(255,255,255,.02)}
.btn.small{padding:9px 10px;border-radius:12px;min-height:44px}

.navRow{
  width:100%;
  display:flex;gap:10px;flex-wrap:wrap;
  align-items:center;justify-content:space-between;
  margin-top:10px;
}
.navLeft,.navRight{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.navLabel{
  color:var(--muted);
  font-weight:900;
  font-size:.86rem;
  padding:7px 10px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,.25);
  background:rgba(255,255,255,.02);
}

.grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:14px}
@media (max-width: 980px){ .grid{grid-template-columns:1fr} }

.card{
  border:1px solid var(--line);
  background:rgba(255,255,255,.03);
  border-radius:20px;
  box-shadow:var(--shadow);
  overflow:hidden;
}
.cardHead{
  padding:12px 14px;
  border-bottom:1px solid var(--line);
  display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
  background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.01));
}
.cardHead h2{margin:0;font-size:1.02rem}
.cardHead small{color:var(--muted);font-weight:800}
.cardBody{padding:14px}

.note{
  margin-top:10px;
  padding:10px 12px;border-radius:14px;
  border:1px solid rgba(148,163,184,.25);
  background:rgba(255,255,255,.03);
  color:var(--muted);
  white-space:pre-wrap;
  display:none;
}
.note.ok{border-color:rgba(34,197,94,.35);color:#bbf7d0;background:rgba(34,197,94,.09)}
.note.bad{border-color:rgba(239,68,68,.35);color:#fecaca;background:rgba(239,68,68,.09)}
.note.warn{border-color:rgba(250,204,21,.35);color:#fde68a;background:rgba(250,204,21,.09)}

.kv{display:grid;grid-template-columns:160px 1fr;gap:8px;margin-top:10px}
.kv div{padding:8px 10px;border:1px solid rgba(148,163,184,.18);border-radius:12px;background:rgba(255,255,255,.02)}
.kv .k{color:var(--muted);font-weight:900}
.kv .v{font-weight:1000;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

hr.sep{
  border:0;height:1px;background:rgba(148,163,184,.18);
  margin:14px 0;
}

.list{
  display:flex;flex-direction:column;gap:10px;margin-top:10px;
}
.item{
  border:1px solid rgba(148,163,184,.18);
  background:rgba(255,255,255,.02);
  border-radius:16px;
  padding:10px 12px;
}
.itemTop{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center}
.badge{
  padding:6px 10px;border-radius:999px;
  border:1px solid rgba(148,163,184,.25);
  background:rgba(255,255,255,.02);
  color:var(--muted);
  font-weight:1000;
  font-size:.85rem;
}
.badge.ok{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.10);color:#bbf7d0}
.badge.gold{border-color:rgba(250,204,21,.35);background:rgba(250,204,21,.10);color:#fde68a}
.small{font-size:.92rem;color:var(--muted);font-weight:850;line-height:1.45}

@media (max-width: 720px){
  .wrap{padding:12px}
  .btn{width:100%}
  .navRight .btn{width:100%}
  .kv{grid-template-columns:1fr}
}
</style>
</head>

<body>
<div class="wrap">

  <div class="top">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>DIGIY LOC PRO <span class="infinity">‚àû</span></h1>
        <div class="sub">Cockpit propri√©taire ‚Ä¢ s√©curis√© ‚Ä¢ 0% commission ‚Ä¢ paiement direct</div>
      </div>
    </div>

    <div class="pills">
      <div class="pill" id="pillUser">üë§ <strong>‚Äî</strong></div>
      <div class="pill warn" id="pillState">üîí D√©connect√©</div>
      <button class="btn danger small" id="btnLogout" style="display:none">üö™ D√©connexion</button>
    </div>

    <div class="navRow">
      <div class="navLeft">
        <a class="btn ghost small" id="btnBack" href="#">‚¨ÖÔ∏è Retour</a>
        <div class="navLabel" id="navPlace">Lieu : ‚Äî</div>
      </div>
      <div class="navRight">
        <a class="btn small" id="goToday" href="#">üìÖ Vue du jour</a>
        <button class="btn small" id="goApp" type="button">üè† APP</button>
        <a class="btn small" id="goPulse" href="#">üì≤ Pulse</a>
        <a class="btn small" id="goPlanning" href="#">üóìÔ∏è Planning</a>
        <a class="btn small" id="goListing" href="#">üìã Liste du jour</a>
        <a class="btn small" id="goLinks" href="#">üîó Liens / QR</a>
        <a class="btn small" id="goHealth" href="#">üß™ V√©rifier mon acc√®s</a>
      </div>
    </div>
  </div>

  <div class="grid">
    <!-- CARD 1 -->
    <section class="card">
      <div class="cardHead">
        <div>
          <h2>‚ö° Vue rapide</h2>
          <small>Ton acc√®s + tes infos en 10 secondes.</small>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
          <button class="btn" id="btnCopyPublic" type="button">üìã Copier GO PIN</button>
          <button class="btn" id="btnRefresh" type="button">‚Üª Recharger</button>
        </div>
      </div>
      <div class="cardBody">
        <div class="kv">
          <div class="k">Lieu</div><div class="v" id="kvSlug">‚Äî</div>
          <div class="k">T√©l√©phone</div><div class="v" id="kvPhone">‚Äî</div>
          <div class="k">Owner ID</div><div class="v" id="kvOwner">‚Äî</div>
          <div class="k">Session</div><div class="v" id="kvSess">‚Äî</div>
        </div>

        <div class="note" id="noteMain"></div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
          <a class="btn gold" id="btnPublic" href="#" target="_blank" rel="noopener">üëÅÔ∏è GO PIN public</a>
          <a class="btn" id="btnOpenPin" href="#">üîë Ouvrir l‚Äôacc√®s (PIN)</a>
        </div>

        <hr class="sep">

        <div class="small">
          Astuce terrain : envoie ton <b>GO PIN public</b> au client. Il voit la fiche + WhatsApp direct.
        </div>
      </div>
    </section>

    <!-- CARD 2 -->
    <section class="card">
      <div class="cardHead">
        <div>
          <h2>üéØ Actions rapides</h2>
          <small>Ce que tu fais le plus souvent.</small>
        </div>
      </div>
      <div class="cardBody">
        <div style="display:grid;grid-template-columns:1fr;gap:10px">
          <a class="btn primary" id="quickApp" href="#">üè† Ajouter / modifier mes logements</a>
          <a class="btn" id="quickPlanning" href="#">üóìÔ∏è Voir mon planning</a>
          <a class="btn" id="quickLinks" href="#">üîó Partager mes liens / QR</a>
          <a class="btn" id="quickHealth" href="#">üß™ Diagnostic (si √ßa coince)</a>
          <a class="btn gold" id="quickNdimbal" href="#">üåô NDIMBAL LOC ‚Äî Mon bureau de poche</a>
        </div>
      </div>
    </section>

    <!-- CARD 3 -->
    <section class="card">
      <div class="cardHead">
        <div>
          <h2>üí≥ Paiements Wave</h2>
          <small>Registre des paiements d√©clar√©s (terrain).</small>
        </div>
        <span class="badge gold" id="waveTotal">Total: ‚Äî</span>
      </div>
      <div class="cardBody">
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn gold" id="btnDeclareWave" type="button">üí≥ D√©clarer un paiement re√ßu</button>
          <button class="btn" id="btnReloadWave" type="button">‚Üª Recharger paiements</button>
        </div>

        <div class="note warn" id="noteWave" style="margin-top:12px"></div>

        <div class="list" id="waveList"></div>
        <div class="small" style="margin-top:10px">
          Conseil : si le client paie, tu d√©clares ici. Plus tard on ajoutera preuve (capture) + stats mensuelles.
        </div>
      </div>
    </section>

    <!-- CARD 4 -->
    <section class="card">
      <div class="cardHead">
        <div>
          <h2>üß≠ Aide</h2>
          <small>Si un bouton coince, on te r√©pond vite.</small>
        </div>
      </div>
      <div class="cardBody">
        <div class="small">
          Tu peux contacter l‚Äô√©quipe DIGIY depuis n‚Äôimporte quel √©cran.
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
          <a class="btn primary" id="btnTeam" href="#" target="_blank" rel="noopener">üì≤ Contacter DIGIY</a>
          <a class="btn" href="./health-loc.html" id="btnDiag">üß™ Diagnostic</a>
        </div>
      </div>
    </section>

  </div>

</div>

<script>
(function(){
  "use strict";

  // Boot guard (slug obligatoire)
  window.DIGIY_GUARD?.boot({
    module: "loc",
    login: "./pin.html",
    dashboard: "./index.html",
    requireSlug: true
  });

  const $ = (id)=>document.getElementById(id);

  function showNote(id, msg, type){
    const el = $(id);
    if(!el) return;
    el.style.display = "block";
    el.classList.remove("ok","bad","warn");
    if(type) el.classList.add(type);
    el.textContent = msg || "";
  }
  function hideNote(id){
    const el = $(id);
    if(!el) return;
    el.style.display = "none";
    el.textContent = "";
    el.classList.remove("ok","bad","warn");
  }

  function digits(p){ return String(p||"").replace(/\D/g,""); }
  function openWa(phone, msg){
    const d = digits(phone);
    if(!d) return "#";
    return "https://wa.me/" + d + (msg ? ("?text=" + encodeURIComponent(msg)) : "");
  }

  const TEAM_WA = "+221771342889";
  const slug = (window.DIGIY_GUARD?.getSlug?.() || "").trim();

  if($("navPlace")) $("navPlace").textContent = "Lieu : " + (slug || "‚Äî");
  if($("kvSlug")) $("kvSlug").textContent = slug || "‚Äî";

  function withSlug(path){
    return window.DIGIY_GUARD?.withSlug ? window.DIGIY_GUARD.withSlug(path) : path;
  }

  // ‚úÖ HREF uniquement sur les <a> + safe (si id absent => ignore)
  const links = [
    ["btnBack","./index.html"],
    ["goToday","./today.html"],
    ["goPulse","./proprio-loc.html"],
    ["goPlanning","./planning.html"],
    ["goListing","./listing.html"],
    ["goLinks","./manage-links.html"],
    ["goHealth","./health-loc.html"],
    ["quickApp","./app.html"],
    ["quickPlanning","./planning.html"],
    ["quickLinks","./manage-links.html"],
    ["quickHealth","./health-loc.html"],
    ["btnOpenPin","./pin.html"],
    ["quickNdimbal","./ndimbal.html"],
    ["btnDiag","./health-loc.html"]
  ];

  links.forEach(([id, path])=>{
    const el = document.getElementById(id);
    if(!el) return;
    if(el.tagName !== "A") return;
    el.href = withSlug(path);
  });

  // ‚úÖ GO PIN public (ouvre une page publique)
  const pub = new URL("./go-pin.html", location.href);
  if(slug) pub.searchParams.set("slug", slug);
  if($("btnPublic")) $("btnPublic").href = pub.toString();

  // Copier GO PIN
  $("btnCopyPublic")?.addEventListener("click", async ()=>{
    try{
      const txt = pub.toString();
      await navigator.clipboard.writeText(txt);
      showNote("noteMain", "‚úÖ Lien GO PIN copi√©. Colle-le sur WhatsApp.", "ok");
      setTimeout(()=>hideNote("noteMain"), 2200);
    }catch(e){
      showNote("noteMain", "‚ö†Ô∏è Copie impossible sur ce navigateur. Lien : " + pub.toString(), "warn");
    }
  });

  // ‚úÖ APP (bouton) : navigation propre avec slug
  document.getElementById("goApp")?.addEventListener("click", (e)=>{
    e.preventDefault();
    window.location.href = withSlug("./app.html");
  });

  // Team WA
  if($("btnTeam")){
    $("btnTeam").href = openWa(TEAM_WA, slug
      ? `Bonjour DIGIY üëã\nJe suis sur mon cockpit (${slug}) et j‚Äôai besoin d‚Äôaide.`
      : `Bonjour DIGIY üëã\nJe suis sur mon cockpit et le slug est manquant.`);
  }

  function refresh(){
    hideNote("noteMain");

    const sess = window.DIGIY_GUARD?.getSession?.();
    const phone = sess?.phone || "‚Äî";
    const owner = sess?.owner_id || "‚Äî";
    const exp = sess?.exp ? new Date(Number(sess.exp)).toISOString().slice(0,16).replace("T"," ") : "";

    if($("kvPhone")) $("kvPhone").textContent = phone;
    if($("kvOwner")) $("kvOwner").textContent = owner;
    if($("kvSess")) $("kvSess").textContent = sess?.ok ? ("OK" + (exp ? " (expire : " + exp + ")" : "")) : "‚Äî";

    if(sess?.ok && sess?.phone){
      if($("pillUser")) $("pillUser").innerHTML = `üë§ <strong>${phone}</strong>`;
      if($("pillState")){
        $("pillState").textContent = "‚úÖ Connect√©";
        $("pillState").classList.remove("warn");
        $("pillState").classList.add("ok");
      }
      if($("btnLogout")) $("btnLogout").style.display = "inline-flex";

      if(!sess?.owner_id){
        showNote(
          "noteMain",
          "‚ö†Ô∏è Acc√®s OK, mais ton identifiant propri√©taire n‚Äôest pas charg√©.\n" +
          "‚û°Ô∏è D√©connecte-toi puis reconnecte-toi avec ton PIN.\n" +
          "‚úÖ Sinon tu peux continuer.",
          "warn"
        );
      } else {
        showNote("noteMain", "‚úÖ Tout est OK. Tu peux g√©rer tes logements.", "ok");
      }
      return;
    }

    // pas de session
    if($("pillUser")) $("pillUser").innerHTML = `üë§ <strong>‚Äî</strong>`;
    if($("pillState")){
      $("pillState").textContent = "üîí D√©connect√©";
      $("pillState").classList.remove("ok");
      $("pillState").classList.add("warn");
    }
    if($("btnLogout")) $("btnLogout").style.display = "none";

    if(!slug){
      showNote("noteMain", "‚ö†Ô∏è Lien incomplet.\n‚û°Ô∏è Ouvre le cockpit depuis le QR / GO PIN.", "bad");
    } else {
      showNote("noteMain", "üîí Acc√®s non ouvert.\n‚û°Ô∏è Mets ton t√©l√©phone + PIN pour entrer.", "warn");
    }
  }

  document.getElementById("btnRefresh")?.addEventListener("click", refresh);

  document.getElementById("btnLogout")?.addEventListener("click", ()=>{
    const url = withSlug("./pin.html");
    window.DIGIY_GUARD?.logout?.(url);
  });

  /* =========================
     WAVE PAYMENTS (PRO)
  ========================= */
  const TABLE_WAVE = "loc_wave_payments";

  function fmtFcfa(n){
    const v = Number(n);
    if(!Number.isFinite(v)) return "‚Äî";
    return v.toLocaleString("fr-FR") + " FCFA";
  }
  function fmtDate(d){
    try{ return new Date(d).toLocaleString("fr-FR"); }catch(e){ return String(d||""); }
  }

  function setWaveTotal(total){
    const el = $("waveTotal");
    if(!el) return;
    el.textContent = "Total: " + (Number.isFinite(total) ? fmtFcfa(total) : "‚Äî");
  }

  async function loadWave(){
    const list = $("waveList");
    if(!list) return;

    hideNote("noteWave");
    list.innerHTML = `<div class="small">‚è≥ Chargement‚Ä¶</div>`;
    setWaveTotal(NaN);

    if(!slug){
      list.innerHTML = `<div class="small">Slug manquant.</div>`;
      return;
    }

    // Supabase client via guard (si expos√©), sinon supabase global
    const sb = window.DIGIY_GUARD?.sb || window.supabase?.createClient?.(); // safe no-op
    // On tente proprement : si DIGIY_GUARD expose client, top. Sinon on cr√©e via creds dans guard.js (souvent d√©j√†).
    // Si rien : on laisse l‚Äôerreur.
    const client = window.DIGIY_GUARD?.getSupabase?.() || window.DIGIY_GUARD?.sb || null;

    // fallback : si ton guard ne fournit pas, on va tenter via variable globale 'supabase' + les creds dedans guard (pas ici).
    // Donc : si pas de client, on affiche un message clair.
    const SBCLIENT = client;
    if(!SBCLIENT){
      list.innerHTML = `<div class="small">‚ö†Ô∏è Supabase client non disponible depuis guard.js. (Optionnel) Tu peux me dire comment tu exposes SB.</div>`;
      showNote("noteWave","‚ö†Ô∏è Impossible de lire les paiements (client Supabase non expos√© c√¥t√© PRO).","warn");
      return;
    }

    try{
      const { data, error } = await SBCLIENT
        .from(TABLE_WAVE)
        .select("id,pin_slug,client_name,client_phone,amount,status,created_at,proof_url")
        .eq("pin_slug", slug)
        .order("created_at", { ascending:false })
        .limit(20);

      if(error) throw error;

      const rows = Array.isArray(data) ? data : [];
      if(!rows.length){
        list.innerHTML = `<div class="small">Aucun paiement d√©clar√© pour ce logement.</div>`;
        setWaveTotal(0);
        return;
      }

      const total = rows.reduce((s,r)=> s + (Number(r.amount)||0), 0);
      setWaveTotal(total);

      list.innerHTML = rows.map(r=>{
        const name = r.client_name || "Client";
        const phone = r.client_phone || "‚Äî";
        const amt = fmtFcfa(r.amount);
        const when = fmtDate(r.created_at);
        const st = (r.status || "declared").toString();
        const badge = st === "verified" ? `<span class="badge ok">V√©rifi√©</span>` : `<span class="badge">D√©clar√©</span>`;
        return `
          <div class="item">
            <div class="itemTop">
              <div style="font-weight:1100">${name}</div>
              ${badge}
            </div>
            <div class="small" style="margin-top:6px">üìû ${phone} ‚Ä¢ üí∞ <b>${amt}</b></div>
            <div class="small" style="margin-top:4px">üïí ${when}</div>
          </div>
        `;
      }).join("");

    }catch(e){
      console.error(e);
      list.innerHTML = `<div class="small">‚ùå Erreur chargement paiements.</div>`;
      showNote("noteWave","‚ùå Impossible de charger les paiements.\nD√©tail: " + (e?.message || e),"bad");
    }
  }

  async function declareWave(){
    hideNote("noteWave");
    if(!slug){
      showNote("noteWave","Slug manquant.","bad");
      return;
    }

    const client = window.DIGIY_GUARD?.getSupabase?.() || window.DIGIY_GUARD?.sb || null;
    if(!client){
      showNote("noteWave","‚ö†Ô∏è Supabase client non disponible depuis guard.js.","warn");
      return;
    }

    const clientName = prompt("Nom du client ? (optionnel)") || "";
    const clientPhone = prompt("T√©l√©phone du client ? (optionnel)") || "";
    const amtRaw = prompt("Montant re√ßu (FCFA) ?") || "";
    const amt = Number(String(amtRaw).replace(/\D/g,""));
    if(!amt || amt <= 0){
      showNote("noteWave","Montant invalide.","warn");
      return;
    }

    try{
      const { error } = await client.from(TABLE_WAVE).insert({
        pin_slug: slug,
        client_name: clientName,
        client_phone: clientPhone,
        amount: amt,
        status: "declared"
      });

      if(error) throw error;
      showNote("noteWave","‚úÖ Paiement enregistr√©. Il appara√Æt dans la liste.","ok");
      await loadWave();
    }catch(e){
      console.error(e);
      showNote("noteWave","‚ùå Impossible d‚Äôenregistrer.\nD√©tail: " + (e?.message || e),"bad");
    }
  }

  $("btnReloadWave")?.addEventListener("click", loadWave);
  $("btnDeclareWave")?.addEventListener("click", declareWave);

  // init
  refresh();
  // Charge Wave apr√®s refresh (si session ok ou non ‚Äî lecture d√©pend RLS)
  setTimeout(loadWave, 200);

})();
</script>
</body>
</html>
