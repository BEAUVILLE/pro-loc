<!DOCTYPE html>
<html lang="fr">
<head>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DIGIY â€” AccÃ¨s PRO</title>
  <style>
    :root{--bg:#022c22;--bg2:#065f46;--card:#052e16;--accent:#facc15;--text:#e5e7eb;--muted:#9ca3af;--danger:#f97373;--ok:#22c55e;--line:rgba(148,163,184,.35);}
    *{box-sizing:border-box;margin:0;padding:0}
    body{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px;font-family:system-ui,-apple-system,Segoe UI,Roboto;color:var(--text);
      background:radial-gradient(circle at top,#16a34a22 0,transparent 55%),linear-gradient(135deg,var(--bg),var(--bg2));}
    .wrap{width:100%;max-width:520px}
    .card{background:linear-gradient(145deg,rgba(5,46,22,.97),rgba(6,95,70,.96));border:1px solid rgba(15,118,110,.45);border-radius:24px;padding:20px 18px;box-shadow:0 24px 60px rgba(0,0,0,.75)}
    .top{display:flex;gap:10px;align-items:center;justify-content:center;margin-bottom:10px}
    .ico{width:46px;height:46px;border-radius:50%;display:grid;place-items:center;background:radial-gradient(circle at 30% 0,#facc15 0,transparent 55%),radial-gradient(circle at bottom,#16a34a66 0,transparent 60%);
      border:1px solid rgba(250,204,21,.7);box-shadow:0 0 25px rgba(250,204,21,.45);font-weight:900;color:#022c22}
    h1{text-align:center;font-size:18px;letter-spacing:.08em;text-transform:uppercase;margin-bottom:6px}
    p{text-align:center;color:var(--muted);font-size:13px;margin-bottom:14px;line-height:1.5}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    .col{flex:1 1 160px}
    label{display:block;color:var(--muted);font-size:12px;margin-bottom:4px}
    input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:rgba(15,23,42,.55);color:var(--text);outline:none}
    input:focus{border-color:rgba(250,204,21,.85)}
    .btn{width:100%;margin-top:8px;padding:11px 14px;border-radius:999px;border:1px solid rgba(250,204,21,.65);background:rgba(0,0,0,.25);color:var(--text);cursor:pointer;font-weight:700;letter-spacing:.08em}
    .btn.primary{background:linear-gradient(135deg,#facc15,#f97316);color:#022c22;border:none}
    .split{display:grid;grid-template-columns:1fr;gap:10px;margin-top:12px}
    .box{border:1px dashed rgba(148,163,184,.35);border-radius:16px;padding:12px;background:rgba(255,255,255,.05)}
    .msg{margin-top:10px;text-align:center;font-size:13px;min-height:18px}
    .err{color:var(--danger)} .ok{color:var(--ok)}
    .tiny{font-size:12px;color:var(--muted);text-align:center;margin-top:10px;line-height:1.5}
    .hint{font-size:12px;color:#fef9c3}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
  <body>
  <!-- FORMULAIRE ACCÃˆS PRO -->
  <input id="phone" type="tel" placeholder="+221771234567" />

  <button id="btnSendOtp">
    Recevoir le code
  </button>

  <input id="otp" type="number" placeholder="Code OTP" />

  <button id="btnVerifyOtp">
    Valider
  </button>

  <div id="msg"></div>
  <div class="wrap">
    <div class="card">
      <div class="top"><div class="ico">ðŸ¦…</div></div>
      <h1>ACCÃˆS PRO DIGIY</h1>
      <p>
        PremiÃ¨re fois : <span class="hint">code OTP</span> (valable <b>10 minutes</b>).<br/>
        Ensuite : <span class="hint">ton code PRO 4 chiffres</span> (par dÃ©faut les 4 derniers du tel).
      </p>

      <div class="split">
        <div class="box">
          <div class="row">
            <div class="col">
              <label>TÃ©lÃ©phone (format international)</label>
              <input id="phone" placeholder="+221771342889" />
            </div>
            <div class="col">
              <label>OTP (4-6 chiffres)</label>
              <input id="otp" placeholder="ex: 4821" inputmode="numeric" />
            </div>
          </div>
          <button class="btn primary" id="btnSendOtp">ðŸ“© Envoyer OTP</button>
          <button class="btn" id="btnVerifyOtp">âœ… Valider OTP</button>
          <div class="tiny">Si rÃ©seau lent : lâ€™OTP reste valable <b>10 minutes</b>.</div>
        </div>

        <div class="box">
          <div class="row">
            <div class="col">
              <label>Code PRO (4 chiffres)</label>
              <input id="pin" placeholder="ex: 2889" inputmode="numeric" maxlength="4" />
            </div>
          </div>
          <button class="btn primary" id="btnPin">ðŸ”“ Ouvrir avec mon code</button>
          <div class="tiny">Astuce : par dÃ©faut = <b>4 derniers chiffres</b> du tÃ©lÃ©phone.</div>
        </div>
      </div>

      <div class="msg" id="msg"></div>
      <div class="tiny">
        âœ… Une fois connectÃ©, DIGIY retient lâ€™appareil.<br/>
        Tu ne dois pas retaper lâ€™OTP tous les jours.
      </div>
    </div>
  </div>

<script>
  const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";
  const HUB_URL = "https://beauville.github.io/mon-espace-digiy/"; // âœ… ton HUB

  const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const $ = (id)=>document.getElementById(id);
  const msg = (t, type="")=>{
    $("msg").className = "msg " + (type==="err"?"err":type==="ok"?"ok":"");
    $("msg").textContent = t || "";
  };

  function getDeviceId(){
    let d = localStorage.getItem("digiy_device_id");
    if(!d){
      d = "dev_" + crypto.randomUUID();
      localStorage.setItem("digiy_device_id", d);
    }
    return d;
  }

  $("btnSendOtp").onclick = async ()=>{
    msg("");
    const phone = $("phone").value.trim();
    if(!phone) return msg("Entre ton numÃ©ro au format +221...", "err");

    try{
      // âš ï¸ nÃ©cessite Supabase Auth Phone OTP configurÃ© (SMS provider)
      const { error } = await client.auth.signInWithOtp({ phone });
      if(error) return msg("Erreur OTP : " + error.message, "err");
      msg("OTP envoyÃ©. Il est valable 10 minutes.", "ok");
    } catch(e){
      msg("Erreur inattendue OTP.", "err");
      console.error(e);
    }
  };

  $("btnVerifyOtp").onclick = async ()=>{
    msg("");
    const phone = $("phone").value.trim();
    const token = $("otp").value.trim();
    if(!phone || !token) return msg("TÃ©lÃ©phone + OTP obligatoires.", "err");

    try{
      const { data, error } = await client.auth.verifyOtp({ phone, token, type: "sms" });
      if(error) return msg("OTP invalide : " + error.message, "err");

      msg("ConnectÃ© âœ… Redirectionâ€¦", "ok");
      window.location.href = HUB_URL;
    } catch(e){
      msg("Erreur inattendue validation OTP.", "err");
      console.error(e);
    }
  };

  $("btnPin").onclick = async ()=>{
    msg("");
    const pin = $("pin").value.trim();
    if(!/^[0-9]{4}$/.test(pin)) return msg("Code PRO = 4 chiffres.", "err");

    try{
      // Il faut Ãªtre dÃ©jÃ  authentifiÃ© (session). Sinon â†’ OTP une fois.
      const { data: u } = await client.auth.getUser();
      if(!u || !u.user){
        return msg("PremiÃ¨re fois : fais lâ€™OTP, puis ensuite le code PRO.", "err");
      }

      const deviceId = getDeviceId();
      const { data: ok, error } = await client.rpc("verify_my_pin", { p_pin: pin, p_device_id: deviceId });
      if(error) return msg("Erreur vÃ©rification PIN : " + error.message, "err");

      if(ok){
        msg("AccÃ¨s autorisÃ© âœ… Redirectionâ€¦", "ok");
        window.location.href = HUB_URL;
      } else {
        msg("Code incorrect. Si tu as un doute : refais OTP puis change ton code.", "err");
      }
    } catch(e){
      msg("Erreur inattendue PIN.", "err");
      console.error(e);
    }
  };
</script>
</body>
</html>
