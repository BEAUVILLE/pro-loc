<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>DIGIY ‚ôæÔ∏è ‚Äî GO PIN ‚Ä¢ Manage Links</title>
  <meta name="theme-color" content="#0b1020"/>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- QR generator (canvas) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <!-- ‚úÖ Guard (si pr√©sent, on r√©utilise SON client Supabase) -->
  <script src="./guard.js?v=locpro-final"></script>

  <style>
    :root{
      --bg:#020617; --bg2:#0b1020; --card:rgba(255,255,255,.03);
      --line:rgba(148,163,184,.20);
      --ink:#f9fafb; --muted:#cbd5f5;
      --gold:#facc15; --green:#22c55e; --red:#ef4444; --orange:#f59e0b;
      --shadow:0 22px 55px rgba(0,0,0,.55);
      --r:18px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      min-height:100vh;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      color:var(--ink);
      background:
        radial-gradient(900px 520px at 12% -10%, rgba(250,204,21,.16), transparent 60%),
        radial-gradient(900px 520px at 90% 0%, rgba(34,197,94,.12), transparent 60%),
        linear-gradient(180deg, var(--bg2), var(--bg));
      padding:16px;
    }
    .wrap{max-width:1100px;margin:0 auto}
    .top{
      border:1px solid var(--line);
      background:var(--card);
      border-radius:22px;
      box-shadow:var(--shadow);
      padding:14px;
      display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
    }
    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:44px;height:44px;border-radius:16px;
      background:linear-gradient(135deg, rgba(250,204,21,.35), rgba(34,197,94,.2));
      border:1px solid rgba(250,204,21,.35);
      box-shadow:0 0 22px rgba(250,204,21,.12);
      display:grid;place-items:center;color:#061b14;font-weight:1100;
    }
    h1{font-size:1.05rem;margin:0}
    .sub{color:var(--muted);font-weight:850;margin-top:4px;line-height:1.35}
    .pill{
      border:1px solid rgba(148,163,184,.35);
      padding:7px 10px;border-radius:999px;background:rgba(255,255,255,.02);
      color:var(--muted);font-weight:900;font-size:.86rem;
      display:flex;gap:8px;align-items:center;white-space:nowrap;
    }
    .dot{width:10px;height:10px;border-radius:99px;background:rgba(148,163,184,.6)}
    .dot.ok{background:rgba(34,197,94,.9)}
    .dot.bad{background:rgba(239,68,68,.9)}
    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media(min-width:980px){
      .grid{grid-template-columns: 420px 1fr}
    }
    .card{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      border-radius:22px;
      box-shadow:var(--shadow);
      padding:14px;
    }
    .card h2{font-size:1rem;margin:0 0 10px;color:#fff}
    label{display:block;margin:10px 0 6px;font-weight:950;color:#fff}
    input,select,textarea{
      width:100%;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:var(--ink);
      padding:10px 12px;
      font-weight:900;
      outline:none;
    }
    input:focus,select:focus,textarea:focus{border-color:var(--gold);box-shadow:0 0 0 3px rgba(250,204,21,.15)}
    textarea{min-height:84px;resize:vertical}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:#fff;
      font-weight:1100;
      border-radius:14px;
      padding:10px 12px;
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      min-height:44px;
    }
    .btn:hover{background:rgba(255,255,255,.07)}
    .btn.primary{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.35)}
    .btn.gold{background:rgba(250,204,21,.10);border-color:rgba(250,204,21,.35)}
    .btn.danger{background:rgba(239,68,68,.10);border-color:rgba(239,68,68,.35)}
    .btn.small{padding:8px 10px;min-height:40px;font-size:.92rem}
    .muted{color:var(--muted);font-weight:850;line-height:1.35}
    .note{
      margin-top:10px;
      padding:10px 12px;border-radius:14px;border:1px solid rgba(148,163,184,.25);
      background:rgba(255,255,255,.03);color:var(--muted);font-weight:900;white-space:pre-wrap;display:none;
    }
    .note.ok{display:block;border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.09);color:#bbf7d0}
    .note.bad{display:block;border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.09);color:#fecaca}
    .note.warn{display:block;border-color:rgba(250,204,21,.35);background:rgba(250,204,21,.09);color:#fde68a}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px;border-bottom:1px solid rgba(148,163,184,.18);text-align:left;vertical-align:top}
    th{color:rgba(203,213,245,.85);font-weight:1000;font-size:.85rem;text-transform:uppercase}
    td{font-weight:850;color:rgba(249,250,251,.95)}
    .tag{
      display:inline-flex;align-items:center;gap:6px;
      border:1px solid rgba(148,163,184,.25);
      padding:6px 10px;border-radius:999px;
      font-weight:1000;font-size:.82rem;color:rgba(203,213,245,.95);
      background:rgba(255,255,255,.02);
    }
    .tag.on{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.08);color:#bbf7d0}
    .tag.off{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.08);color:#fecaca}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-weight:900}
    .qrs{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
      margin-top:10px;
    }
    @media(min-width:720px){
      .qrs{grid-template-columns:1fr 1fr 1fr}
    }
    .qrbox{
      border:1px solid rgba(148,163,184,.22);
      background:rgba(255,255,255,.02);
      border-radius:18px;
      padding:12px;
    }
    .qrtitle{font-weight:1100;margin-bottom:8px}
    .qrpreview{
      display:grid;place-items:center;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(148,163,184,.18);
      border-radius:14px;
      padding:10px;
      min-height:220px;
    }
    .small{font-size:.9rem}
    .sep{height:1px;background:rgba(148,163,184,.16);margin:12px 0}
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div class="brand">
      <div class="logo">‚àû</div>
      <div>
        <h1>DIGIY ‚ôæÔ∏è ‚Äî GO PIN</h1>
        <div class="sub">Manage Links ¬∑ Connexion ¬∑ QR</div>
      </div>
    </div>

    <div class="row">
      <div class="pill" title="Statut Auth Supabase">
        <span class="dot" id="authDot"></span>
        <span id="authTxt">Auth ‚Äî</span>
      </div>
      <div class="pill" title="Slug (lieu)">
        <span>slug:</span>
        <span class="mono" id="slugPill">‚Äî</span>
      </div>
    </div>
  </div>

  <div class="grid">
    <!-- LEFT: AUTH + PINS -->
    <div class="card">
      <h2>Connexion</h2>
      <div class="muted">
        Tu peux te connecter en <b>email + mot de passe</b>, ou demander un <b>Magic Link</b>.<br/>
        ‚ö†Ô∏è Le owner ne voit que ses PINs (RLS).
      </div>

      <label>Email</label>
      <input id="email" type="email" placeholder="pro@digiylyfe.com"/>

      <label>Mot de passe <span class="muted small">(optionnel si magic link)</span></label>
      <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>

      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="btnLogin">Login</button>
        <button class="btn gold" id="btnMagic">Envoyer Magic Link</button>
        <button class="btn danger" id="btnLogout">Logout</button>
      </div>

      <div class="sep"></div>

      <div class="row" style="justify-content:space-between">
        <h2 style="margin:0">PINs</h2>
        <button class="btn small" id="btnRefreshPins">‚Üª Rafra√Æchir PINs</button>
      </div>

      <label>Choisir un PIN / Lieu (slug)</label>
      <select id="pinSelect">
        <option value="">‚Äî choisir ‚Äî</option>
      </select>

      <div class="row" style="margin-top:10px">
        <a class="btn small" id="btnOpenApp" href="#" target="_blank" rel="noopener">üè† Ouvrir APP</a>
        <a class="btn small" id="btnOpenPublic" href="#" target="_blank" rel="noopener">üëÅÔ∏è GO PIN public</a>
        <a class="btn small" id="btnOpenAccess" href="#" target="_blank" rel="noopener">üîë Ouvrir l‚Äôacc√®s (PIN)</a>
      </div>

      <div class="note warn" id="noteAuth"></div>
    </div>

    <!-- RIGHT: LINKS + QR -->
    <div class="card">
      <h2>GO LINKS</h2>
      <div class="muted">Ajoute les boutons ‚ÄúCommander / R√©server / Demander course / etc.‚Äù</div>

      <div class="sep"></div>

      <div id="needPinBlock" class="note warn" style="display:block">
        üëâ Connecte-toi puis choisis un PIN pour g√©rer ses liens.
      </div>

      <div id="linksBlock" style="display:none">
        <div class="row" style="gap:12px">
          <div style="flex:1;min-width:220px">
            <label>Label <span class="muted small">(ex: Commander / R√©server / Voir catalogue)</span></label>
            <input id="linkLabel" placeholder="Commander / R√©server / Voir catalogue"/>
          </div>
          <div style="flex:1;min-width:260px">
            <label>URL</label>
            <input id="linkUrl" placeholder="https://..."/>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div style="width:180px">
            <label>Ordre <span class="muted small">(petit = en haut)</span></label>
            <input id="linkOrder" type="number" value="100" min="0"/>
          </div>
          <div style="width:180px">
            <label>Actif</label>
            <select id="linkActive">
              <option value="true">Oui</option>
              <option value="false">Non</option>
            </select>
          </div>
          <div class="row" style="flex:1;justify-content:flex-end;margin-top:18px">
            <button class="btn primary" id="btnSaveLink">Enregistrer</button>
            <button class="btn" id="btnNewLink">Nouveau</button>
            <button class="btn" id="btnReloadLinks">‚Üª Recharger</button>
          </div>
        </div>

        <div class="note" id="noteLinks"></div>

        <div class="sep"></div>

        <div class="row" style="justify-content:space-between;align-items:center">
          <h2 style="margin:0">Liste des liens</h2>
          <span class="muted small">Stockage: <span class="mono" id="storageMode">‚Äî</span></span>
        </div>

        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>Ordre</th>
                <th>Label</th>
                <th>URL</th>
                <th>Actif</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="linksTable">
              <tr><td colspan="5" class="muted">‚Äî chargement ‚Äî</td></tr>
            </tbody>
          </table>
        </div>

        <div class="sep"></div>

        <h2 style="margin:0">QR (pour app / public / acc√®s)</h2>
        <div class="muted small">slug: <span class="mono" id="qrSlug">‚Äî</span></div>

        <div class="qrs">
          <div class="qrbox">
            <div class="qrtitle">‚¨áÔ∏è QR APP</div>
            <div class="qrpreview"><canvas id="qrApp"></canvas></div>
            <div class="row" style="margin-top:10px">
              <button class="btn small" id="btnDlQrApp">T√©l√©charger</button>
            </div>
          </div>

          <div class="qrbox">
            <div class="qrtitle">‚¨áÔ∏è QR Public</div>
            <div class="qrpreview"><canvas id="qrPublic"></canvas></div>
            <div class="row" style="margin-top:10px">
              <button class="btn small" id="btnDlQrPublic">T√©l√©charger</button>
            </div>
          </div>

          <div class="qrbox">
            <div class="qrtitle">‚¨áÔ∏è QR Acc√®s (PIN)</div>
            <div class="qrpreview"><canvas id="qrAccess"></canvas></div>
            <div class="row" style="margin-top:10px">
              <button class="btn small" id="btnDlQrAccess">T√©l√©charger</button>
            </div>
          </div>
        </div>

        <div class="note ok" id="noteUrls" style="display:block;margin-top:12px"></div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  "use strict";

  // =========================
  // CONFIG
  // =========================
  const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

  // Tables
  const T_PINS = "digiy_admin_pins";      // ‚úÖ confirm√©e
  const T_SETTINGS = "digiy_loc_settings"; // ‚úÖ confirm√©e (k,v)

  // Pages (repo-safe)
  const PAGE_APP = "./app.html";
  const PAGE_PUBLIC = "./go-pin-public.html";
  const PAGE_ACCESS = "./pin.html";

  const $ = (id)=>document.getElementById(id);

  // =========================
  // SINGLE SUPABASE CLIENT (NO DUPLICATE GOTRUE)
  // =========================
  function getSb(){
    // ‚úÖ priorit√© au client du Guard (√©vite "Multiple GoTrueClient instances")
    const gsb = window.DIGIY_GUARD?.getSb?.() || window.DIGIY_GUARD?.sb || null;
    if(gsb) return gsb;

    // fallback: client unique global
    if(window.__DIGIY_SB__) return window.__DIGIY_SB__;
    window.__DIGIY_SB__ = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    return window.__DIGIY_SB__;
  }
  const sb = getSb();

  // =========================
  // UI HELPERS
  // =========================
  function setNote(el, msg, cls){
    el.className = "note " + (cls || "warn");
    el.textContent = msg || "";
    el.style.display = msg ? "block" : "none";
  }
  function setAuthStatus(ok, label){
    const dot = $("authDot");
    const txt = $("authTxt");
    dot.className = "dot " + (ok ? "ok":"bad");
    txt.textContent = label || (ok ? "Auth ‚úÖ" : "Auth ‚ùå");
  }
  function pickSlugFromPinRow(row){
    // On s‚Äôadapte aux noms de colonnes possibles
    return (
      row?.slug ||
      row?.pin_slug ||
      row?.loc_slug ||
      row?.business_slug ||
      row?.place_slug ||
      row?.code ||
      row?.business_code ||
      ""
    );
  }
  function pinLabel(row){
    const slug = pickSlugFromPinRow(row) || "‚Äî";
    const last4 =
      row?.last4 ||
      row?.pin_last4 ||
      row?.phone_last4 ||
      row?.access_pin ||
      row?.pin ||
      row?.code4 ||
      "";
    const phone = row?.phone || row?.owner_phone || "";
    const extra = last4 ? ` ‚Ä¢ ${String(last4)}` : (phone ? ` ‚Ä¢ ${String(phone).slice(-4)}` : "");
    return `${slug}${extra}`;
  }

  function withSlug(url, slug){
    // On garde le style guard si dispo (safe)
    if(window.DIGIY_GUARD?.withSlug) {
      // withSlug lit le slug depuis URL ou session, mais nous on force:
      const u = new URL(url, location.href);
      if(slug) u.searchParams.set("slug", slug);
      return u.toString();
    }
    const u = new URL(url, location.href);
    if(slug) u.searchParams.set("slug", slug);
    return u.toString();
  }

  function currentBase(){
    // base du site (GitHub pages)
    // ex: https://beauville.github.io/digiy-loc-pro/manage-links.html
    // => base dossier: https://beauville.github.io/digiy-loc-pro/
    const u = new URL(location.href);
    u.hash = "";
    u.search = "";
    // retire le dernier segment
    u.pathname = u.pathname.replace(/\/[^\/]*$/, "/");
    return u.toString();
  }

  // =========================
  // STATE
  // =========================
  const State = {
    pins: [],
    slug: "",
    links: [],
    editingId: null,
    storage: "settings", // pour l‚Äôinstant: digiy_loc_settings (k,v)
  };

  // =========================
  // AUTH
  // =========================
  async function refreshAuth(){
    try{
      const { data, error } = await sb.auth.getSession();
      if(error) throw error;
      const sess = data?.session || null;
      if(sess?.user){
        setAuthStatus(true, "Auth ‚úÖ " + (sess.user.email || ""));
        return sess.user;
      }
      setAuthStatus(false, "Auth ‚ùå");
      return null;
    }catch(e){
      setAuthStatus(false, "Auth ‚ùå");
      return null;
    }
  }

  async function loginPassword(){
    const email = ($("email").value || "").trim();
    const password = ($("password").value || "").trim();
    if(!email || !password){
      setNote($("noteAuth"), "‚ö†Ô∏è Mets email + mot de passe (ou utilise Magic Link).", "warn");
      return;
    }
    setNote($("noteAuth"), "‚è≥ Connexion‚Ä¶", "warn");
    const { error } = await sb.auth.signInWithPassword({ email, password });
    if(error){
      setNote($("noteAuth"), "‚ùå " + error.message, "bad");
      await refreshAuth();
      return;
    }
    setNote($("noteAuth"), "‚úÖ Connect√©.", "ok");
    await refreshAuth();
    await loadPins();
  }

  async function sendMagic(){
    const email = ($("email").value || "").trim();
    if(!email){
      setNote($("noteAuth"), "‚ö†Ô∏è Mets ton email.", "warn");
      return;
    }
    // Magic link => revenir ICI (avec slug si pr√©sent)
    const redirectTo = location.href;

    setNote($("noteAuth"), "üì© Envoi du Magic Link‚Ä¶ Ouvre ton email, clique, puis reviens ici.", "warn");
    const { error } = await sb.auth.signInWithOtp({
      email,
      options: { emailRedirectTo: redirectTo }
    });
    if(error){
      setNote($("noteAuth"), "‚ùå " + error.message, "bad");
      return;
    }
    setNote($("noteAuth"), "‚úÖ Magic Link envoy√©. Clique dans l‚Äôemail puis tu reviens ici automatiquement.", "ok");
  }

  async function logout(){
    await sb.auth.signOut().catch(()=>{});
    setNote($("noteAuth"), "‚úÖ D√©connect√©.", "ok");
    await refreshAuth();
    State.pins = [];
    renderPins();
    setSelectedSlug("");
  }

  // =========================
  // PINS
  // =========================
  async function loadPins(){
    const user = await refreshAuth();
    if(!user){
      setNote($("noteAuth"),
        "‚ö†Ô∏è Aucun PIN. V√©rifie que tu es bien connect√© (Magic Link).\n‚ö†Ô∏è Le owner ne voit que ses PINs (RLS). Si tu vois ‚Äú‚Äî aucun PIN ‚Äî‚Äù, fais un Magic Link puis ‚ÄúRafra√Æchir‚Äù.",
        "warn"
      );
      State.pins = [];
      renderPins();
      setSelectedSlug("");
      return;
    }

    setNote($("noteAuth"), "‚è≥ Chargement des PINs‚Ä¶", "warn");

    const { data, error } = await sb.from(T_PINS).select("*").order("created_at", { ascending:false }).limit(200);
    if(error){
      setNote($("noteAuth"), "‚ùå Erreur PINs: " + error.message, "bad");
      State.pins = [];
      renderPins();
      setSelectedSlug("");
      return;
    }

    State.pins = Array.isArray(data) ? data : [];
    renderPins();

    if(!State.pins.length){
      setNote($("noteAuth"),
        "‚ö†Ô∏è Aucun PIN visible.\n‚û°Ô∏è Assure-toi d‚Äô√™tre connect√© avec le bon email (RLS).",
        "warn"
      );
      setSelectedSlug("");
      return;
    }

    setNote($("noteAuth"), "‚úÖ PINs charg√©s (" + State.pins.length + "). Choisis un PIN.", "ok");
  }

  function renderPins(){
    const sel = $("pinSelect");
    const keep = sel.value;
    sel.innerHTML = `<option value="">‚Äî choisir ‚Äî</option>`;

    State.pins.forEach((row, idx)=>{
      const slug = pickSlugFromPinRow(row);
      if(!slug) return;
      const opt = document.createElement("option");
      opt.value = slug;
      opt.textContent = pinLabel(row);
      sel.appendChild(opt);
    });

    // restaure si possible
    if(keep && Array.from(sel.options).some(o=>o.value===keep)){
      sel.value = keep;
    }
  }

  function setSelectedSlug(slug){
    State.slug = (slug || "").trim();
    $("slugPill").textContent = State.slug || "‚Äî";
    $("qrSlug").textContent = State.slug || "‚Äî";

    // update action links
    const appUrl = State.slug ? withSlug(PAGE_APP, State.slug) : "#";
    const pubUrl = State.slug ? withSlug(PAGE_PUBLIC, State.slug) : "#";
    const accUrl = State.slug ? withSlug(PAGE_ACCESS, State.slug) : "#";

    $("btnOpenApp").href = appUrl;
    $("btnOpenPublic").href = pubUrl;
    $("btnOpenAccess").href = accUrl;

    // show/hide blocks
    const has = !!State.slug;
    $("needPinBlock").style.display = has ? "none" : "block";
    $("linksBlock").style.display = has ? "block" : "none";

    if(has){
      // build QR + load links
      renderAllQrs();
      loadLinks().catch(()=>{});
    }else{
      // clear QRs + table
      $("linksTable").innerHTML = `<tr><td colspan="5" class="muted">‚Äî aucun lien ‚Äî</td></tr>`;
      setNote($("noteLinks"), "", "warn");
      setNote($("noteUrls"), "Les QR pointent vers :\nAPP\n‚Äî\nPublic\n‚Äî\nAcc√®s\n‚Äî", "ok");
      clearCanvas($("qrApp"));
      clearCanvas($("qrPublic"));
      clearCanvas($("qrAccess"));
    }
  }

  // =========================
  // LINKS STORAGE (digiy_loc_settings)
  // k = "go_links:<slug>"
  // v = JSON string (array)
  // =========================
  function linksKey(slug){
    return `go_links:${slug}`;
  }

  async function loadLinks(){
    if(!State.slug) return;

    $("storageMode").textContent = "digiy_loc_settings (k/v)";
    State.storage = "settings";

    setNote($("noteLinks"), "‚è≥ Chargement des liens‚Ä¶", "warn");

    const key = linksKey(State.slug);
    const { data, error } = await sb.from(T_SETTINGS).select("*").eq("k", key).maybeSingle();
    if(error){
      setNote($("noteLinks"), "‚ùå Erreur chargement: " + error.message, "bad");
      State.links = [];
      renderLinks();
      return;
    }

    let arr = [];
    try{
      const raw = data?.v || "";
      arr = raw ? JSON.parse(raw) : [];
      if(!Array.isArray(arr)) arr = [];
    }catch(_){
      arr = [];
    }

    // normalize
    State.links = arr.map((x, i)=>({
      id: x.id || `l_${Date.now()}_${i}`,
      label: String(x.label || "").trim(),
      url: String(x.url || "").trim(),
      order: Number.isFinite(Number(x.order)) ? Number(x.order) : 100,
      active: (x.active === false) ? false : true
    }));

    setNote($("noteLinks"), "‚úÖ Liens charg√©s (" + State.links.length + ").", "ok");
    renderLinks();
    updateUrlsNote();
  }

  async function saveLinks(){
    if(!State.slug) return;
    const key = linksKey(State.slug);

    // tri
    const payloadArr = [...State.links].sort((a,b)=>Number(a.order)-Number(b.order));

    const { error } = await sb.from(T_SETTINGS).upsert({
      k: key,
      v: JSON.stringify(payloadArr)
    }, { onConflict: "k" });

    if(error) throw error;
  }

  function renderLinks(){
    const tb = $("linksTable");
    const list = [...State.links].sort((a,b)=>Number(a.order)-Number(b.order));

    if(!list.length){
      tb.innerHTML = `<tr><td colspan="5" class="muted">‚Äî aucun lien ‚Äî</td></tr>`;
      return;
    }

    tb.innerHTML = list.map(l=>{
      const tag = l.active
        ? `<span class="tag on">Actif</span>`
        : `<span class="tag off">Off</span>`;

      return `
        <tr>
          <td class="mono">${Number(l.order)}</td>
          <td>${escapeHtml(l.label || "‚Äî")}</td>
          <td><a class="mono" href="${escapeAttr(l.url)}" target="_blank" rel="noopener" style="color:#fde68a;text-decoration:none">${escapeHtml(l.url || "‚Äî")}</a></td>
          <td>${tag}</td>
          <td>
            <div class="row" style="gap:8px">
              <button class="btn small" data-act="edit" data-id="${escapeAttr(l.id)}">‚úèÔ∏è</button>
              <button class="btn small" data-act="toggle" data-id="${escapeAttr(l.id)}">${l.active ? "‚è∏" : "‚ñ∂Ô∏è"}</button>
              <button class="btn small danger" data-act="del" data-id="${escapeAttr(l.id)}">üóëÔ∏è</button>
            </div>
          </td>
        </tr>
      `;
    }).join("");

    // bind actions
    tb.querySelectorAll("button[data-act]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const act = btn.getAttribute("data-act");
        const id = btn.getAttribute("data-id");
        if(act === "edit") return startEdit(id);
        if(act === "toggle") return toggleLink(id);
        if(act === "del") return deleteLink(id);
      });
    });
  }

  function startEdit(id){
    const l = State.links.find(x=>x.id===id);
    if(!l) return;
    State.editingId = id;
    $("linkLabel").value = l.label || "";
    $("linkUrl").value = l.url || "";
    $("linkOrder").value = String(l.order ?? 100);
    $("linkActive").value = String(l.active ? "true" : "false");
    setNote($("noteLinks"), "‚úèÔ∏è √âdition en cours. Modifie puis ‚ÄúEnregistrer‚Äù.", "warn");
  }

  function clearForm(){
    State.editingId = null;
    $("linkLabel").value = "";
    $("linkUrl").value = "";
    $("linkOrder").value = "100";
    $("linkActive").value = "true";
  }

  async function upsertLinkFromForm(){
    if(!State.slug){
      setNote($("noteLinks"), "‚ö†Ô∏è Choisis un PIN (slug) d‚Äôabord.", "warn");
      return;
    }

    const label = ($("linkLabel").value || "").trim();
    const url = ($("linkUrl").value || "").trim();
    const order = Number($("linkOrder").value || 100);
    const active = ($("linkActive").value === "true");

    if(!label || !url){
      setNote($("noteLinks"), "‚ö†Ô∏è Label + URL requis.", "warn");
      return;
    }
    if(!/^https?:\/\//i.test(url)){
      setNote($("noteLinks"), "‚ö†Ô∏è URL doit commencer par http:// ou https://", "warn");
      return;
    }

    setNote($("noteLinks"), "‚è≥ Sauvegarde‚Ä¶", "warn");

    const id = State.editingId || `l_${Date.now()}_${Math.random().toString(16).slice(2)}`;
    const existing = State.links.find(x=>x.id===id);

    if(existing){
      existing.label = label;
      existing.url = url;
      existing.order = Number.isFinite(order) ? order : 100;
      existing.active = active;
    }else{
      State.links.push({ id, label, url, order: Number.isFinite(order) ? order : 100, active });
    }

    try{
      await saveLinks();
      setNote($("noteLinks"), "‚úÖ Enregistr√©.", "ok");
      clearForm();
      renderLinks();
      updateUrlsNote();
    }catch(e){
      console.error(e);
      setNote($("noteLinks"), "‚ùå Sauvegarde impossible: " + (e?.message || e), "bad");
    }
  }

  async function toggleLink(id){
    const l = State.links.find(x=>x.id===id);
    if(!l) return;
    l.active = !l.active;
    try{
      await saveLinks();
      renderLinks();
      updateUrlsNote();
      setNote($("noteLinks"), "‚úÖ OK.", "ok");
    }catch(e){
      l.active = !l.active; // revert
      setNote($("noteLinks"), "‚ùå " + (e?.message || e), "bad");
    }
  }

  async function deleteLink(id){
    if(!confirm("Supprimer ce lien ?")) return;
    const before = State.links.length;
    State.links = State.links.filter(x=>x.id!==id);
    try{
      await saveLinks();
      renderLinks();
      updateUrlsNote();
      setNote($("noteLinks"), "‚úÖ Supprim√©.", "ok");
    }catch(e){
      setNote($("noteLinks"), "‚ùå " + (e?.message || e), "bad");
      // best effort: reload from DB
      await loadLinks().catch(()=>{});
    }
  }

  // =========================
  // QR
  // =========================
  function clearCanvas(canvas){
    if(!canvas) return;
    const ctx = canvas.getContext("2d");
    canvas.width = 1; canvas.height = 1;
    ctx.clearRect(0,0,1,1);
  }

  async function renderQr(canvas, text){
    if(!canvas) return;
    // ensure size stable
    canvas.width = 260;
    canvas.height = 260;
    await QRCode.toCanvas(canvas, text, {
      width: 260,
      margin: 1
    });
  }

  function downloadCanvas(canvas, filename){
    const a = document.createElement("a");
    a.href = canvas.toDataURL("image/png");
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  async function renderAllQrs(){
    if(!State.slug) return;

    // On fabrique les URLs absolues (mieux pour QR)
    const base = currentBase();
    const appUrl = new URL(PAGE_APP, base); appUrl.searchParams.set("slug", State.slug);
    const pubUrl = new URL(PAGE_PUBLIC, base); pubUrl.searchParams.set("slug", State.slug);
    const accUrl = new URL(PAGE_ACCESS, base); accUrl.searchParams.set("slug", State.slug);

    await renderQr($("qrApp"), appUrl.toString());
    await renderQr($("qrPublic"), pubUrl.toString());
    await renderQr($("qrAccess"), accUrl.toString());

    updateUrlsNote();
  }

  function updateUrlsNote(){
    if(!State.slug){
      setNote($("noteUrls"), "Les QR pointent vers :\nAPP\n‚Äî\nPublic\n‚Äî\nAcc√®s\n‚Äî", "ok");
      return;
    }
    const base = currentBase();
    const appUrl = new URL(PAGE_APP, base); appUrl.searchParams.set("slug", State.slug);
    const pubUrl = new URL(PAGE_PUBLIC, base); pubUrl.searchParams.set("slug", State.slug);
    const accUrl = new URL(PAGE_ACCESS, base); accUrl.searchParams.set("slug", State.slug);

    setNote($("noteUrls"),
      "Les QR pointent vers :\nAPP\n" + appUrl.toString()
      + "\n\nPublic\n" + pubUrl.toString()
      + "\n\nAcc√®s\n" + accUrl.toString(),
      "ok"
    );
  }

  // =========================
  // HTML escape
  // =========================
  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, (c)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }
  function escapeAttr(s){
    return String(s||"").replace(/"/g,"&quot;");
  }

  // =========================
  // EVENTS
  // =========================
  $("btnLogin").addEventListener("click", loginPassword);
  $("btnMagic").addEventListener("click", sendMagic);
  $("btnLogout").addEventListener("click", logout);

  $("btnRefreshPins").addEventListener("click", loadPins);

  $("pinSelect").addEventListener("change", ()=>{
    const slug = $("pinSelect").value || "";
    setSelectedSlug(slug);
  });

  $("btnSaveLink").addEventListener("click", upsertLinkFromForm);
  $("btnNewLink").addEventListener("click", ()=>{
    clearForm();
    setNote($("noteLinks"), "üßæ Nouveau lien.", "warn");
  });
  $("btnReloadLinks").addEventListener("click", ()=>{
    if(!State.slug) return;
    loadLinks().catch(()=>{});
  });

  $("btnDlQrApp").addEventListener("click", ()=>{
    if(!State.slug) return alert("Choisis un PIN (slug) d‚Äôabord.");
    downloadCanvas($("qrApp"), `QR_APP_${State.slug}.png`);
  });
  $("btnDlQrPublic").addEventListener("click", ()=>{
    if(!State.slug) return alert("Choisis un PIN (slug) d‚Äôabord.");
    downloadCanvas($("qrPublic"), `QR_PUBLIC_${State.slug}.png`);
  });
  $("btnDlQrAccess").addEventListener("click", ()=>{
    if(!State.slug) return alert("Choisis un PIN (slug) d‚Äôabord.");
    downloadCanvas($("qrAccess"), `QR_ACCES_${State.slug}.png`);
  });

  // Auto refresh when auth changes (magic link return)
  sb.auth.onAuthStateChange(async ()=>{
    await refreshAuth();
    await loadPins().catch(()=>{});
  });

  // =========================
  // BOOT
  // =========================
  (async function boot(){
    await refreshAuth();

    // si slug est pass√© dans l‚ÄôURL, on pr√©-remplit visuellement
    const urlSlug = (()=>{ try{ return new URL(location.href).searchParams.get("slug") || ""; }catch(_){ return ""; }})();
    if(urlSlug){
      $("slugPill").textContent = urlSlug;
      $("qrSlug").textContent = urlSlug;
    }

    // charge pins si d√©j√† logg√©
    await loadPins().catch(()=>{});

    // si URL avait slug et qu‚Äôil est dans la liste, on s√©lectionne
    if(urlSlug){
      const opt = Array.from($("pinSelect").options).find(o=>o.value===urlSlug);
      if(opt){
        $("pinSelect").value = urlSlug;
        setSelectedSlug(urlSlug);
      }
    }else{
      setSelectedSlug("");
    }
  })();
})();
</script>
</body>
</html>
