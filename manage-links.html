<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>DIGIY ‚ôæÔ∏è ‚Äî GO PIN ‚Ä¢ Liens / QR</title>
  <meta name="theme-color" content="#0b1020"/>

  <!-- Supabase + Guard -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./guard.js?v=locpro-final"></script>

  <style>
    :root{
      --bg:#020617; --bg2:#0b1020; --line:rgba(148,163,184,.22);
      --ink:#f9fafb; --muted:#cbd5f5;
      --gold:#facc15; --green:#22c55e; --red:#ef4444;
      --card:rgba(255,255,255,.03); --shadow:0 22px 50px rgba(0,0,0,.55);
      --r:18px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      min-height:100vh;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      color:var(--ink);
      background:
        radial-gradient(900px 520px at 12% -10%, rgba(250,204,21,.16), transparent 60%),
        radial-gradient(900px 520px at 90% 0%, rgba(34,197,94,.12), transparent 60%),
        linear-gradient(180deg, var(--bg2), var(--bg));
      padding:16px;
    }
    .wrap{max-width:980px;margin:0 auto}
    .top{
      display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap;
      padding:12px;border:1px solid var(--line);border-radius:18px;background:var(--card);
      box-shadow:var(--shadow);
    }
    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:44px;height:44px;border-radius:16px;
      background:linear-gradient(135deg, rgba(250,204,21,.35), rgba(34,197,94,.2));
      border:1px solid rgba(250,204,21,.35);
      display:grid;place-items:center;color:#061b14;font-weight:1100;
    }
    h1{font-size:1.06rem}
    .sub{color:var(--muted);font-weight:850;margin-top:4px}
    .pill{
      border:1px solid rgba(148,163,184,.35);
      padding:7px 10px;border-radius:999px;background:rgba(255,255,255,.02);
      color:var(--muted);font-weight:900;font-size:.86rem;
    }
    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:14px}
    .card{
      border:1px solid var(--line);background:rgba(255,255,255,.03);
      border-radius:20px;box-shadow:var(--shadow);padding:16px;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{display:block;margin:12px 0 6px;font-weight:950;color:#fff}
    input{
      width:100%;border-radius:14px;border:1px solid var(--line);
      background:rgba(0,0,0,.18);color:var(--ink);
      padding:12px 12px;font-weight:900;outline:none;
    }
    input:focus{border-color:var(--gold);box-shadow:0 0 0 3px rgba(250,204,21,.15)}
    .btn{
      min-height:46px;border-radius:14px;border:1px solid var(--line);
      background:rgba(255,255,255,.04);color:#fff;font-weight:1100;font-size:15px;
      cursor:pointer;text-decoration:none; padding:10px 12px;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
    }
    .btn.primary{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.35)}
    .btn.gold{background:rgba(250,204,21,.10);border-color:rgba(250,204,21,.35);color:#fff}
    .btn.red{background:rgba(239,68,68,.10);border-color:rgba(239,68,68,.35)}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .note{
      margin-top:10px;padding:10px 12px;border-radius:14px;border:1px solid rgba(148,163,184,.25);
      background:rgba(255,255,255,.03);color:var(--muted);font-weight:900;white-space:pre-wrap;display:none;
    }
    .note.ok{display:block;border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.09);color:#bbf7d0}
    .note.bad{display:block;border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.09);color:#fecaca}
    .note.warn{display:block;border-color:rgba(250,204,21,.35);background:rgba(250,204,21,.09);color:#fde68a}

    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px;border-bottom:1px solid rgba(148,163,184,.18);text-align:left;font-weight:850}
    th{color:rgba(203,213,245,.9);font-size:.85rem}
    td{color:#f9fafb;font-size:.95rem}
    .tiny{color:rgba(203,213,245,.9);font-weight:850;font-size:.9rem;line-height:1.35;margin-top:10px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:860px){.two{grid-template-columns:1fr}}
    canvas{background:#fff;border-radius:12px}
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div class="brand">
      <div class="logo">‚àû</div>
      <div>
        <h1>DIGIY ‚ôæÔ∏è ‚Äî GO LINKS</h1>
        <div class="sub">Liens + QR (simple terrain) ¬∑ <b>slug</b> + <b>PIN (4 chiffres)</b></div>
      </div>
    </div>
    <div class="pill" id="pillSlug">slug : ‚Äî</div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div style="font-weight:950">üîê Acc√®s</div>
        <div class="pill" id="pillStatus">Session : ‚Äî</div>
      </div>

      <div class="two" style="margin-top:10px">
        <div>
          <label>T√©l√©phone (Wave)</label>
          <input id="phone" type="tel" inputmode="tel" placeholder="+22177..." autocomplete="off"/>
          <div class="tiny">Astuce : PIN = <b>4 derniers chiffres</b> de ce t√©l√©phone.</div>
        </div>
        <div>
          <label>PIN (4 chiffres)</label>
          <input id="pin4" type="tel" inputmode="numeric" maxlength="4" placeholder="5785" autocomplete="off"/>
          <div class="tiny">Si le proprio oublie : tu lui dis ‚Äúc‚Äôest les 4 derniers chiffres‚Äù.</div>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <button class="btn primary" id="btnLoad">‚Üª Charger mes liens</button>
        <button class="btn gold" id="btnSave">üíæ Enregistrer</button>
        <button class="btn red" id="btnReset">üßπ Vider la liste</button>
      </div>

      <div class="row" style="margin-top:12px">
        <a class="btn" id="btnOpenApp" href="#">üè† Ouvrir APP</a>
        <a class="btn" id="btnOpenPublic" href="#">üëÅÔ∏è GO PIN public</a>
        <a class="btn" id="btnOpenPin" href="#">üîë Ouvrir l‚Äôacc√®s (PIN)</a>
      </div>

      <div class="note warn" id="note"></div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center">
        <div style="font-weight:950">üîó GO LINKS</div>
        <button class="btn" id="btnAdd">‚ûï Nouveau lien</button>
      </div>

      <div class="tiny">Un lien = un bouton sur la page GO PIN (Commander / R√©server / Demander course‚Ä¶).</div>

      <table>
        <thead>
          <tr>
            <th style="width:90px">Ordre</th>
            <th>Label</th>
            <th>URL</th>
            <th style="width:90px">Actif</th>
            <th style="width:110px">Actions</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>

    <div class="card">
      <div style="font-weight:950">‚¨áÔ∏è QR (t√©l√©chargement)</div>
      <div class="tiny">Ces QR pointent vers : <span class="mono" id="qrAppUrl">‚Äî</span></div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnQrApp">‚¨áÔ∏è QR APP</button>
        <button class="btn" id="btnQrPublic">‚¨áÔ∏è QR Public</button>
        <button class="btn" id="btnQrPin">‚¨áÔ∏è QR Acc√®s (PIN)</button>
      </div>
      <div class="row" style="margin-top:10px">
        <canvas id="qrCanvas" width="260" height="260" style="display:none"></canvas>
      </div>
      <div class="tiny" id="qrInfo">Choisis un slug (via lien) + charge tes liens.</div>
    </div>
  </div>
</div>

<script>
(function(){
  "use strict";
  const $ = (id)=>document.getElementById(id);

  function show(msg, cls){
    const el = $("note");
    el.className = "note " + (cls || "warn");
    el.textContent = msg || "";
    el.style.display = msg ? "block" : "none";
  }

  function getSlug(){
    return (window.DIGIY_GUARD?.getSlug?.() || new URL(location.href).searchParams.get("slug") || "").trim();
  }

  function withSlug(url){
    return window.DIGIY_GUARD?.withSlug ? window.DIGIY_GUARD.withSlug(url) : url;
  }

  function normPhone(p){
    p = String(p||"").trim().replace(/\s+/g,"").replace(/[^\d+]/g,"");
    if(p.startsWith("00221")) p = "+221" + p.slice(5);
    if(!p.startsWith("+") && p.startsWith("221")) p = "+" + p;
    if(!p.startsWith("+221") && /^\d{9}$/.test(p)) p = "+221" + p;
    return p;
  }

  const SLUG = getSlug();
  $("pillSlug").textContent = "slug : " + (SLUG || "‚Äî");

  // Raccord app/public/pin
  const appUrl = new URL("./app.html", location.href);
  const pubUrl = new URL("./go-pin-public.html", location.href);
  const pinUrl = new URL("./pin.html", location.href);
  if(SLUG){
    appUrl.searchParams.set("slug", SLUG);
    pubUrl.searchParams.set("slug", SLUG);
    pinUrl.searchParams.set("slug", SLUG);
  }
  $("btnOpenApp").href = appUrl.toString();
  $("btnOpenPublic").href = pubUrl.toString();
  $("btnOpenPin").href = pinUrl.toString();
  $("qrAppUrl").textContent = appUrl.toString();

  // Prefill phone depuis session guard si dispo
  try{
    const sess = window.DIGIY_GUARD?.getSession?.();
    if(sess?.phone) $("phone").value = sess.phone;
  }catch(_){}

  function getSB(){
    return window.DIGIY_GUARD?.getSb?.() || window.DIGIY_GUARD?.sb || window.sb || null;
  }

  function setStatus(ok){
    $("pillStatus").textContent = "Session : " + (ok ? "OK" : "‚Äî");
    $("pillStatus").style.borderColor = ok ? "rgba(34,197,94,.35)" : "rgba(148,163,184,.35)";
  }

  // ---------------------------
  // LINKS MODEL
  // { order:number, label:string, url:string, active:boolean }
  // ---------------------------
  let LINKS = [];

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function render(){
    const tb = $("rows");
    if(!LINKS.length){
      tb.innerHTML = `<tr><td colspan="5" style="color:rgba(203,213,245,.9)">‚Äî aucun lien ‚Äî</td></tr>`;
      return;
    }
    LINKS.sort((a,b)=>(a.order||999)-(b.order||999));
    tb.innerHTML = LINKS.map((x,i)=>{
      const ord = Number(x.order||100);
      const lab = escapeHtml(x.label||"");
      const url = escapeHtml(x.url||"");
      const act = !!x.active;
      return `
        <tr>
          <td><input data-i="${i}" data-k="order" value="${ord}" style="padding:10px;border-radius:12px;border:1px solid rgba(148,163,184,.22);background:rgba(0,0,0,.18);color:#fff;font-weight:900;width:90px"/></td>
          <td><input data-i="${i}" data-k="label" value="${lab}" style="padding:10px;border-radius:12px;border:1px solid rgba(148,163,184,.22);background:rgba(0,0,0,.18);color:#fff;font-weight:900;width:100%"/></td>
          <td><input data-i="${i}" data-k="url" value="${url}" style="padding:10px;border-radius:12px;border:1px solid rgba(148,163,184,.22);background:rgba(0,0,0,.18);color:#fff;font-weight:900;width:100%"/></td>
          <td>
            <select data-i="${i}" data-k="active" style="padding:10px;border-radius:12px;border:1px solid rgba(148,163,184,.22);background:rgba(0,0,0,.18);color:#fff;font-weight:900;width:90px">
              <option value="true" ${act?"selected":""}>Oui</option>
              <option value="false" ${!act?"selected":""}>Non</option>
            </select>
          </td>
          <td>
            <button class="btn red" style="min-height:40px;padding:8px 10px" data-del="${i}">üóëÔ∏è</button>
          </td>
        </tr>
      `;
    }).join("");

    // bind changes
    tb.querySelectorAll("input,select").forEach(el=>{
      el.addEventListener("change", ()=>{
        const i = Number(el.getAttribute("data-i"));
        const k = el.getAttribute("data-k");
        if(!Number.isFinite(i) || !k) return;
        if(k==="order") LINKS[i].order = Number(el.value||100);
        if(k==="label") LINKS[i].label = String(el.value||"").trim();
        if(k==="url") LINKS[i].url = String(el.value||"").trim();
        if(k==="active") LINKS[i].active = (String(el.value)==="true");
      });
    });
    tb.querySelectorAll("button[data-del]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const i = Number(btn.getAttribute("data-del"));
        LINKS.splice(i,1);
        render();
      });
    });
  }

  function validateLinks(list){
    const clean = [];
    for(const x of (list||[])){
      const label = String(x.label||"").trim();
      const url = String(x.url||"").trim();
      const order = Number(x.order||100);
      const active = !!x.active;
      if(!label || !url) continue;
      clean.push({ order, label, url, active });
    }
    return clean;
  }

  // ---------------------------
  // RPC calls
  // ---------------------------
  async function loadLinks(){
    const sb = getSB();
    if(!sb) return show("‚ùå Supabase pas pr√™t (sb null). Recharge ou reconnecte via PIN.", "bad");

    if(!SLUG) return show("‚ö†Ô∏è Lien incomplet: ajoute ?slug=chez-astou-saly", "bad");

    const phone = normPhone($("phone").value);
    const pin4 = String($("pin4").value||"").trim();

    if(!phone) return show("‚ö†Ô∏è Mets le t√©l√©phone Wave du proprio.", "warn");
    if(pin4.length !== 4) return show("‚ö†Ô∏è Mets le PIN (4 chiffres).", "warn");

    show("‚è≥ Chargement‚Ä¶", "warn");
    setStatus(true);

    const { data, error } = await sb.rpc("digiy_go_links_get", {
      p_slug: SLUG,
      p_phone: phone,
      p_pin4: pin4
    });

    if(error){
      console.error(error);
      return show("‚ùå Erreur: " + (error.message || error), "bad");
    }
    if(!data?.ok){
      return show("‚ùå Acc√®s refus√©: " + (data?.error || "unknown"), "bad");
    }

    LINKS = Array.isArray(data.links) ? data.links : [];
    render();
    show("‚úÖ Liens charg√©s.", "ok");
  }

  async function saveLinks(){
    const sb = getSB();
    if(!sb) return show("‚ùå Supabase pas pr√™t (sb null).", "bad");
    if(!SLUG) return show("‚ö†Ô∏è Lien incomplet: ajoute ?slug=...", "bad");

    const phone = normPhone($("phone").value);
    const pin4 = String($("pin4").value||"").trim();

    if(!phone) return show("‚ö†Ô∏è Mets le t√©l√©phone Wave du proprio.", "warn");
    if(pin4.length !== 4) return show("‚ö†Ô∏è Mets le PIN (4 chiffres).", "warn");

    const clean = validateLinks(LINKS);
    show("‚è≥ Enregistrement‚Ä¶", "warn");
    setStatus(true);

    const { data, error } = await sb.rpc("digiy_go_links_save", {
      p_slug: SLUG,
      p_phone: phone,
      p_pin4: pin4,
      p_links: clean
    });

    if(error){
      console.error(error);
      return show("‚ùå Erreur: " + (error.message || error), "bad");
    }
    if(!data?.ok){
      return show("‚ùå Acc√®s refus√©: " + (data?.error || "unknown"), "bad");
    }

    show("‚úÖ Enregistr√©. (" + (data.count ?? clean.length) + " lien(s))", "ok");
  }

  // ---------------------------
  // QR download (sans lib externe)
  // -> On g√©n√®re un QR via API simple (Google chart) MAIS offline = non.
  // Comme tu es en prod web, √ßa passe.
  // Si tu veux 100% offline: on met une lib QR plus tard.
  // ---------------------------
  function downloadQr(label, url){
    if(!SLUG) return show("Choisis un slug.", "warn");
    const api = "https://chart.googleapis.com/chart?cht=qr&chs=600x600&chld=M|0&chl=" + encodeURIComponent(url);
    const a = document.createElement("a");
    a.href = api;
    a.download = `digiy-qr-${label}-${SLUG}.png`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    $("qrInfo").textContent = label + " ‚Üí " + url;
  }

  // ---------------------------
  // Bind UI
  // ---------------------------
  $("btnAdd").addEventListener("click", ()=>{
    LINKS.push({ order: 100, label:"Commander / R√©server", url:"https://", active:true });
    render();
  });

  $("btnReset").addEventListener("click", ()=>{
    if(!confirm("Vider la liste ?")) return;
    LINKS = [];
    render();
    show("Liste vid√©e. Pense √† Enregistrer.", "warn");
  });

  $("btnLoad").addEventListener("click", loadLinks);
  $("btnSave").addEventListener("click", saveLinks);

  $("btnQrApp").addEventListener("click", ()=> downloadQr("app", appUrl.toString()));
  $("btnQrPublic").addEventListener("click", ()=> downloadQr("public", pubUrl.toString()));
  $("btnQrPin").addEventListener("click", ()=> downloadQr("acces", pinUrl.toString()));

  // init
  render();

  if(!SLUG){
    show("‚ö†Ô∏è Ouvre ce fichier via un lien avec slug.\nEx: manage-links.html?slug=chez-astou-saly", "bad");
  }else{
    show("‚úÖ Slug reconnu. Mets t√©l√©phone + PIN4 puis ‚ÄúCharger mes liens‚Äù.", "ok");
  }

})();
</script>
</body>
</html>
