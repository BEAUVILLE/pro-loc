<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>DIGIY ‚ôæÔ∏è ‚Äî GO PIN ‚Ä¢ Manage Links</title>
  <meta name="theme-color" content="#16a34a" />

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- ‚úÖ Guard (repo-safe + slug keep + SB unique) -->
  <script src="./guard.js?v=locpro-final"></script>

  <!-- QR (simple, fiable) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <style>
    :root{
      --bg:#061b14; --card:#0b2a1f; --line:rgba(255,255,255,.14);
      --text:#eafff1; --muted:rgba(234,255,241,.75);
      --ok:#22c55e; --bad:#ef4444; --warn:#f59e0b; --gold:#facc15;
      --r:18px;
      --shadow:0 18px 45px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background:
        radial-gradient(900px 500px at 10% -10%, rgba(34,197,94,.20), transparent 60%),
        radial-gradient(900px 500px at 90% 0%, rgba(250,204,21,.12), transparent 60%),
        var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px;}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:16px;
      margin:12px 0;
      box-shadow:var(--shadow);
    }
    h1{margin:6px 0 2px;font-size:20px}
    h2{margin:0 0 8px;font-size:16px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;align-items:center}
    .pill{
      padding:8px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(0,0,0,.18);font-weight:900;font-size:12px
    }
    .ok{border-color:rgba(34,197,94,.55);background:rgba(34,197,94,.12)}
    .bad{border-color:rgba(239,68,68,.55);background:rgba(239,68,68,.12)}
    .warn{border-color:rgba(245,158,11,.55);background:rgba(245,158,11,.12)}
    .gold{border-color:rgba(250,204,21,.55);background:rgba(250,204,21,.10)}
    code{background:rgba(0,0,0,.25);padding:2px 6px;border-radius:8px}

    button, .btn{
      cursor:pointer;border:1px solid var(--line);
      background:rgba(255,255,255,.06);color:var(--text);
      padding:10px 12px;border-radius:14px;font-weight:950;
      text-decoration:none;display:inline-flex;align-items:center;gap:8px;
    }
    button:hover,.btn:hover{background:rgba(255,255,255,.09)}
    button.primary{border-color:rgba(34,197,94,.55);background:rgba(34,197,94,.12)}
    button.gold{border-color:rgba(250,204,21,.55);background:rgba(250,204,21,.10);color:#fff}
    button.danger{border-color:rgba(239,68,68,.55);background:rgba(239,68,68,.10)}
    button:disabled{opacity:.55;cursor:not-allowed}

    input, select{
      flex:1;min-width:240px;
      padding:10px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);color:#eafff1;font-weight:850;
      outline:none;
    }
    input::placeholder{color:rgba(234,255,241,.55)}
    .grid{display:grid;grid-template-columns:220px 1fr;gap:10px;margin-top:12px}
    .k{color:var(--muted);font-weight:900;font-size:12px}
    .v{word-break:break-word}
    .small{font-size:12px;color:var(--muted);line-height:1.35}

    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid rgba(255,255,255,.12);padding:10px;text-align:left}
    th{color:var(--muted);font-size:12px;text-transform:uppercase}
    td{font-weight:800;font-size:13px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}

    .split{
      display:grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap:12px;
    }
    @media(max-width:900px){
      .split{grid-template-columns:1fr}
      .grid{grid-template-columns:1fr}
    }

    .qrbox{
      border:1px dashed rgba(255,255,255,.18);
      border-radius:16px;
      padding:12px;
      background:rgba(0,0,0,.12);
    }
    .qrrow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .qr{
      width:220px;height:220px;border-radius:14px;
      background:rgba(255,255,255,.04);
      display:grid;place-items:center;
      border:1px solid rgba(255,255,255,.12);
    }
    .note{margin-top:10px;color:var(--muted);font-weight:850}
  </style>
</head>

<body>
  <div class="wrap">

    <div class="card">
      <h1>DIGIY ‚ôæÔ∏è ‚Äî GO PIN</h1>
      <div class="muted">Manage Links ¬∑ Connexion ¬∑ QR</div>

      <div class="row" id="pills"></div>

      <div class="row">
        <input id="email" placeholder="Email (Magic Link recommand√©)" />
        <input id="password" type="password" placeholder="Mot de passe (optionnel si magic link)" />
        <button class="primary" id="btnLogin">Login</button>
        <button class="gold" id="btnMagic">Envoyer Magic Link</button>
        <button id="btnLogout">Logout</button>
      </div>

      <div class="row">
        <button id="btnRefreshPins">‚Üª Rafra√Æchir PINs</button>
        <select id="pinSelect">
          <option value="">‚Äî choisir ‚Äî</option>
        </select>
        <a class="btn" id="btnOpenApp" href="#">üè† Ouvrir APP</a>
        <a class="btn" id="btnOpenPublic" href="#">üëÅÔ∏è GO PIN public</a>
        <a class="btn" id="btnOpenAccess" href="#">üîë Ouvrir l‚Äôacc√®s (PIN)</a>
      </div>

      <div class="small" id="msg" style="margin-top:10px"></div>
      <div class="small" style="margin-top:8px">
        ‚ö†Ô∏è Le owner ne voit que ses PINs (RLS). Si tu vois ‚Äú‚Äî aucun PIN ‚Äî‚Äù, fais un <b>Magic Link</b> puis ‚ÄúRafra√Æchir‚Äù.
      </div>
    </div>

    <div class="split">
      <div class="card">
        <h2>GO LINKS</h2>
        <div class="muted">Ajoute les boutons ‚ÄúCommander / R√©server / Demander course / etc.‚Äù</div>

        <div class="row" style="margin-top:12px">
          <input id="linkLabel" placeholder="Label (ex: Commander / R√©server / Voir catalogue)" />
          <input id="linkUrl" placeholder="URL https://..." />
        </div>

        <div class="row">
          <input id="linkOrder" type="number" min="0" step="1" placeholder="Ordre (petit = en haut)" value="100" />
          <select id="linkActive" style="min-width:220px">
            <option value="true">Actif : Oui</option>
            <option value="false">Actif : Non</option>
          </select>
          <button class="primary" id="btnSaveLink">Enregistrer</button>
          <button id="btnNew">Nouveau</button>
          <button id="btnReloadLinks">‚Üª Recharger</button>
        </div>

        <div class="note" id="needPinNote">üëâ Connecte-toi puis choisis un PIN pour g√©rer ses liens.</div>

        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>Ordre</th>
                <th>Label</th>
                <th>URL</th>
                <th>Actif</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="linksBody">
              <tr><td colspan="5" class="muted">‚Äî aucun lien ‚Äî</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h2>QR (pour app / public / acc√®s)</h2>
        <div class="muted">slug: <b id="slugOut">‚Äî</b></div>

        <div class="qrbox" style="margin-top:12px">
          <div class="qrrow">
            <div>
              <div class="muted" style="font-weight:950">QR APP</div>
              <div class="qr" id="qrApp"></div>
              <div class="row">
                <button class="gold" id="dlApp">‚¨áÔ∏è QR APP</button>
              </div>
            </div>

            <div>
              <div class="muted" style="font-weight:950">QR Public</div>
              <div class="qr" id="qrPublic"></div>
              <div class="row">
                <button class="gold" id="dlPublic">‚¨áÔ∏è QR Public</button>
              </div>
            </div>

            <div>
              <div class="muted" style="font-weight:950">QR Acc√®s (PIN)</div>
              <div class="qr" id="qrAccess"></div>
              <div class="row">
                <button class="gold" id="dlAccess">‚¨áÔ∏è QR Acc√®s</button>
              </div>
            </div>
          </div>

          <div class="small" style="margin-top:10px">
            Les QR pointent vers :
            <div class="grid" style="margin-top:8px">
              <div class="k">APP</div><div class="v" id="urlApp">‚Äî</div>
              <div class="k">Public</div><div class="v" id="urlPublic">‚Äî</div>
              <div class="k">Acc√®s</div><div class="v" id="urlAccess">‚Äî</div>
            </div>
          </div>
        </div>

        <div class="small" style="margin-top:10px">
          ‚úÖ Stockage links : tente table d√©di√©e, sinon fallback dans <code>digiy_loc_settings</code> avec cl√© <code>go_links:&lt;slug&gt;</code>.
        </div>
      </div>
    </div>

  </div>

<script>
(function(){
  "use strict";

  const $ = (id)=>document.getElementById(id);

  // -----------------------------
  // SUPABASE (via GUARD)
  // -----------------------------
  function getSB(){
    return window.DIGIY_GUARD?.getSb?.()
        || window.DIGIY_GUARD?.sb
        || window.sb
        || null;
  }

  const sb = getSB();
  const msgEl = $("msg");

  function setMsg(t, kind){
    msgEl.textContent = t || "";
    msgEl.style.color =
      kind === "bad" ? "rgba(254,202,202,.95)" :
      kind === "ok"  ? "rgba(187,247,208,.95)" :
      kind === "warn"? "rgba(253,230,138,.95)" :
      "rgba(203,213,245,.95)";
  }

  function pill(text, kind){
    const el = document.createElement("div");
    el.className = "pill " + (kind||"");
    el.textContent = text;
    return el;
  }
  function setPills(items){
    const host = $("pills");
    host.innerHTML = "";
    items.forEach(x => host.appendChild(pill(x.text, x.kind)));
  }

  // -----------------------------
  // URL builder (repo-safe)
  // -----------------------------
  function baseOfRepoPage(){
    // ex: https://beauville.github.io/digiy-loc-pro/manage-links.html
    // => base = https://beauville.github.io/digiy-loc-pro/
    const u = new URL(location.href);
    u.hash = "";
    u.search = "";
    u.pathname = u.pathname.replace(/\/[^\/]*$/, "/");
    return u.toString();
  }

  function urlWithSlug(file, slug){
    const u = new URL(file, baseOfRepoPage());
    if(slug) u.searchParams.set("slug", slug);
    return u.toString();
  }

  // -----------------------------
  // STATE
  // -----------------------------
  const State = {
    user: null,
    pin: null,     // selected pin row
    slug: "",
    pins: [],
    links: [],     // {id?, order,label,url,active}
    storeMode: null // "table:digiy_go_links" | ... | "settings"
  };

  // -----------------------------
  // SAFE pick slug from pin row
  // -----------------------------
  function pickSlugFromPin(row){
    const candidates = [
      row?.slug,
      row?.place_slug,
      row?.loc_slug,
      row?.business_slug,
      row?.pin_slug,
      row?.code,
      row?.business_code
    ].map(x => (x||"").toString().trim()).filter(Boolean);

    return candidates[0] || "";
  }

  // -----------------------------
  // AUTH
  // -----------------------------
  async function refreshAuth(){
    const pills = [];
    if(!sb){
      setPills([{text:"Supabase ‚ùå (sb null)", kind:"bad"}]);
      setMsg("Supabase pas pr√™t (sb null). Recharge ou reconnecte-toi via PIN.", "bad");
      return;
    }

    try{
      const { data, error } = await sb.auth.getUser();
      if(error) throw error;
      State.user = data?.user || null;

      if(State.user){
        pills.push({text:"Auth ‚úÖ " + (State.user.email || "user"), kind:"ok"});
      }else{
        pills.push({text:"Auth ‚ùå", kind:"bad"});
      }
    }catch(e){
      State.user = null;
      pills.push({text:"Auth ‚ùå", kind:"bad"});
      setMsg("Auth: " + (e?.message || e), "bad");
    }

    setPills(pills);
  }

  async function loginPassword(){
    if(!sb) return;
    const email = ($("email").value||"").trim();
    const password = ($("password").value||"").trim();
    if(!email || !password){
      setMsg("Mets email + mot de passe (sinon utilise Magic Link).", "warn");
      return;
    }
    setMsg("Connexion‚Ä¶", "warn");
    const { data, error } = await sb.auth.signInWithPassword({ email, password });
    if(error){
      setMsg("‚ùå " + error.message + " (utilise Magic Link si tu pr√©f√®res)", "bad");
      await refreshAuth();
      return;
    }
    setMsg("‚úÖ Connect√©: " + (data?.user?.email || email), "ok");
    await refreshAuth();
    await loadPins();
  }

  async function sendMagic(){
    if(!sb) return;
    const email = ($("email").value||"").trim();
    if(!email){
      setMsg("Mets ton email puis envoie le Magic Link.", "warn");
      return;
    }
    setMsg("Envoi du Magic Link‚Ä¶", "warn");
    const emailRedirectTo = location.href; // retour ici
    const { error } = await sb.auth.signInWithOtp({
      email,
      options: { emailRedirectTo }
    });
    if(error){
      setMsg("‚ùå " + error.message, "bad");
      return;
    }
    setMsg("‚úÖ Magic Link envoy√©. Ouvre ton email ‚Üí clique ‚Üí reviens ici ‚Üí clique ‚ÄúRafra√Æchir PINs‚Äù.", "ok");
  }

  async function logout(){
    if(!sb) return;
    await sb.auth.signOut();
    State.user = null;
    setMsg("D√©connect√©.", "warn");
    await refreshAuth();
    renderPins([]);
    setSelectedPin(null);
  }

  // -----------------------------
  // PINS
  // -----------------------------
  function renderPins(rows){
    const sel = $("pinSelect");
    sel.innerHTML = `<option value="">‚Äî choisir ‚Äî</option>`;

    if(!rows || !rows.length){
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "‚Äî aucun PIN ‚Äî";
      sel.appendChild(opt);
      return;
    }

    rows.forEach((r, idx)=>{
      const slug = pickSlugFromPin(r);
      const label =
        (r?.business_name || r?.name || r?.title || "").toString().trim()
        || (slug ? slug : "PIN " + (idx+1));
      const opt = document.createElement("option");
      opt.value = String(r.id || r.pin_id || slug || idx);
      opt.textContent = `${label}${slug ? " ‚Äî " + slug : ""}`;
      opt.dataset.idx = String(idx);
      sel.appendChild(opt);
    });
  }

  async function loadPins(){
    if(!sb) return;
    setMsg("Chargement PINs‚Ä¶", "warn");

    // ‚ö†Ô∏è RLS: sans auth -> vide
    try{
      // On essaie select cibl√©, puis fallback *
      let res = await sb.from("digiy_admin_pins").select("id,slug,business_name,name,title,place_slug,loc_slug,business_slug,pin_slug,code,business_code,status").limit(200);
      if(res.error && (res.error.code === "42703" || res.error.code === "PGRST116")){
        res = await sb.from("digiy_admin_pins").select("*").limit(200);
      }

      if(res.error) throw res.error;

      const rows = res.data || [];
      State.pins = rows;
      renderPins(rows);

      setMsg(rows.length ? `‚úÖ ${rows.length} PIN(s) trouv√©(s).` : "‚ö†Ô∏è Aucun PIN. V√©rifie que tu es bien connect√© (Magic Link).", rows.length ? "ok" : "warn");
    }catch(e){
      console.error(e);
      setMsg("‚ùå Lecture PINs: " + (e?.message || e), "bad");
      renderPins([]);
    }
  }

  function setSelectedPin(pinRow){
    State.pin = pinRow;
    State.slug = pinRow ? pickSlugFromPin(pinRow) : "";
    $("slugOut").textContent = State.slug || "‚Äî";

    const can = !!State.slug;

    $("needPinNote").style.display = can ? "none" : "block";
    $("btnSaveLink").disabled = !can;
    $("btnReloadLinks").disabled = !can;
    $("btnNew").disabled = !can;

    // URLs / Buttons
    const appUrl = can ? urlWithSlug("./app.html", State.slug) : "#";
    const pubUrl = can ? urlWithSlug("./go-pin-public.html", State.slug) : "#";
    const accUrl = can ? urlWithSlug("./pin.html", State.slug) : "#";

    $("btnOpenApp").href = appUrl;
    $("btnOpenPublic").href = pubUrl;
    $("btnOpenAccess").href = accUrl;

    $("urlApp").textContent = can ? appUrl : "‚Äî";
    $("urlPublic").textContent = can ? pubUrl : "‚Äî";
    $("urlAccess").textContent = can ? accUrl : "‚Äî";

    // QR
    renderQR("qrApp", appUrl, can);
    renderQR("qrPublic", pubUrl, can);
    renderQR("qrAccess", accUrl, can);

    // reload links
    if(can){
      loadLinks().catch(()=>{});
    }else{
      renderLinks([]);
    }
  }

  $("pinSelect").addEventListener("change", ()=>{
    const opt = $("pinSelect").selectedOptions[0];
    const idx = opt?.dataset?.idx;
    if(idx == null || idx === ""){ setSelectedPin(null); return; }
    const row = State.pins[Number(idx)] || null;
    setSelectedPin(row);
  });

  // -----------------------------
  // LINKS storage
  // Strategy:
  // 1) Try table digiy_go_links
  // 2) Try table digiy_loc_links
  // 3) Try table digiy_links
  // 4) Fallback digiy_loc_settings with k="go_links:<slug>", v=JSON string
  // -----------------------------
  const LINK_TABLE_CANDIDATES = ["digiy_go_links","digiy_loc_links","digiy_links"];

  async function tableExists(name){
    try{
      const t = await sb.from(name).select("*").limit(1);
      // If table missing => PGRST205
      if(t.error && t.error.code === "PGRST205") return false;
      return true;
    }catch{
      return false;
    }
  }

  async function detectStoreMode(){
    if(State.storeMode) return State.storeMode;
    for(const tn of LINK_TABLE_CANDIDATES){
      const ok = await tableExists(tn);
      if(ok){
        State.storeMode = "table:" + tn;
        return State.storeMode;
      }
    }
    State.storeMode = "settings";
    return State.storeMode;
  }

  function normalizeLinkRow(x){
    return {
      id: x?.id ?? null,
      slug: (x?.slug || x?.place_slug || x?.loc_slug || x?.business_slug || "").toString().trim(),
      label: (x?.label || x?.name || "").toString().trim(),
      url: (x?.url || x?.href || "").toString().trim(),
      ord: Number(x?.ord ?? x?.order ?? 100),
      active: (typeof x?.active === "boolean") ? x.active : String(x?.active ?? "true") === "true"
    };
  }

  async function loadLinks(){
    if(!sb || !State.slug) return;

    const mode = await detectStoreMode();
    setMsg("Chargement des liens‚Ä¶ (" + mode + ")", "warn");

    try{
      if(mode.startsWith("table:")){
        const tn = mode.split(":")[1];

        // Try common schemas:
        // - columns: slug,label,url,ord,active
        // fallback select *
        let r = await sb.from(tn).select("id,slug,label,url,ord,active,order,name,href,place_slug,loc_slug,business_slug").eq("slug", State.slug).order("ord", {ascending:true});
        if(r.error && r.error.code === "42703"){
          r = await sb.from(tn).select("*").limit(500);
        }
        if(r.error) throw r.error;

        const rows = (r.data||[]).map(normalizeLinkRow)
          .filter(x => (x.slug ? x.slug === State.slug : true));

        State.links = rows.sort((a,b)=> (a.ord-b.ord));
        renderLinks(State.links);
        setMsg("‚úÖ Liens charg√©s.", "ok");
        return;
      }

      // SETTINGS mode
      const key = "go_links:" + State.slug;
      const r = await sb.from("digiy_loc_settings").select("k,v").eq("k", key).limit(1);
      if(r.error) throw r.error;

      const row = (r.data||[])[0];
      let arr = [];
      if(row?.v){
        try{ arr = JSON.parse(row.v); }catch{ arr = []; }
      }
      State.links = Array.isArray(arr) ? arr : [];
      State.links = State.links.map(x => ({
        id: x?.id ?? null,
        slug: State.slug,
        label: (x?.label||"").toString(),
        url: (x?.url||"").toString(),
        ord: Number(x?.ord ?? 100),
        active: !!x?.active
      })).sort((a,b)=>a.ord-b.ord);

      renderLinks(State.links);
      setMsg("‚úÖ Liens charg√©s (settings).", "ok");
    }catch(e){
      console.error(e);
      setMsg("‚ùå Load links: " + (e?.message || e), "bad");
      renderLinks([]);
    }
  }

  async function saveLink(){
    if(!sb) return;
    if(!State.slug){
      setMsg("Choisis un PIN/slug d‚Äôabord.", "warn");
      return;
    }

    const label = ($("linkLabel").value||"").trim();
    const url = ($("linkUrl").value||"").trim();
    const ord = Number(($("linkOrder").value||"100").trim() || 100);
    const active = ($("linkActive").value||"true") === "true";

    if(!label || !url){
      setMsg("Mets Label + URL.", "warn");
      return;
    }

    const mode = await detectStoreMode();
    setMsg("Enregistrement‚Ä¶ (" + mode + ")", "warn");

    try{
      if(mode.startsWith("table:")){
        const tn = mode.split(":")[1];

        // insert
        const payload = { slug: State.slug, label, url, ord, active };
        let r = await sb.from(tn).insert(payload);
        if(r.error && r.error.code === "42703"){
          // fallback schema: maybe order instead of ord, href instead of url, name instead of label
          const payload2 = { slug: State.slug, name: label, href: url, order: ord, active };
          r = await sb.from(tn).insert(payload2);
        }
        if(r.error) throw r.error;

        $("linkLabel").value = "";
        $("linkUrl").value = "";
        $("linkOrder").value = "100";
        $("linkActive").value = "true";

        await loadLinks();
        setMsg("‚úÖ Lien enregistr√©.", "ok");
        return;
      }

      // SETTINGS mode: merge array then upsert in digiy_loc_settings(k,v)
      const key = "go_links:" + State.slug;

      const next = (State.links || []).slice();
      next.push({ label, url, ord, active });

      const v = JSON.stringify(next.sort((a,b)=> (Number(a.ord||100)-Number(b.ord||100))));

      // Upsert-like:
      const exist = await sb.from("digiy_loc_settings").select("k").eq("k", key).limit(1);
      if(exist.error) throw exist.error;

      if((exist.data||[]).length){
        const upd = await sb.from("digiy_loc_settings").update({ v }).eq("k", key);
        if(upd.error) throw upd.error;
      }else{
        const ins = await sb.from("digiy_loc_settings").insert({ k: key, v });
        if(ins.error) throw ins.error;
      }

      $("linkLabel").value = "";
      $("linkUrl").value = "";
      $("linkOrder").value = "100";
      $("linkActive").value = "true";

      await loadLinks();
      setMsg("‚úÖ Lien enregistr√© (settings).", "ok");
    }catch(e){
      console.error(e);
      setMsg("‚ùå Save link: " + (e?.message || e), "bad");
    }
  }

  async function deleteLink(idx){
    if(!confirm("Supprimer ce lien ?")) return;
    const mode = await detectStoreMode();

    try{
      if(mode.startsWith("table:")){
        const tn = mode.split(":")[1];
        const row = State.links[idx];
        if(!row?.id){
          setMsg("‚ùå Impossible de supprimer (id manquant). Mode table.", "bad");
          return;
        }
        const r = await sb.from(tn).delete().eq("id", row.id);
        if(r.error) throw r.error;
        await loadLinks();
        setMsg("‚úÖ Supprim√©.", "ok");
        return;
      }

      // settings
      const key = "go_links:" + State.slug;
      const next = (State.links||[]).slice();
      next.splice(idx,1);
      const v = JSON.stringify(next);

      const upd = await sb.from("digiy_loc_settings").update({ v }).eq("k", key);
      if(upd.error) throw upd.error;
      await loadLinks();
      setMsg("‚úÖ Supprim√© (settings).", "ok");
    }catch(e){
      console.error(e);
      setMsg("‚ùå Delete: " + (e?.message || e), "bad");
    }
  }

  function renderLinks(rows){
    const tb = $("linksBody");
    if(!rows || !rows.length){
      tb.innerHTML = `<tr><td colspan="5" class="muted">‚Äî aucun lien ‚Äî</td></tr>`;
      return;
    }

    tb.innerHTML = rows.map((r, idx)=>{
      const act = r.active ? "Oui" : "Non";
      const safeUrl = (r.url||"").replace(/"/g, "&quot;");
      return `
        <tr>
          <td>${Number(r.ord||100)}</td>
          <td>${escapeHtml(r.label||"‚Äî")}</td>
          <td><a href="${safeUrl}" target="_blank" rel="noopener" style="color:#bbf7d0;font-weight:950">${escapeHtml(r.url||"")}</a></td>
          <td>${act}</td>
          <td class="actions">
            <button onclick="window.__digiy_editLink(${idx})">‚úèÔ∏è</button>
            <button class="danger" onclick="window.__digiy_delLink(${idx})">üóëÔ∏è</button>
          </td>
        </tr>
      `;
    }).join("");
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, (c)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  // expose handlers
  window.__digiy_delLink = (idx)=> deleteLink(idx);
  window.__digiy_editLink = (idx)=>{
    const r = State.links[idx];
    if(!r) return;
    $("linkLabel").value = r.label || "";
    $("linkUrl").value = r.url || "";
    $("linkOrder").value = String(Number(r.ord||100));
    $("linkActive").value = r.active ? "true" : "false";
    setMsg("üõ†Ô∏è Modifie puis clique ‚ÄúEnregistrer‚Äù (√ßa ajoute une ligne; pour √©dition parfaite: on fera update ensuite).", "warn");
  };

  // -----------------------------
  // QR
  // -----------------------------
  function clearNode(el){
    while(el.firstChild) el.removeChild(el.firstChild);
  }

  function renderQR(hostId, text, enabled){
    const host = $(hostId);
    clearNode(host);

    if(!enabled || !text || text === "#"){
      host.innerHTML = `<div class="muted" style="padding:10px;text-align:center">Choisis un PIN</div>`;
      return;
    }

    new QRCode(host, {
      text,
      width: 200,
      height: 200,
      correctLevel: QRCode.CorrectLevel.M
    });
  }

  function downloadQR(hostId, filename){
    const host = $(hostId);
    // qrcodejs creates <img> or <canvas>
    const img = host.querySelector("img");
    const canvas = host.querySelector("canvas");

    let dataUrl = null;
    if(img && img.src) dataUrl = img.src;
    if(!dataUrl && canvas) dataUrl = canvas.toDataURL("image/png");
    if(!dataUrl) return alert("QR non pr√™t.");

    const a = document.createElement("a");
    a.href = dataUrl;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  // -----------------------------
  // Events
  // -----------------------------
  $("btnLogin").addEventListener("click", loginPassword);
  $("btnMagic").addEventListener("click", sendMagic);
  $("btnLogout").addEventListener("click", logout);

  $("btnRefreshPins").addEventListener("click", loadPins);
  $("btnReloadLinks").addEventListener("click", ()=> loadLinks());
  $("btnSaveLink").addEventListener("click", saveLink);
  $("btnNew").addEventListener("click", ()=>{
    $("linkLabel").value = "";
    $("linkUrl").value = "";
    $("linkOrder").value = "100";
    $("linkActive").value = "true";
    setMsg("Nouveau lien pr√™t.", "ok");
  });

  $("dlApp").addEventListener("click", ()=> {
    if(!State.slug) return alert("Choisis un PIN.");
    downloadQR("qrApp", `DIGIY_QR_APP_${State.slug}.png`);
  });
  $("dlPublic").addEventListener("click", ()=> {
    if(!State.slug) return alert("Choisis un PIN.");
    downloadQR("qrPublic", `DIGIY_QR_PUBLIC_${State.slug}.png`);
  });
  $("dlAccess").addEventListener("click", ()=> {
    if(!State.slug) return alert("Choisis un PIN.");
    downloadQR("qrAccess", `DIGIY_QR_ACCESS_${State.slug}.png`);
  });

  // auto refresh on auth changes
  sb?.auth?.onAuthStateChange?.(async ()=>{
    await refreshAuth();
    await loadPins();
  });

  // -----------------------------
  // INIT
  // -----------------------------
  (async function init(){
    if(!sb){
      setPills([{text:"Supabase ‚ùå (sb null)", kind:"bad"}]);
      setMsg("Supabase pas pr√™t (sb null). Recharge ou reconnecte-toi via PIN.", "bad");
      return;
    }

    await refreshAuth();
    await loadPins();
    setSelectedPin(null);
    renderLinks([]);

    setMsg("Pr√™t. Connexion Magic Link recommand√©e.", "ok");
  })();

})();
</script>
</body>
</html>
