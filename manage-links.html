<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>DIGIY ‚ôæÔ∏è ‚Äî Liens / QR</title>
  <meta name="theme-color" content="#0b1020"/>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./guard.js?v=locpro-final"></script>

  <style>
    :root{
      --bg:#020617; --bg2:#0b1020; --line:rgba(148,163,184,.22);
      --ink:#f9fafb; --muted:#cbd5f5;
      --gold:#facc15; --green:#22c55e; --red:#ef4444;
      --card:rgba(255,255,255,.03); --shadow:0 22px 50px rgba(0,0,0,.55);
      --r:18px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      min-height:100vh;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      color:var(--ink);
      background:
        radial-gradient(900px 520px at 12% -10%, rgba(250,204,21,.16), transparent 60%),
        radial-gradient(900px 520px at 90% 0%, rgba(34,197,94,.12), transparent 60%),
        linear-gradient(180deg, var(--bg2), var(--bg));
      padding:16px;
    }
    .wrap{max-width:980px;margin:0 auto}
    .top{
      display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap;
      padding:12px;border:1px solid var(--line);border-radius:18px;background:var(--card);
      box-shadow:var(--shadow);
    }
    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:44px;height:44px;border-radius:16px;
      background:linear-gradient(135deg, rgba(250,204,21,.35), rgba(34,197,94,.2));
      border:1px solid rgba(250,204,21,.35);
      display:grid;place-items:center;color:#061b14;font-weight:1100;
    }
    h1{font-size:1.06rem}
    .sub{color:var(--muted);font-weight:850;margin-top:4px}
    .pill{
      border:1px solid rgba(148,163,184,.35);
      padding:7px 10px;border-radius:999px;background:rgba(255,255,255,.02);
      color:var(--muted);font-weight:900;font-size:.86rem;
    }
    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:14px}
    .card{
      border:1px solid var(--line);background:rgba(255,255,255,.03);
      border-radius:20px;box-shadow:var(--shadow);padding:16px;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      min-height:46px;border-radius:14px;border:1px solid var(--line);
      background:rgba(255,255,255,.04);color:#fff;font-weight:1100;font-size:15px;
      cursor:pointer;text-decoration:none; padding:10px 12px;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
    }
    .btn.primary{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.35)}
    .btn.gold{background:rgba(250,204,21,.10);border-color:rgba(250,204,21,.35)}
    .btn.red{background:rgba(239,68,68,.10);border-color:rgba(239,68,68,.35)}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .note{
      margin-top:10px;padding:10px 12px;border-radius:14px;border:1px solid rgba(148,163,184,.25);
      background:rgba(255,255,255,.03);color:var(--muted);font-weight:900;white-space:pre-wrap;display:none;
    }
    .note.ok{display:block;border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.09);color:#bbf7d0}
    .note.bad{display:block;border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.09);color:#fecaca}
    .note.warn{display:block;border-color:rgba(250,204,21,.35);background:rgba(250,204,21,.09);color:#fde68a}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px;border-bottom:1px solid rgba(148,163,184,.18);text-align:left;font-weight:850}
    th{color:rgba(203,213,245,.9);font-size:.85rem}
    td{color:#f9fafb;font-size:.95rem}
    .tiny{color:rgba(203,213,245,.9);font-weight:850;font-size:.9rem;line-height:1.35;margin-top:10px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace}
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div class="brand">
      <div class="logo">‚àû</div>
      <div>
        <h1>DIGIY ‚ôæÔ∏è ‚Äî Liens / QR</h1>
        <div class="sub">Z√©ro email ¬∑ Z√©ro magic link ¬∑ Session PIN (Guard)</div>
      </div>
    </div>
    <div class="pill" id="pillSlug">slug : ‚Äî</div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div style="font-weight:950">üîê Session</div>
        <div class="pill" id="pillStatus">‚Äî</div>
      </div>

      <div class="tiny" id="who">‚Äî</div>

      <div class="row" style="margin-top:12px">
        <button class="btn primary" id="btnLoad">‚Üª Charger</button>
        <button class="btn gold" id="btnSave">üíæ Enregistrer</button>
        <button class="btn red" id="btnReset">üßπ Vider</button>
        <a class="btn" id="btnBack" href="#">‚¨ÖÔ∏è Retour cockpit</a>
      </div>

      <div class="row" style="margin-top:12px">
        <a class="btn" id="btnOpenApp" href="#">üè† Ouvrir APP</a>
        <a class="btn" id="btnOpenPublic" href="#">üëÅÔ∏è GO PIN public</a>
        <a class="btn" id="btnOpenPin" href="#">üîë Acc√®s (PIN)</a>
      </div>

      <div class="note warn" id="note"></div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center">
        <div style="font-weight:950">üîó GO LINKS</div>
        <button class="btn" id="btnAdd">‚ûï Nouveau lien</button>
      </div>

      <div class="tiny">Ces liens deviennent des boutons (Commander / R√©server / WhatsApp / etc.).</div>

      <table>
        <thead>
          <tr>
            <th style="width:90px">Ordre</th>
            <th>Label</th>
            <th>URL</th>
            <th style="width:90px">Actif</th>
            <th style="width:110px">Actions</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>

    <div class="card">
      <div style="font-weight:950">‚¨áÔ∏è QR (t√©l√©chargement)</div>
      <div class="tiny">APP ‚Üí <span class="mono" id="qrAppUrl">‚Äî</span></div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnQrApp">‚¨áÔ∏è QR APP</button>
        <button class="btn" id="btnQrPublic">‚¨áÔ∏è QR Public</button>
        <button class="btn" id="btnQrPin">‚¨áÔ∏è QR Acc√®s</button>
      </div>
      <div class="tiny" id="qrInfo" style="margin-top:10px">‚Äî</div>
    </div>
  </div>
</div>

<script>
(function(){
  "use strict";
  const $ = (id)=>document.getElementById(id);

  function show(msg, cls){
    const el = $("note");
    el.className = "note " + (cls || "warn");
    el.textContent = msg || "";
    el.style.display = msg ? "block" : "none";
  }

  function withSlug(url){
    return window.DIGIY_GUARD?.withSlug ? window.DIGIY_GUARD.withSlug(url) : url;
  }

  function getSlug(){
    return (window.DIGIY_GUARD?.getSlug?.() || new URL(location.href).searchParams.get("slug") || "").trim();
  }

  function normPhone(p){
    p = String(p||"").trim().replace(/\s+/g,"").replace(/[^\d+]/g,"");
    if(p.startsWith("00221")) p = "+221" + p.slice(5);
    if(!p.startsWith("+") && p.startsWith("221")) p = "+" + p;
    if(!p.startsWith("+221") && /^\d{9}$/.test(p)) p = "+221" + p;
    return p;
  }

  function pin4FromPhone(phone){
    const p = normPhone(phone);
    return p ? p.slice(-4) : "";
  }

  function getSB(){
    return window.DIGIY_GUARD?.getSb?.()
        || window.DIGIY_GUARD?.getSupabase?.()
        || window.DIGIY_GUARD?.sb
        || window.sb
        || null;
  }

  // ---------------------------
  // SESSION (GUARD) ‚Äî source unique
  // ---------------------------
  const slug = getSlug();
  $("pillSlug").textContent = "slug : " + (slug || "‚Äî");

  const backUrl = withSlug("./app.html");
  $("btnBack").href = backUrl;

  // Raccord app/public/pin (slug conserv√©)
  const appUrl = new URL("./app.html", location.href);
  const pubUrl = new URL("./go-pin-public.html", location.href);
  const pinUrl = new URL("./pin.html", location.href);
  if(slug){
    appUrl.searchParams.set("slug", slug);
    pubUrl.searchParams.set("slug", slug);
    pinUrl.searchParams.set("slug", slug);
  }
  $("btnOpenApp").href = appUrl.toString();
  $("btnOpenPublic").href = pubUrl.toString();
  $("btnOpenPin").href = pinUrl.toString();
  $("qrAppUrl").textContent = appUrl.toString();

  // ---------------------------
  // LINKS MODEL
  // ---------------------------
  let LINKS = [];

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function render(){
    const tb = $("rows");
    if(!LINKS.length){
      tb.innerHTML = `<tr><td colspan="5" style="color:rgba(203,213,245,.9)">‚Äî aucun lien ‚Äî</td></tr>`;
      return;
    }
    LINKS.sort((a,b)=>(a.order||999)-(b.order||999));
    tb.innerHTML = LINKS.map((x,i)=>{
      const ord = Number(x.order||100);
      const lab = escapeHtml(x.label||"");
      const url = escapeHtml(x.url||"");
      const act = !!x.active;
      return `
        <tr>
          <td><input data-i="${i}" data-k="order" value="${ord}" style="padding:10px;border-radius:12px;border:1px solid rgba(148,163,184,.22);background:rgba(0,0,0,.18);color:#fff;font-weight:900;width:90px"/></td>
          <td><input data-i="${i}" data-k="label" value="${lab}" style="padding:10px;border-radius:12px;border:1px solid rgba(148,163,184,.22);background:rgba(0,0,0,.18);color:#fff;font-weight:900;width:100%"/></td>
          <td><input data-i="${i}" data-k="url" value="${url}" style="padding:10px;border-radius:12px;border:1px solid rgba(148,163,184,.22);background:rgba(0,0,0,.18);color:#fff;font-weight:900;width:100%"/></td>
          <td>
            <select data-i="${i}" data-k="active" style="padding:10px;border-radius:12px;border:1px solid rgba(148,163,184,.22);background:rgba(0,0,0,.18);color:#fff;font-weight:900;width:90px">
              <option value="true" ${act?"selected":""}>Oui</option>
              <option value="false" ${!act?"selected":""}>Non</option>
            </select>
          </td>
          <td>
            <button class="btn red" style="min-height:40px;padding:8px 10px" data-del="${i}">üóëÔ∏è</button>
          </td>
        </tr>
      `;
    }).join("");

    tb.querySelectorAll("input,select").forEach(el=>{
      el.addEventListener("change", ()=>{
        const i = Number(el.getAttribute("data-i"));
        const k = el.getAttribute("data-k");
        if(!Number.isFinite(i) || !k) return;
        if(k==="order") LINKS[i].order = Number(el.value||100);
        if(k==="label") LINKS[i].label = String(el.value||"").trim();
        if(k==="url") LINKS[i].url = String(el.value||"").trim();
        if(k==="active") LINKS[i].active = (String(el.value)==="true");
      });
    });

    tb.querySelectorAll("button[data-del]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const i = Number(btn.getAttribute("data-del"));
        LINKS.splice(i,1);
        render();
      });
    });
  }

  function validateLinks(list){
    const clean = [];
    for(const x of (list||[])){
      const label = String(x.label||"").trim();
      const url = String(x.url||"").trim();
      const order = Number(x.order||100);
      const active = !!x.active;
      if(!label || !url) continue;
      clean.push({ order, label, url, active });
    }
    return clean;
  }

  // ---------------------------
  // RPC (auto phone + pin4 depuis session)
  // ---------------------------
  function getCreds(){
    const sess = window.DIGIY_GUARD?.getSession?.() || null;
    const phone = normPhone(sess?.phone || "");
    const pin4 = pin4FromPhone(phone); // ‚úÖ auto
    return { sess, phone, pin4 };
  }

  async function loadLinks(){
    const sb = getSB();
    if(!sb) return show("‚ùå Supabase pas pr√™t (sb null). Recharge.", "bad");
    if(!slug) return show("‚ùå slug manquant. Ouvre depuis le cockpit (bouton Liens/QR).", "bad");

    const { sess, phone, pin4 } = getCreds();
    if(!sess?.ok || !phone) return show("‚ö†Ô∏è Session manquante. Retourne sur PIN et reconnecte-toi.", "bad");

    show("‚è≥ Chargement‚Ä¶", "warn");

    const { data, error } = await sb.rpc("digiy_go_links_get", {
      p_slug: slug,
      p_phone: phone,
      p_pin4: pin4
    });

    if(error) return show("‚ùå Erreur: " + (error.message || error), "bad");
    if(!data?.ok) return show("‚ùå Acc√®s refus√©: " + (data?.error || "unknown"), "bad");

    LINKS = Array.isArray(data.links) ? data.links : [];
    render();
    show("‚úÖ Liens charg√©s.", "ok");
  }

  async function saveLinks(){
    const sb = getSB();
    if(!sb) return show("‚ùå Supabase pas pr√™t (sb null).", "bad");
    if(!slug) return show("‚ùå slug manquant.", "bad");

    const { sess, phone, pin4 } = getCreds();
    if(!sess?.ok || !phone) return show("‚ö†Ô∏è Session manquante. Retour PIN.", "bad");

    const clean = validateLinks(LINKS);
    show("‚è≥ Enregistrement‚Ä¶", "warn");

    const { data, error } = await sb.rpc("digiy_go_links_save", {
      p_slug: slug,
      p_phone: phone,
      p_pin4: pin4,
      p_links: clean
    });

    if(error) return show("‚ùå Erreur: " + (error.message || error), "bad");
    if(!data?.ok) return show("‚ùå Refus√©: " + (data?.error || "unknown"), "bad");

    show("‚úÖ Enregistr√© (" + (data.count ?? clean.length) + " lien(s)).", "ok");
  }

  // ---------------------------
  // QR download (simple)
  // ---------------------------
  function downloadQr(label, url){
    const api = "https://chart.googleapis.com/chart?cht=qr&chs=600x600&chld=M|0&chl=" + encodeURIComponent(url);
    const a = document.createElement("a");
    a.href = api;
    a.download = `digiy-qr-${label}-${slug || "noslug"}.png`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    $("qrInfo").textContent = label + " ‚Üí " + url;
  }

  // ---------------------------
  // UI bind
  // ---------------------------
  $("btnAdd").addEventListener("click", ()=>{
    LINKS.push({ order: 100, label:"Commander / R√©server", url:"https://", active:true });
    render();
  });

  $("btnReset").addEventListener("click", ()=>{
    if(!confirm("Vider la liste ?")) return;
    LINKS = [];
    render();
    show("Liste vid√©e. Clique Enregistrer.", "warn");
  });

  $("btnLoad").addEventListener("click", loadLinks);
  $("btnSave").addEventListener("click", saveLinks);

  $("btnQrApp").addEventListener("click", ()=> downloadQr("app", appUrl.toString()));
  $("btnQrPublic").addEventListener("click", ()=> downloadQr("public", pubUrl.toString()));
  $("btnQrPin").addEventListener("click", ()=> downloadQr("acces", pinUrl.toString()));

  // ---------------------------
  // INIT UX (auto)
  // ---------------------------
  const sess = window.DIGIY_GUARD?.getSession?.() || null;
  const phone = normPhone(sess?.phone || "");

  $("pillStatus").textContent = sess?.ok ? "Connect√© ‚úÖ" : "Non connect√© ‚ùå";
  $("who").textContent = sess?.ok
    ? ("T√©l√©phone: " + phone + " ¬∑ PIN auto: " + pin4FromPhone(phone) + " ¬∑ (invisible pour le proprio)")
    : "Session absente. Retourne sur PIN et reconnecte-toi.";

  render();

  if(!slug) show("‚ùå slug manquant. Ouvre depuis le cockpit (bouton Liens/QR).", "bad");
  else if(!sess?.ok) show("‚ùå Session manquante. Reconnecte-toi via PIN.", "bad");
  else {
    show("‚úÖ Pr√™t. J‚Äôai tout r√©cup√©r√© via le Guard. (Chargement auto‚Ä¶)", "ok");
    // auto load
    loadLinks();
  }
})();
</script>
</body>
</html>
