<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>DIGIY ‚ôæÔ∏è ‚Äî GO PIN ‚Ä¢ Manage Links</title>
  <meta name="theme-color" content="#0b1020" />

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Guard (pour withSlug + coh√©rence repo) -->
  <script src="./guard.js?v=locpro-final"></script>

  <!-- QR generator (l√©ger + fiable) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <style>
    :root{
      --bg:#020617; --bg2:#0b1020; --card:rgba(255,255,255,.03);
      --line:rgba(148,163,184,.22);
      --ink:#f9fafb; --muted:#cbd5f5;
      --gold:#facc15; --green:#22c55e; --red:#ef4444; --blue:#60a5fa;
      --shadow:0 22px 55px rgba(0,0,0,.55);
      --r:18px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      min-height:100vh;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      color:var(--ink);
      background:
        radial-gradient(900px 520px at 12% -10%, rgba(250,204,21,.16), transparent 60%),
        radial-gradient(900px 520px at 90% 0%, rgba(34,197,94,.12), transparent 60%),
        linear-gradient(180deg, var(--bg2), var(--bg));
      padding:16px;
    }
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1080px;margin:0 auto}
    .top{
      display:flex;justify-content:space-between;gap:12px;align-items:center;flex-wrap:wrap;
      padding:14px;border:1px solid var(--line);border-radius:22px;background:var(--card);
      box-shadow:var(--shadow);
    }
    .brand{display:flex;gap:12px;align-items:center}
    .logo{
      width:46px;height:46px;border-radius:16px;
      background:linear-gradient(135deg, rgba(250,204,21,.35), rgba(34,197,94,.2));
      border:1px solid rgba(250,204,21,.35);
      box-shadow:0 0 22px rgba(250,204,21,.12);
      display:grid;place-items:center;color:#061b14;font-weight:1100;
      user-select:none;
    }
    .h1{font-size:1.05rem;font-weight:1100}
    .sub{color:var(--muted);font-weight:850;margin-top:4px;line-height:1.3}
    .right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{
      border:1px solid rgba(148,163,184,.35);
      padding:7px 10px;border-radius:999px;background:rgba(255,255,255,.02);
      color:var(--muted);font-weight:950;font-size:.86rem;
    }
    .pill.ok{border-color:rgba(34,197,94,.35);color:#bbf7d0;background:rgba(34,197,94,.09)}
    .pill.bad{border-color:rgba(239,68,68,.35);color:#fecaca;background:rgba(239,68,68,.09)}
    .pill.warn{border-color:rgba(250,204,21,.35);color:#fde68a;background:rgba(250,204,21,.09)}
    .btn{
      min-height:42px;border-radius:14px;border:1px solid var(--line);
      background:rgba(255,255,255,.04);color:#fff;font-weight:1100;font-size:14px;
      cursor:pointer;text-decoration:none;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:10px 12px;
    }
    .btn:hover{background:rgba(255,255,255,.07)}
    .btn.primary{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.35)}
    .btn.gold{background:rgba(250,204,21,.10);border-color:rgba(250,204,21,.35)}
    .btn.danger{background:rgba(239,68,68,.10);border-color:rgba(239,68,68,.35)}
    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    @media(max-width:980px){ .grid{grid-template-columns:1fr} }
    .card{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      border-radius:22px;box-shadow:var(--shadow);
      padding:14px;
    }
    .card h2{font-size:1rem;margin:0 0 10px;color:var(--gold);font-weight:1100}
    .field{display:grid;gap:6px;margin-top:10px}
    label{font-size:.85rem;color:rgba(203,213,245,.88);font-weight:950}
    input,select{
      width:100%;
      border-radius:14px;border:1px solid var(--line);
      background:rgba(0,0,0,.18);color:var(--ink);
      padding:12px 12px;font-weight:950;outline:none;
    }
    input:focus,select:focus{border-color:var(--gold);box-shadow:0 0 0 3px rgba(250,204,21,.15)}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;align-items:center}
    .note{
      margin-top:10px;
      padding:10px 12px;border-radius:14px;border:1px solid rgba(148,163,184,.25);
      background:rgba(255,255,255,.03);color:var(--muted);font-weight:900;white-space:pre-wrap;
      display:none;
    }
    .note.ok{display:block;border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.09);color:#bbf7d0}
    .note.bad{display:block;border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.09);color:#fecaca}
    .note.warn{display:block;border-color:rgba(250,204,21,.35);background:rgba(250,204,21,.09);color:#fde68a}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid rgba(148,163,184,.18);padding:10px 8px;text-align:left;vertical-align:top}
    th{color:rgba(203,213,245,.85);font-size:.82rem;text-transform:uppercase}
    td{font-weight:900}
    .muted{color:rgba(203,213,245,.82);font-weight:850}
    .tag{display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border-radius:999px;border:1px solid rgba(148,163,184,.25);background:rgba(255,255,255,.03);font-size:.82rem}
    .qrBox{display:grid;grid-template-columns: 140px 1fr;gap:12px;align-items:center}
    @media(max-width:560px){ .qrBox{grid-template-columns:1fr} }
    canvas{background:#fff;border-radius:14px;padding:10px}
    .small{font-size:.86rem;line-height:1.35;color:rgba(203,213,245,.88);font-weight:850}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo">‚àû</div>
        <div>
          <div class="h1">DIGIY ‚ôæÔ∏è ‚Äî GO PIN</div>
          <div class="sub">Manage Links ‚Ä¢ RLS owner ‚Ä¢ QR export</div>
        </div>
      </div>
      <div class="right">
        <div class="pill" id="pillAuth">Auth : ‚Äî</div>
        <div class="pill" id="pillPin">PIN : ‚Äî</div>
        <button class="btn danger" id="btnLogout" type="button">üö™ Logout</button>
      </div>
    </div>

    <div class="grid">
      <!-- AUTH -->
      <div class="card">
        <h2>Connexion</h2>

        <div class="small">
          Tu peux te connecter en <b>email+mot de passe</b>, ou demander un <b>magic link</b>.<br/>
          <span class="muted">‚ö†Ô∏è Le owner ne voit que ses PINs (RLS).</span>
        </div>

        <div class="field">
          <label>Email</label>
          <input id="email" type="email" placeholder="pro@digiylyfe.com" />
        </div>

        <div class="field">
          <label>Mot de passe (optionnel si magic link)</label>
          <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>

        <div class="row">
          <button class="btn primary" id="btnLogin" type="button">Login</button>
          <button class="btn gold" id="btnMagic" type="button">Envoyer Magic Link</button>
          <button class="btn" id="btnRefreshPins" type="button">‚Üª Rafra√Æchir PINs</button>
        </div>

        <div class="note warn" id="noteAuth"></div>

        <div class="sep" style="height:1px;background:rgba(148,163,184,.18);margin:12px 0"></div>

        <div class="field">
          <label>Choisir un PIN / Lieu (slug)</label>
          <select id="pinSelect">
            <option value="">‚Äî connecte-toi puis choisis ‚Äî</option>
          </select>
        </div>

        <div class="row">
          <a class="btn" id="btnOpenApp" href="#">üè† Ouvrir APP</a>
          <a class="btn" id="btnOpenPublic" href="#">üëÅÔ∏è GO PIN public</a>
          <a class="btn" id="btnOpenPin" href="#">üîë Ouvrir l‚Äôacc√®s (PIN)</a>
        </div>

        <div class="note warn" id="notePins"></div>
      </div>

      <!-- LINKS + QR -->
      <div class="card">
        <h2>GO LINKS</h2>

        <div class="small">
          Ajoute les boutons ‚ÄúCommander / R√©server / Demander course / etc.‚Äù<br/>
          <span class="muted">üëâ Connecte-toi puis choisis un PIN pour g√©rer ses liens.</span>
        </div>

        <div class="field">
          <label>Label</label>
          <input id="linkLabel" placeholder="Commander / R√©server / Voir catalogue" />
        </div>

        <div class="field">
          <label>URL</label>
          <input id="linkUrl" placeholder="https://..." />
        </div>

        <div class="row">
          <div style="flex:1;min-width:160px">
            <label style="display:block;margin:0 0 6px">Ordre (petit = en haut)</label>
            <input id="linkOrder" type="number" value="100" />
          </div>
          <div style="flex:1;min-width:160px">
            <label style="display:block;margin:0 0 6px">Actif</label>
            <select id="linkActive">
              <option value="true">Oui</option>
              <option value="false">Non</option>
            </select>
          </div>
        </div>

        <div class="row">
          <button class="btn primary" id="btnSaveLink" type="button">Enregistrer</button>
          <button class="btn" id="btnNew" type="button">Nouveau</button>
          <button class="btn" id="btnReloadLinks" type="button">‚Üª Recharger</button>
        </div>

        <div class="note warn" id="noteLinks"></div>

        <div class="sep" style="height:1px;background:rgba(148,163,184,.18);margin:12px 0"></div>

        <div class="small"><b>Liste des liens</b></div>
        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>Ordre</th>
                <th>Label</th>
                <th>URL</th>
                <th>Actif</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="linksTbody">
              <tr><td colspan="5" class="muted">‚Äî</td></tr>
            </tbody>
          </table>
        </div>

        <div class="sep" style="height:1px;background:rgba(148,163,184,.18);margin:12px 0"></div>

        <div class="small"><b>QR</b> (pour app / public / acc√®s)</div>
        <div class="qrBox" style="margin-top:10px">
          <canvas id="qrCanvas" width="180" height="180"></canvas>
          <div>
            <div class="tag" id="qrTag">slug: ‚Äî</div>
            <div class="small" style="margin-top:8px" id="qrText">Choisis un PIN pour g√©n√©rer le QR.</div>
            <div class="row" style="margin-top:10px">
              <button class="btn gold" id="btnQRApp" type="button">‚¨áÔ∏è QR APP</button>
              <button class="btn" id="btnQRPublic" type="button">‚¨áÔ∏è QR Public</button>
              <button class="btn" id="btnQRPIN" type="button">‚¨áÔ∏è QR Acc√®s</button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

<script>
(function(){
  "use strict";

  /* =========================
     ‚úÖ CONFIG (ADAPTE ICI SI BESOIN)
  ========================= */
  const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

  const DB = {
    // Table des PINs / lieux visibles par owner (RLS)
    pins: "digiy_go_pins",
    pinId: "id",
    pinSlug: "slug",      // ex: chez-astou-saly
    pinLabel: "label",    // optionnel
    pinActive: "active",  // optionnel

    // Table des liens par PIN (RLS)
    links: "digiy_go_links",
    linkId: "id",
    linkPinId: "pin_id",  // FK vers pins.id
    linkLabel: "label",
    linkUrl: "url",
    linkOrder: "sort_order",
    linkActive: "is_active",
    linkCreated: "created_at",
  };

  const ROUTES = {
    app: "./app.html",
    public: "./go-pin-public.html",
    pin: "./pin.html"
  };

  /* =========================
     DOM
  ========================= */
  const $ = (id)=>document.getElementById(id);
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  function note(elId, msg, kind){
    const el = $(elId);
    el.className = "note " + (kind || "warn");
    el.textContent = msg || "";
    el.style.display = msg ? "block" : "none";
  }

  function withSlug(url, slug){
    try{
      if(window.DIGIY_GUARD && typeof window.DIGIY_GUARD.withSlug === "function"){
        // guard.withSlug prend le slug depuis l‚ÄôURL courante, donc on passe un url d√©j√† ?slug=
        const u = new URL(url, location.href);
        if(slug) u.searchParams.set("slug", slug);
        return u.toString();
      }
    }catch(_){}
    const u = new URL(url, location.href);
    if(slug) u.searchParams.set("slug", slug);
    return u.toString();
  }

  function downloadCanvasPNG(canvas, filename){
    const a = document.createElement("a");
    a.download = filename;
    a.href = canvas.toDataURL("image/png");
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  function boolVal(v){
    if(typeof v === "boolean") return v;
    const s = String(v||"").toLowerCase().trim();
    return s === "true" || s === "1" || s === "yes" || s === "oui";
  }

  /* =========================
     STATE
  ========================= */
  const State = {
    user: null,
    pins: [],
    pinId: null,
    slug: null,
    links: [],
    editLinkId: null
  };

  /* =========================
     AUTH
  ========================= */
  async function refreshAuth(){
    const { data } = await sb.auth.getUser();
    State.user = data?.user || null;
    if(State.user){
      $("pillAuth").className = "pill ok";
      $("pillAuth").textContent = "Auth : ‚úÖ";
    }else{
      $("pillAuth").className = "pill bad";
      $("pillAuth").textContent = "Auth : ‚ùå";
    }
  }

  async function login(){
    note("noteAuth", "", "warn");
    const email = ($("email").value || "").trim();
    const password = ($("password").value || "").trim();
    if(!email) return note("noteAuth", "‚ö†Ô∏è Mets un email.", "warn");

    try{
      if(password){
        const { error } = await sb.auth.signInWithPassword({ email, password });
        if(error) throw error;
        note("noteAuth", "‚úÖ Connect√© (password).", "ok");
      }else{
        await sendMagicLink(true);
        return;
      }
      await refreshAuth();
      await loadPins();
    }catch(e){
      note("noteAuth", "‚ùå " + (e?.message || e), "bad");
    }
  }

  async function sendMagicLink(silent){
    note("noteAuth", "", "warn");
    const email = ($("email").value || "").trim();
    if(!email) return note("noteAuth", "‚ö†Ô∏è Mets un email.", "warn");

    try{
      const emailRedirectTo = location.href.split("#")[0];
      const { error } = await sb.auth.signInWithOtp({
        email,
        options: { emailRedirectTo }
      });
      if(error) throw error;
      if(!silent) note("noteAuth", "‚úÖ Magic link envoy√©. Ouvre ton email puis reviens ici.", "ok");
      else note("noteAuth", "‚úÖ Magic link envoy√© (pas de mdp).", "ok");
    }catch(e){
      note("noteAuth", "‚ùå " + (e?.message || e), "bad");
    }
  }

  async function logout(){
    try{
      await sb.auth.signOut();
    }catch(_){}
    State.user = null;
    State.pins = [];
    State.pinId = null;
    State.slug = null;
    State.links = [];
    renderPins();
    renderLinks();
    renderQR();
    await refreshAuth();
    note("noteAuth", "D√©connect√©.", "warn");
  }

  /* =========================
     PINS (RLS)
  ========================= */
  async function loadPins(){
    note("notePins", "", "warn");

    if(!State.user){
      renderPins();
      return note("notePins", "üëâ Connecte-toi puis choisis un PIN pour g√©rer ses liens.", "warn");
    }

    try{
      const { data, error } = await sb
        .from(DB.pins)
        .select("*")
        .order(DB.pinSlug, { ascending: true })
        .limit(200);

      if(error) throw error;

      State.pins = data || [];
      renderPins();

      if(!State.pins.length){
        note("notePins", "‚ö†Ô∏è Aucun PIN visible (RLS). V√©rifie que ton user est bien owner.", "warn");
      }else{
        note("notePins", "", "warn");
      }
    }catch(e){
      note("notePins", "‚ùå Erreur chargement PINs: " + (e?.message || e), "bad");
    }
  }

  function renderPins(){
    const sel = $("pinSelect");
    sel.innerHTML = `<option value="">‚Äî choisir ‚Äî</option>`;
    State.pins.forEach(p=>{
      const slug = p?.[DB.pinSlug] || "";
      const label = p?.[DB.pinLabel] || slug || "PIN";
      const opt = document.createElement("option");
      opt.value = p?.[DB.pinId];
      opt.textContent = label + (slug ? "  ‚Ä¢  " + slug : "");
      opt.dataset.slug = slug;
      sel.appendChild(opt);
    });

    $("pillPin").className = "pill " + (State.slug ? "ok" : "warn");
    $("pillPin").textContent = "PIN : " + (State.slug || "‚Äî");

    // boutons open
    const slug = State.slug || "";
    $("btnOpenApp").href = slug ? withSlug(ROUTES.app, slug) : "#";
    $("btnOpenPublic").href = slug ? withSlug(ROUTES.public, slug) : "#";
    $("btnOpenPin").href = slug ? withSlug(ROUTES.pin, slug) : "#";
  }

  async function onPinChange(){
    const sel = $("pinSelect");
    const id = sel.value || null;
    const opt = sel.options[sel.selectedIndex];
    const slug = opt?.dataset?.slug || null;

    State.pinId = id;
    State.slug = slug;

    $("pillPin").className = "pill " + (State.slug ? "ok" : "warn");
    $("pillPin").textContent = "PIN : " + (State.slug || "‚Äî");

    // update open buttons
    renderPins();

    // reset link form
    resetLinkForm();

    // load links + QR
    await loadLinks();
    renderQR();
  }

  /* =========================
     LINKS (RLS)
  ========================= */
  async function loadLinks(){
    note("noteLinks", "", "warn");
    if(!State.user){
      renderLinks();
      return note("noteLinks", "‚ö†Ô∏è Connecte-toi d‚Äôabord.", "warn");
    }
    if(!State.pinId){
      renderLinks();
      return note("noteLinks", "üëâ Choisis un PIN pour voir/√©diter ses liens.", "warn");
    }

    try{
      const { data, error } = await sb
        .from(DB.links)
        .select("*")
        .eq(DB.linkPinId, State.pinId)
        .order(DB.linkOrder, { ascending: true })
        .limit(200);

      if(error) throw error;

      State.links = data || [];
      renderLinks();
      note("noteLinks", "", "warn");
    }catch(e){
      note("noteLinks", "‚ùå Erreur chargement liens: " + (e?.message || e), "bad");
    }
  }

  function renderLinks(){
    const tb = $("linksTbody");
    if(!State.links.length){
      tb.innerHTML = `<tr><td colspan="5" class="muted">‚Äî aucun lien ‚Äî</td></tr>`;
      return;
    }
    tb.innerHTML = State.links.map(l=>{
      const id = l?.[DB.linkId];
      const label = l?.[DB.linkLabel] || "‚Äî";
      const url = l?.[DB.linkUrl] || "‚Äî";
      const order = l?.[DB.linkOrder] ?? 100;
      const active = boolVal(l?.[DB.linkActive]);

      return `
        <tr>
          <td>${order}</td>
          <td>${escapeHtml(label)}</td>
          <td style="max-width:340px">
            <div class="muted" style="word-break:break-word">${escapeHtml(url)}</div>
            ${url && url !== "‚Äî" ? `<a class="btn" style="margin-top:8px;min-height:36px;padding:6px 10px" href="${escapeAttr(url)}" target="_blank">üîó Ouvrir</a>` : ``}
          </td>
          <td>${active ? `<span class="tag">‚úÖ Oui</span>` : `<span class="tag">‚õî Non</span>`}</td>
          <td>
            <div class="row">
              <button class="btn" style="min-height:36px;padding:6px 10px" data-edit="${id}">‚úèÔ∏è</button>
              <button class="btn danger" style="min-height:36px;padding:6px 10px" data-del="${id}">üóëÔ∏è</button>
            </div>
          </td>
        </tr>
      `;
    }).join("");

    // bind buttons
    tb.querySelectorAll("[data-edit]").forEach(b=>{
      b.addEventListener("click", ()=> editLink(b.getAttribute("data-edit")));
    });
    tb.querySelectorAll("[data-del]").forEach(b=>{
      b.addEventListener("click", ()=> deleteLink(b.getAttribute("data-del")));
    });
  }

  async function saveLink(){
    note("noteLinks", "", "warn");
    if(!State.user) return note("noteLinks", "‚ö†Ô∏è Connecte-toi d‚Äôabord.", "warn");
    if(!State.pinId) return note("noteLinks", "‚ö†Ô∏è Choisis un PIN.", "warn");

    const label = ($("linkLabel").value || "").trim();
    const url = ($("linkUrl").value || "").trim();
    const order = Number($("linkOrder").value || 100);
    const active = ($("linkActive").value || "true") === "true";

    if(!label) return note("noteLinks", "‚ö†Ô∏è Label obligatoire.", "warn");
    if(!url) return note("noteLinks", "‚ö†Ô∏è URL obligatoire.", "warn");

    try{
      const payload = {
        [DB.linkPinId]: State.pinId,
        [DB.linkLabel]: label,
        [DB.linkUrl]: url,
        [DB.linkOrder]: order,
        [DB.linkActive]: active,
      };

      if(State.editLinkId){
        const { error } = await sb
          .from(DB.links)
          .update(payload)
          .eq(DB.linkId, State.editLinkId)
          .eq(DB.linkPinId, State.pinId);

        if(error) throw error;
        note("noteLinks", "‚úÖ Modifi√©.", "ok");
      }else{
        const { error } = await sb
          .from(DB.links)
          .insert(payload);

        if(error) throw error;
        note("noteLinks", "‚úÖ Enregistr√©.", "ok");
      }

      resetLinkForm();
      await loadLinks();
    }catch(e){
      note("noteLinks", "‚ùå " + (e?.message || e), "bad");
    }
  }

  function resetLinkForm(){
    State.editLinkId = null;
    $("linkLabel").value = "";
    $("linkUrl").value = "";
    $("linkOrder").value = "100";
    $("linkActive").value = "true";
  }

  function editLink(id){
    const l = State.links.find(x => String(x?.[DB.linkId]) === String(id));
    if(!l) return;

    State.editLinkId = id;
    $("linkLabel").value = l?.[DB.linkLabel] || "";
    $("linkUrl").value = l?.[DB.linkUrl] || "";
    $("linkOrder").value = String(l?.[DB.linkOrder] ?? 100);
    $("linkActive").value = boolVal(l?.[DB.linkActive]) ? "true" : "false";

    note("noteLinks", "‚úèÔ∏è Mode √©dition (puis Enregistrer).", "warn");
  }

  async function deleteLink(id){
    if(!confirm("Supprimer ce lien ?")) return;
    try{
      const { error } = await sb
        .from(DB.links)
        .delete()
        .eq(DB.linkId, id)
        .eq(DB.linkPinId, State.pinId);

      if(error) throw error;
      note("noteLinks", "‚úÖ Supprim√©.", "ok");
      await loadLinks();
    }catch(e){
      note("noteLinks", "‚ùå " + (e?.message || e), "bad");
    }
  }

  /* =========================
     QR
  ========================= */
  async function renderQR(){
    const slug = State.slug || "";
    $("qrTag").textContent = "slug: " + (slug || "‚Äî");

    const canvas = $("qrCanvas");
    const ctx = canvas.getContext("2d");
    ctx.clearRect(0,0,canvas.width,canvas.height);

    if(!slug){
      $("qrText").textContent = "Choisis un PIN pour g√©n√©rer le QR.";
      return;
    }

    // Par d√©faut, QR = APP
    const appUrl = withSlug(ROUTES.app, slug);
    $("qrText").textContent = appUrl;

    await QRCode.toCanvas(canvas, appUrl, {
      width: 180,
      margin: 1
    });
  }

  async function qrFor(kind){
    const slug = State.slug || "";
    if(!slug) return note("noteLinks", "‚ö†Ô∏è Choisis un PIN d‚Äôabord.", "warn");

    let url = "";
    let name = "";

    if(kind === "app"){
      url = withSlug(ROUTES.app, slug);
      name = `QR_APP_${slug}.png`;
    }else if(kind === "public"){
      url = withSlug(ROUTES.public, slug);
      name = `QR_PUBLIC_${slug}.png`;
    }else{
      url = withSlug(ROUTES.pin, slug);
      name = `QR_ACCES_${slug}.png`;
    }

    const canvas = document.createElement("canvas");
    canvas.width = 220; canvas.height = 220;
    await QRCode.toCanvas(canvas, url, { width: 220, margin: 1 });
    downloadCanvasPNG(canvas, name);
  }

  /* =========================
     HTML escape
  ========================= */
  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function escapeAttr(s){ return escapeHtml(s); }

  /* =========================
     INIT
  ========================= */
  async function init(){
    $("btnLogin").addEventListener("click", login);
    $("btnMagic").addEventListener("click", ()=>sendMagicLink(false));
    $("btnLogout").addEventListener("click", logout);
    $("btnRefreshPins").addEventListener("click", loadPins);

    $("pinSelect").addEventListener("change", onPinChange);

    $("btnSaveLink").addEventListener("click", saveLink);
    $("btnNew").addEventListener("click", ()=>{ resetLinkForm(); note("noteLinks","", "warn"); });
    $("btnReloadLinks").addEventListener("click", loadLinks);

    $("btnQRApp").addEventListener("click", ()=>qrFor("app"));
    $("btnQRPublic").addEventListener("click", ()=>qrFor("public"));
    $("btnQRPIN").addEventListener("click", ()=>qrFor("pin"));

    // √©coute auth changes
    sb.auth.onAuthStateChange(async ()=>{
      await refreshAuth();
      await loadPins();
    });

    await refreshAuth();
    await loadPins();
    renderLinks();
    renderQR();
  }

  init();
})();
</script>
</body>
</html>
