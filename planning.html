<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DIGIY LOC ‚Ä¢ Planning</title>

  <link rel="stylesheet" href="./ui.css">

  <!-- Fallback minimal (au cas o√π ui.css ne charge pas) -->
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#061b14;color:#eafff1}
    .wrap{max-width:980px;margin:0 auto;padding:14px}
    .card{border:1px solid rgba(255,255,255,.14);border-radius:18px;background:rgba(255,255,255,.05);padding:14px;margin:12px 0}
    .muted{opacity:.8}
    .top{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .btn{cursor:pointer;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.08);color:#eafff1;font-weight:900;border-radius:14px;padding:10px 12px}
    .calendar{margin-top:14px;display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .day{border-radius:14px;padding:14px 0;text-align:center;font-weight:1000;cursor:pointer;user-select:none;border:1px solid rgba(255,255,255,.14)}
    .day.free{background:rgba(34,197,94,.18);color:#7CFFB3}
    .day.booked{background:rgba(249,115,115,.18);color:#FFB4B4}
    .day.closed{background:rgba(148,163,184,.18);color:rgba(234,255,241,.75)}
    .day.off{opacity:.15;border:none;cursor:default}
  </style>

  <!-- Order important -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./guard.js"></script>
</head>

<body>
<div class="wrap">

  <!-- DEBUG / LOADER -->
  <div class="card" id="loading">
    <div class="top">
      <div>
        <div style="font-weight:1000">üß≠ V√©rification acc√®s LOC‚Ä¶</div>
        <div class="muted" id="dbg">Chargement‚Ä¶</div>
      </div>
      <button class="btn" onclick="location.replace('./login.html')">üîê Retour login</button>
    </div>
  </div>

  <!-- APP -->
  <div id="app" style="display:none">
    <div class="card">
      <div class="top">
        <div>
          <div style="font-weight:1000;font-size:18px">üìÖ DIGIY LOC ‚Ä¢ PRO ‚Äî Planning</div>
          <div class="muted">Gestion des disponibilit√©s (UI locale pour l‚Äôinstant)</div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn" onclick="location.href='./index.html'">‚Üê Dashboard</button>
          <button class="btn" onclick="sessionStorage.removeItem('digiy_phone'); sessionStorage.removeItem('digiy_pin_ok'); location.replace('./login.html')">üö™ Logout</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 6px">Calendrier ‚Äî Octobre 2025</h2>
      <div class="muted">Clique sur un jour pour changer son statut.</div>

      <div class="calendar">
        <div class="muted" style="text-align:center;font-weight:900;font-size:12px">Lun</div>
        <div class="muted" style="text-align:center;font-weight:900;font-size:12px">Mar</div>
        <div class="muted" style="text-align:center;font-weight:900;font-size:12px">Mer</div>
        <div class="muted" style="text-align:center;font-weight:900;font-size:12px">Jeu</div>
        <div class="muted" style="text-align:center;font-weight:900;font-size:12px">Ven</div>
        <div class="muted" style="text-align:center;font-weight:900;font-size:12px">Sam</div>
        <div class="muted" style="text-align:center;font-weight:900;font-size:12px">Dim</div>

        <div class="day off"></div>
        <div class="day off"></div>

        <div class="day free">1</div><div class="day booked">2</div><div class="day free">3</div><div class="day free">4</div><div class="day closed">5</div><div class="day free">6</div><div class="day booked">7</div>
        <div class="day free">8</div><div class="day free">9</div><div class="day booked">10</div><div class="day free">11</div><div class="day free">12</div><div class="day closed">13</div><div class="day free">14</div>
        <div class="day free">15</div><div class="day booked">16</div><div class="day free">17</div><div class="day free">18</div><div class="day free">19</div><div class="day closed">20</div><div class="day free">21</div>
        <div class="day free">22</div><div class="day booked">23</div><div class="day free">24</div><div class="day free">25</div><div class="day free">26</div><div class="day closed">27</div><div class="day free">28</div>
        <div class="day free">29</div><div class="day free">30</div><div class="day free">31</div>
      </div>
    </div>
  </div>

</div>

<script>
(function(){
  const dbg = document.getElementById("dbg");
  const loading = document.getElementById("loading");
  const app = document.getElementById("app");

  function show(msg){ dbg.textContent = msg; }

  // erreurs visibles
  window.addEventListener("error",(e)=> show("Erreur JS: " + (e.message || e.type)));
  window.addEventListener("unhandledrejection",(e)=> show("Promise rejet√©e: " + (e.reason?.message || e.reason || "unknown")));

  (async ()=>{
    show("Guard‚Ä¶");
    if(!window.DIGIY_GUARD || !window.DIGIY_GUARD.boot){
      show("DIGIY_GUARD introuvable (guard.js pas charg√© ou mauvais objet).");
      return;
    }

    // boot = prot√®ge (login/pay) puis laisse la page si ok
    await window.DIGIY_GUARD.boot({
      module: "LOC",
      dashboard: "./planning.html",
      login: "./login.html",
      pay: "https://beauville.github.io/commencer-a-payer/"
    });

    // Si boot redirige, on ne passera pas ici.
    show("OK ‚úÖ");
    loading.style.display = "none";
    app.style.display = "block";
  })();
})();
</script>

<script src="./ui.js"></script>
<script>
  // UI calendar toggle
  document.addEventListener("click",(e)=>{
    const d = e.target.closest(".day");
    if(!d || d.classList.contains("off")) return;
    if(d.classList.contains("free")){ d.classList.remove("free"); d.classList.add("booked"); }
    else if(d.classList.contains("booked")){ d.classList.remove("booked"); d.classList.add("closed"); }
    else { d.classList.remove("closed"); d.classList.add("free"); }
  });
</script>
</body>
</html>
