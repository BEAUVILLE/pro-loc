<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>DIGIY LOC ‚Äî GO PIN</title>
<meta name="theme-color" content="#020617">

<style>
  :root{
    --bg:#020617;
    --card:#0b1224;
    --line:rgba(148,163,184,.22);
    --ink:#f9fafb;
    --muted:#9ca3af;
    --accent:#facc15;
    --ok:#22c55e;
    --danger:#fb7185;
  }
  *{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto}
  body{
    min-height:100vh;
    color:var(--ink);
    background:
      radial-gradient(circle at top, rgba(34,197,94,.10) 0, transparent 55%),
      radial-gradient(circle at 15% 85%, rgba(250,204,21,.10) 0, transparent 55%),
      linear-gradient(135deg,#020617,#0b1020);
    display:flex;
    justify-content:center;
    padding:14px;
  }
  .wrap{
    width:100%;
    max-width:980px;
    min-height:calc(100vh - 28px);
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    padding:10px 6px;
  }
  .brand{font-weight:950;font-size:16px;letter-spacing:.06em}
  .brand span{color:var(--accent)}
  .tag{
    font-size:12px;color:var(--muted);
    border:1px solid rgba(148,163,184,.35);
    padding:6px 10px;border-radius:999px;white-space:nowrap;
    background:rgba(2,6,23,.55);
  }
  .card{
    flex:1;
    background:linear-gradient(135deg,rgba(255,255,255,.06),rgba(255,255,255,.02));
    border-radius:18px;
    border:1px solid rgba(250,204,21,.22);
    box-shadow:0 22px 55px rgba(0,0,0,.55);
    padding:16px;
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  .title{
    font-size:20px;
    font-weight:950;
    line-height:1.2;
  }
  .sub{
    font-size:13px;
    color:#cbd5e1;
    line-height:1.5;
  }
  .status{
    display:flex;
    gap:10px;
    align-items:center;
    border:1px solid var(--line);
    background:rgba(2,6,23,.55);
    padding:12px;
    border-radius:14px;
  }
  .dot{
    width:12px;height:12px;border-radius:999px;
    background:var(--accent);
    box-shadow:0 0 16px rgba(250,204,21,.35);
    flex:0 0 auto;
  }
  .statusTxt{display:flex;flex-direction:column;gap:2px}
  .statusBig{font-weight:950}
  .statusSmall{font-size:12px;color:var(--muted)}
  .actions{
    margin-top:auto;
    display:flex;
    flex-wrap:wrap;
    gap:10px;
  }
  .btn{
    border:none;border-radius:999px;padding:11px 14px;
    font-size:14px;font-weight:950;cursor:pointer;
    display:flex;justify-content:center;align-items:center;gap:8px;
    text-decoration:none;
    flex:1;
    min-height:44px;
    white-space:nowrap;
    touch-action:manipulation;
  }
  .btn.ghost{
    background:rgba(15,23,42,.6);
    color:#e5e7eb;
    border:1px solid var(--line);
  }
  .btn.ok{
    background:rgba(34,197,94,.12);
    color:#bbf7d0;
    border:1px solid rgba(34,197,94,.55);
  }
  footer{
    text-align:center;
    color:var(--muted);
    font-size:11px;
    padding:6px 0 2px;
  }
  @media(max-width:520px){
    body{padding:0}
    .wrap{min-height:100vh}
    .card{border-radius:0}
    header{padding:12px}
  }
</style>
</head>

<body>
<div class="wrap">
  <header>
    <div class="brand">DIGIY <span>LOC</span></div>
    <div class="tag">0% commission ¬∑ Paiement direct</div>
  </header>

  <div class="card">
    <div class="title" id="ttl">Ouverture du PIN‚Ä¶</div>
    <div class="sub" id="sub">On v√©rifie le logement et on te redirige automatiquement.</div>

    <div class="status">
      <div class="dot" id="dot"></div>
      <div class="statusTxt">
        <div class="statusBig" id="stBig">Chargement</div>
        <div class="statusSmall" id="stSmall">Merci de patienter 2 secondes‚Ä¶</div>
      </div>
    </div>

    <div class="actions">
      <a class="btn ghost" id="btnBack" href="#" rel="noopener">‚¨ÖÔ∏è Retour galerie</a>
      <button class="btn ok" id="btnWa" type="button">üì≤ Parler √† DIGIY</button>
    </div>
  </div>

  <footer>GO PIN ¬∑ DIGIY LOC ‚ôæÔ∏è</footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
(() => {
  "use strict";
  console.log("GO-PIN VERSION:", "2026-01-21-proid-bridge-FINAL");

  /* =========================
     CONFIG
  ========================= */
  const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
  const SUPABASE_ANON_KEY =
    "COLLE_ICI_TA_CLE_ANON_COMPLETE_SANS_LES_GUILLEMETS_FRANCAIS"; // <-- IMPORTANT

  const GALLERY_URL = "https://beauville.github.io/digiy-loc/";
  const LOC_PRO_URL = "https://beauville.github.io/digiy-loc-pro/";
  const PIN_PAGE    = "https://beauville.github.io/digiy-loc-pro/pin.html";
  const TEAM_WA     = "+221771342889";

  /* =========================
     UI refs
  ========================= */
  const ttl = document.getElementById("ttl");
  const sub = document.getElementById("sub");
  const dot = document.getElementById("dot");
  const stBig = document.getElementById("stBig");
  const stSmall = document.getElementById("stSmall");
  const btnBack = document.getElementById("btnBack");
  const btnWa = document.getElementById("btnWa");
  btnBack.href = GALLERY_URL || LOC_PRO_URL;

  /* =========================
     Helpers
  ========================= */
  function digits(v){ return String(v || "").replace(/\D/g,""); }
  function openWa(phone, msg){
    const d = digits(phone);
    if (!d) return;
    const url = "https://wa.me/" + d + (msg ? "?text=" + encodeURIComponent(msg) : "");
    window.open(url, "_blank", "noopener,noreferrer");
  }

  function setStatus(mode, big, small){
    stBig.textContent = big || "";
    stSmall.textContent = small || "";
    if (mode === "ok"){
      dot.style.background = "var(--ok)";
      dot.style.boxShadow = "0 0 16px rgba(34,197,94,.35)";
    } else if (mode === "err"){
      dot.style.background = "var(--danger)";
      dot.style.boxShadow = "0 0 16px rgba(251,113,133,.35)";
    } else {
      dot.style.background = "var(--accent)";
      dot.style.boxShadow = "0 0 16px rgba(250,204,21,.35)";
    }
  }

  function cleanSlug(s){
    const x = String(s || "").trim();
    if (!x) return "";
    return x.toLowerCase().replace(/[^a-z0-9\-_]/g,"");
  }

  function redirectToPin(slug){
    const url = PIN_PAGE + "?slug=" + encodeURIComponent(slug);
    location.replace(url);
  }

  function safeSet(k,v){
    try{ localStorage.setItem(k, String(v ?? "")); }catch(e){ console.warn("localStorage blocked", e); }
  }

  async function resolveProIdFromSlug(sb, slug){
    const { data, error } = await sb.rpc("resolve_slug_to_pro_id", { p_slug: slug });
    console.log("RPC resolve_slug_to_pro_id =>", { data, error });
    if (error) return { ok:false, error };
    const row = Array.isArray(data) ? data[0] : data;
    return { ok:true, row };
  }

  /* =========================
     Main
  ========================= */
  const rawSlug = new URLSearchParams(location.search).get("slug");
  const slug = cleanSlug(rawSlug);

  btnWa.addEventListener("click", ()=>{
    const msg = slug
      ? `Bonjour DIGIY üëã\nJ‚Äôai un souci pour ouvrir le PIN (${slug}).`
      : `Bonjour DIGIY üëã\nJe n‚Äôarrive pas √† ouvrir un PIN (slug manquant).`;
    openWa(TEAM_WA, msg);
  });

  window.addEventListener("DOMContentLoaded", async () => {
    console.log("ORIGIN", location.origin);
    console.log("SLUG", slug);
    console.log("KEY_LEN", (SUPABASE_ANON_KEY || "").length);

    if (!slug){
      ttl.textContent = "Slug manquant";
      sub.textContent = "Lien incomplet. Reviens √† la galerie et clique sur ‚ÄúVoir le PIN‚Äù.";
      setStatus("err","Lien incomplet","Exemple : go-pin.html?slug=chez-astou-saly");
      return;
    }

    if (!SUPABASE_ANON_KEY || (SUPABASE_ANON_KEY || "").length < 80){
      ttl.textContent = "Cl√© Supabase absente";
      sub.textContent = "Tu dois coller la cl√© ANON compl√®te dans le fichier go-pin.html.";
      setStatus("err","Config invalide","ANON KEY manquante ou tronqu√©e.");
      return;
    }

    setStatus("warn","Connexion‚Ä¶","Initialisation Supabase‚Ä¶");

    let sb;
    try{
      sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }catch(e){
      ttl.textContent = "Erreur Supabase";
      sub.textContent = "Supabase non charg√©. V√©rifie le script CDN.";
      setStatus("err","Supabase KO","CDN/cl√©/JS.");
      return;
    }

    // Gate public pin (safe)
    setStatus("warn","V√©rification logement","Lecture go_pins‚Ä¶");
    const r = await sb
      .from("go_pins")
      .select("slug,title,is_public,is_active,category")
      .eq("slug", slug)
      .maybeSingle();

    console.log("go_pins result =>", r);

    if (r.error){
      ttl.textContent = "Erreur lecture";
      sub.textContent = "La lecture go_pins a √©chou√© (RLS/cl√©).";
      setStatus("err","Lecture refus√©e", r.error.message || "Erreur");
      return;
    }

    if (!r.data){
      ttl.textContent = "PIN introuvable";
      sub.textContent = "Aucune ligne trouv√©e pour ce slug.";
      setStatus("err","Introuvable","Slug KO ou RLS filtre.");
      return;
    }

    const pin = r.data;
    const title = pin.title || pin.slug;

    if (pin.category && String(pin.category).toLowerCase() !== "loc"){
      ttl.textContent = "PIN non compatible";
      sub.textContent = "Ce PIN n‚Äôest pas un logement (cat√©gorie diff√©rente).";
      setStatus("err","Cat√©gorie diff√©rente","Retour galerie.");
      return;
    }

    if (!pin.is_active){
      ttl.textContent = title;
      sub.textContent = "Ce logement est en pause pour le moment.";
      setStatus("err","Logement inactif","Retour galerie ou contacte DIGIY.");
      return;
    }

    // Bridge slug -> pro_id (OBLIGATOIRE pour la porte)
    setStatus("warn","Pr√©paration acc√®s PRO","Bridge slug ‚Üí pro_id‚Ä¶");
    const brid = await resolveProIdFromSlug(sb, slug);

    if (!brid.ok || !brid.row?.pro_id){
      ttl.textContent = title;
      sub.textContent = "Acc√®s public OK, mais pro_id introuvable (guard/caisse bloqu√©s).";
      setStatus("err","Bridge pro_id KO","V√©rifie GRANT/SECURITY DEFINER du RPC.");
      return;
    }

    safeSet("DIGIY_PRO_ID", brid.row.pro_id);
    safeSet("DIGIY_SLUG", slug);
    safeSet("DIGIY_TITLE", title);
    safeSet("DIGIY_BUSINESS_NAME", brid.row.business_name || "");
    safeSet("DIGIY_PHONE", brid.row.phone || "");

    console.log("‚úÖ STORED DIGIY_PRO_ID =", localStorage.getItem("DIGIY_PRO_ID"));

    // Private -> pro
    if (!pin.is_public){
      ttl.textContent = title;
      sub.textContent = "Ce PIN est r√©serv√© (acc√®s propri√©taire).";
      setStatus("warn","Acc√®s propri√©taire","Redirection vers l‚Äôespace PRO‚Ä¶");
      setTimeout(()=> location.replace(LOC_PRO_URL), 900);
      return;
    }

    // Public -> pin
    ttl.textContent = title;
    sub.textContent = "Acc√®s public OK + pro_id OK. Redirection‚Ä¶";
    setStatus("ok","Acc√®s valid√©","On t‚Äôouvre la fiche PIN maintenant.");
    setTimeout(()=> redirectToPin(slug), 2500);
  });
})();
</script>
</body>
</html>
