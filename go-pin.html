<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>DIGIY ‚Äî GO PIN</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
/* =========================
   DESIGN SIMPLE & PRO (terrain)
========================= */
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  background:#020617;
  color:#f9fafb;
}
.app{
  max-width:900px;
  margin:0 auto;
  padding:14px;
}
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:12px;
}
.brand{
  font-weight:900;
  font-size:18px;
}
.brand span{color:#facc15}
.tag{
  font-size:12px;
  color:#9ca3af;
}

.hero{
  background:#020617;
  border:1px solid #1f2937;
  border-radius:18px;
  padding:14px;
  margin-bottom:14px;
}
.hero h1{
  margin:0 0 6px;
  font-size:22px;
}
.hero p{
  margin:0 0 10px;
  font-size:14px;
  color:#cbd5f5;
}
.hero img{
  width:100%;
  max-height:240px;
  object-fit:cover;
  border-radius:14px;
  border:1px solid #1f2937;
  display:none;
}

.price-block{
  margin-top:12px;
  padding:12px;
  border-radius:14px;
  border:1px solid #1f2937;
}
.price-block h2{
  margin:0 0 6px;
  font-size:16px;
  color:#facc15;
}
.tarifs span{
  display:flex;
  justify-content:space-between;
  font-size:14px;
  margin-bottom:4px;
}

.wave{
  margin-top:12px;
  padding:14px;
  border-radius:16px;
  border:2px solid #22c55e;
  background:#022c22;
}
.wave .num{
  font-size:24px;
  font-weight:900;
  color:#22c55e;
}

.cta{
  display:flex;
  gap:10px;
  margin-top:14px;
  flex-wrap:wrap;
}
.btn{
  flex:1;
  padding:12px;
  border-radius:999px;
  border:none;
  font-size:15px;
  font-weight:800;
  cursor:pointer;
}
.btn-wa{background:#22c55e;color:#022c22}
.btn-call{background:#111827;color:#e5e7eb;border:1px solid #1f2937}

footer{
  margin-top:18px;
  text-align:center;
  font-size:12px;
  color:#9ca3af;
}
</style>
</head>

<body>
<div class="app">

  <header>
    <div class="brand" id="brandTitle">DIGIY LOC</div>
    <div class="tag" id="tagLine">‚Äî</div>
  </header>

  <section class="hero">
    <h1 id="heroTitle">‚Äî</h1>
    <p id="heroDesc">‚Äî</p>

    <img id="heroPhoto" src="" alt="Photo du logement">

    <div class="price-block">
      <h2>Tarifs</h2>
      <div class="tarifs">
        <span><span>Nuit :</span><strong id="priceNight">Sur demande</strong></span>
        <span><span>Semaine :</span><strong id="priceWeek">Sur demande</strong></span>
        <span><span>Mois :</span><strong id="priceMonth">Sur demande</strong></span>
      </div>
    </div>

    <div class="wave">
      üí≥ Paiement direct propri√©taire ‚Äî Wave
      <div class="num" id="wavePhone">‚Äî</div>
      <div style="margin-top:6px">
        Propri√©taire : <strong id="ownerName">‚Äî</strong>
      </div>
      <div class="tag" id="ownerPhoneTxt" style="margin-top:6px">‚Äî</div>
    </div>

    <div class="cta">
      <button class="btn btn-wa" id="btnWa">üí¨ R√©server par WhatsApp</button>
      <button class="btn btn-call" id="btnCall">üìû Appeler le propri√©taire</button>
    </div>
  </section>

  <footer id="footerTxt">DIGIY LOC ‚ôæÔ∏è</footer>

</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
(() => {
  const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

  // Helpers
  const pick = (o, keys, d=null) => {
    for (const k of keys) {
      if (o && o[k] !== null && o[k] !== undefined && o[k] !== "") return o[k];
    }
    return d;
  };
  const digits = (v) => (v ?? "").toString().replace(/\D/g,"");

  const money = (v) => {
    const n = Number(v);
    if (Number.isFinite(n) && n > 0) return n.toLocaleString("fr-FR") + " F";
    // si c‚Äôest d√©j√† un texte genre "30 000" ou "sur demande"
    if (typeof v === "string" && v.trim()) {
      const d = v.replace(/[^\d]/g,"");
      if (d) return Number(d).toLocaleString("fr-FR") + " F";
      return v;
    }
    return "Sur demande";
  };

  const slug = new URLSearchParams(window.location.search).get("slug");
  if (!slug) {
    alert("Slug manquant. Exemple : go-pin.html?slug=chez-astou-saly");
    return;
  }

  window.addEventListener("DOMContentLoaded", async () => {
    try {
      if (!window.supabase || !window.supabase.createClient) {
        alert("Supabase CDN non charg√©. V√©rifie la connexion / cache.");
        return;
      }

      // ‚úÖ pas de variable 'supabase' => pas de collision
      const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const { data, error } = await sb
        .from("go_pins")
        .select("*")
        .eq("slug", slug)
        .single();

      if (error || !data) {
        alert("Lieu introuvable (slug ou droits).");
        console.error(error);
        return;
      }

      // ===== Mapping (tol√©rant + variantes FR)
      const title = pick(data, ["title","name","label","nom","titre"], "DIGIY LOC");
      const city  = pick(data, ["city","ville","location","localite"], "");
      const desc  = pick(data, ["description","desc","about","resume"], "");

      const maxGuests = pick(data, ["max_guests","guests","capacity","capacite"], "");

      const photo = pick(data, ["photo_url","cover_url","image_url","photo","img","image"], null);

      // PRIX: toutes variantes terrain
      const pNight = pick(data, [
        "price_night","night_price","prix_nuit","tarif_nuit","nuit",
        "price_per_night","tarif_jour","prix_jour"
      ], null);

      const pWeek = pick(data, [
        "price_week","week_price","prix_semaine","tarif_semaine","semaine",
        "price_per_week"
      ], null);

      const pMonth = pick(data, [
        "price_month","month_price","prix_mois","tarif_mois","mois",
        "price_per_month"
      ], null);

      // NOM proprio: variantes
      const ownerName = pick(data, [
        "owner_name","owner_full_name","proprietaire","proprietaire_nom","nom_proprio",
        "contact_name","contact_nom","host_name"
      ], "Propri√©taire");

      // T√©l√©phone / WhatsApp / Wave: variantes
      const ownerPhoneRaw = pick(data, [
        "owner_phone","phone","telephone","tel","contact_phone","contact_tel","host_phone"
      ], "");

      const ownerWaRaw = pick(data, [
        "owner_whatsapp","whatsapp","wa","contact_whatsapp","contact_wa","host_whatsapp"
      ], ownerPhoneRaw);

      const wavePhoneRaw = pick(data, [
        "wave_phone","wave","payment_wave","paiement_wave","wave_tel"
      ], ownerPhoneRaw);

      // ===== Injection UI
      document.title = `${title} ‚Äî DIGIY LOC`;
      document.getElementById("brandTitle").textContent = title;
      document.getElementById("heroTitle").textContent = `${title}${city ? " ‚Äî " + city : ""}`;
      document.getElementById("heroDesc").textContent = desc || "";

      const tagParts = [];
      if (city) tagParts.push(city);
      if (maxGuests) tagParts.push(`${maxGuests} pers max`);
      document.getElementById("tagLine").textContent = tagParts.join(" ¬∑ ") || "‚Äî";

      const img = document.getElementById("heroPhoto");
      if (photo) {
        img.src = photo;
        img.style.display = "block";
      } else {
        img.style.display = "none";
      }

      document.getElementById("priceNight").textContent = money(pNight);
      document.getElementById("priceWeek").textContent  = money(pWeek);
      document.getElementById("priceMonth").textContent = money(pMonth);

      document.getElementById("wavePhone").textContent = wavePhoneRaw ? wavePhoneRaw : "‚Äî";
      document.getElementById("ownerName").textContent = ownerName ? ownerName : "Propri√©taire";
      document.getElementById("ownerPhoneTxt").textContent =
        ownerPhoneRaw ? `üìû ${ownerPhoneRaw}` : "‚Äî";

      // CTA
      const ownerPhoneDigits = digits(ownerPhoneRaw);
      const ownerWaDigits = digits(ownerWaRaw);

      document.getElementById("btnCall").onclick = () => {
        if (ownerPhoneDigits) window.location.href = "tel:" + ownerPhoneDigits;
      };

      document.getElementById("btnWa").onclick = () => {
        if (!ownerWaDigits) return;
        const msg = `Bonjour, je souhaite r√©server ${title}${city ? " √† " + city : ""}.`;
        window.open(`https://wa.me/${ownerWaDigits}?text=${encodeURIComponent(msg)}`, "_blank");
      };

      document.getElementById("footerTxt").textContent =
        `${title} ¬∑ DIGIY LOC ¬∑ ${ownerPhoneRaw || ""}`;

    } catch (e) {
      console.error(e);
      alert("Erreur JS : " + (e && e.message ? e.message : e));
    }
  });
})();
</script>
</body>
</html>
