<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>DIGIY ‚ôæÔ∏è ‚Äî GO PIN</title>
  <meta name="theme-color" content="#064e3b"/>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg0:#02130f;
      --bg1:#022c22;
      --bg2:#065f46;

      --card:rgba(6,95,70,.26);
      --glass:rgba(2,44,34,.35);
      --line:rgba(148,163,184,.24);

      --text:#ecfdf5;
      --muted:rgba(236,253,245,.74);

      --gold:#facc15;
      --gold2:#f59e0b;
      --ok:#22c55e;
      --bad:#ef4444;

      --shadow:0 22px 60px rgba(0,0,0,.55);
      --radius:22px;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 520px at 15% -10%, rgba(250,204,21,.14), transparent 60%),
        radial-gradient(900px 520px at 90% 10%, rgba(34,197,94,.12), transparent 60%),
        radial-gradient(700px 420px at 30% 90%, rgba(245,158,11,.10), transparent 60%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
      padding:16px;
      -webkit-font-smoothing: antialiased;
      -webkit-text-size-adjust: 100%;
    }

    /* ‚úÖ iOS touch safe */
    *{ -webkit-tap-highlight-color: transparent; }
    a,button{ touch-action: manipulation; }
    body::before, body::after, .fx, .overlay, .glow { pointer-events:none !important; }
    .wrap, .top, .card, .btnRow, .btn, .pill, .cta { position:relative; z-index:2; }

    .wrap{max-width:560px;margin:0 auto;padding:4px}

    .top{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      padding:12px 12px;
    }

    .brand{
      display:flex;align-items:center;gap:10px;min-width:0;
    }
    .logo{
      width:44px;height:44px;border-radius:16px;
      background:linear-gradient(135deg, rgba(250,204,21,.28), rgba(34,197,94,.14));
      border:1px solid rgba(250,204,21,.35);
      box-shadow:0 0 24px rgba(250,204,21,.12);
      display:grid;place-items:center;
      font-weight:1100;color:#062e22;
    }
    .brandTxt{min-width:0}
    .brandTitle{
      font-weight:1100;
      font-size:18px;
      letter-spacing:.04em;
      line-height:1.1;
      white-space:nowrap;
      overflow:hidden;text-overflow:ellipsis;
    }
    .brandSub{
      margin-top:3px;
      font-size:12px;
      color:var(--muted);
      font-weight:900;
    }

    .pill{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      padding:9px 12px;
      border-radius:999px;
      font-weight:1000;
      font-size:12px;
      color:var(--muted);
      display:inline-flex;gap:8px;align-items:center;
      max-width:100%;
    }
    .pill strong{color:#fff}
    .pill.tag{
      background:rgba(250,204,21,.12);
      border-color:rgba(250,204,21,.30);
      color:#fff;
    }

    .card{
      margin-top:8px;
      border-radius:var(--radius);
      border:1px solid rgba(148,163,184,.18);
      background:linear-gradient(180deg, rgba(2,44,34,.42), rgba(2,44,34,.20));
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .cardInner{padding:16px}

    .title{
      font-size:34px;
      font-weight:1200;
      letter-spacing:-.02em;
      line-height:1.05;
    }
    .meta{
      margin-top:8px;
      color:var(--muted);
      font-weight:900;
      font-size:15px;
    }

    .pinRow{
      margin-top:14px;
      display:flex;align-items:center;gap:12px;flex-wrap:wrap;
    }
    .pinLabel{
      color:var(--muted);
      font-weight:1000;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-size:12px;
    }
    .pinBox{
      display:inline-flex;align-items:center;justify-content:center;
      min-height:54px;
      padding:12px 16px;
      border-radius:16px;
      border:1px solid rgba(250,204,21,.35);
      background:rgba(250,204,21,.10);
      color:#fff;
      font-weight:1200;
      font-size:26px;
      letter-spacing:.18em;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .btnRow{margin-top:14px;display:flex;flex-direction:column;gap:12px}

    .btn{
      width:100%;
      min-height:56px;
      border-radius:18px;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(255,255,255,.04);
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      color:#fff;
      font-weight:1100;
      font-size:18px;
      display:flex;align-items:center;justify-content:center;gap:12px;
      text-decoration:none;
      user-select:none;
      cursor:pointer;
      transform: translateZ(0);
      -webkit-transform: translateZ(0);
    }
    .btn:active{transform:scale(.99)}
    .btn.primary{
      border-color:rgba(34,197,94,.35);
      background:rgba(34,197,94,.10);
    }
    .btn.gold{
      border-color:rgba(250,204,21,.35);
      background:rgba(250,204,21,.12);
    }
    .btn.disabled{
      opacity:.45;
      filter:saturate(.7);
      cursor:not-allowed;
      pointer-events:none;
    }
    .btn .ico{
      width:30px;height:30px;border-radius:999px;
      display:grid;place-items:center;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(148,163,184,.18);
      font-size:16px;
    }

    .footer{
      margin-top:14px;
      padding:14px 16px;
      border-top:1px solid rgba(148,163,184,.14);
      background:rgba(0,0,0,.12);
      color:rgba(236,253,245,.70);
      font-weight:900;
      text-align:center;
      letter-spacing:.02em;
    }

    .status{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      font-weight:1000;
      font-size:13px;
      white-space:pre-wrap;
      display:none;
    }
    .status.ok{display:block;border-color:rgba(34,197,94,.30);background:rgba(34,197,94,.10);color:#bbf7d0}
    .status.bad{display:block;border-color:rgba(239,68,68,.30);background:rgba(239,68,68,.10);color:#fecaca}
    .status.warn{display:block;border-color:rgba(250,204,21,.30);background:rgba(250,204,21,.10);color:#fde68a}

    @media (max-width:420px){
      body{padding:12px}
      .title{font-size:30px}
      .btn{min-height:54px;font-size:17px}
      .pinBox{font-size:24px;min-height:52px}
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="top">
      <div class="brand">
        <div class="logo">‚àû</div>
        <div class="brandTxt">
          <div class="brandTitle">DIGIY ‚ôæÔ∏è ‚Äî GO PIN</div>
          <div class="brandSub">Terrain ‚Ä¢ Rapide ‚Ä¢ Direct</div>
        </div>
      </div>

      <div class="pill tag" id="pillSlug">
        slug: <strong id="pillSlugVal">‚Äî</strong>
      </div>
    </div>

    <div class="card">
      <div class="cardInner">
        <div class="title" id="tTitle">‚Äî</div>
        <div class="meta">Cat√©gorie: <strong id="tCat">‚Äî</strong></div>

        <div class="pinRow">
          <div class="pinLabel">PIN</div>
          <div class="pinBox" id="tPin">‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
        </div>

        <div class="btnRow">
          <a class="btn primary disabled" id="btnCall" href="#">
            <span class="ico">üìû</span>
            Appeler
          </a>

          <a class="btn primary disabled" id="btnWA" href="#">
            <span class="ico">üí¨</span>
            WhatsApp
          </a>

          <a class="btn gold disabled" id="btnMap" href="#" target="_blank" rel="noopener">
            <span class="ico">üìç</span>
            Itin√©raire
          </a>

          <button class="btn" id="btnShare" type="button">
            <span class="ico">üîó</span>
            Partager
          </button>
        </div>

        <div class="status warn" id="status"></div>
      </div>

      <div class="footer">0% commission ‚Ä¢ Contact direct ‚Ä¢ DIGIYLYFE</div>
    </div>
  </div>

  <script>
    /* =============================
       CONFIG
    ============================= */

    // ‚úÖ Supabase (client anon)
    const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

    // ‚úÖ RPC recommand√©e (RLS ON)
    // Mets ici le nom EXACT de ta fonction si diff√©rent :
    const RPC_NAME = "go_pin_get_by_slug";

    const SB = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* =============================
       HELPERS
    ============================= */
    const $ = (id)=>document.getElementById(id);

    function setDisabled(id, on){
      const el = $(id);
      if(!el) return;
      el.classList.toggle("disabled", !!on);
      if(el.tagName === "A"){
        el.setAttribute("aria-disabled", on ? "true" : "false");
      }else{
        el.disabled = !!on;
      }
    }

    function showStatus(msg, cls){
      const el = $("status");
      const text = String(msg || "").trim();
      if(!text){
        el.textContent = "";
        el.style.display = "none";
        el.className = "status";
        return;
      }
      el.className = "status " + (cls || "warn");
      el.textContent = text;
      el.style.display = "block";
    }

    function normPhone(p){
      let s = String(p||"").trim();
      if(!s) return "";
      s = s.replace(/[^\d+]/g,"");
      if(s.startsWith("00")) s = "+" + s.slice(2);
      if(s.startsWith("221") && !s.startsWith("+221")) s = "+221" + s.slice(3);
      if(/^\d{9}$/.test(s)) s = "+221" + s;
      return s;
    }

    function waLink(phone, text){
      const num = String(phone||"").replace(/[^\d]/g,"");
      return "https://wa.me/" + num + (text ? ("?text=" + encodeURIComponent(text)) : "");
    }

    function isIOS(){
      return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    }

    function mapsLink(lat, lng, label){
      const q = (label ? label : (lat + "," + lng));
      if(isIOS()){
        return "https://maps.apple.com/?q=" + encodeURIComponent(q) + "&ll=" + encodeURIComponent(lat + "," + lng);
      }
      return "https://www.google.com/maps?q=" + encodeURIComponent(q) + "&ll=" + encodeURIComponent(lat + "," + lng);
    }

    async function copyText(txt){
      try{
        await navigator.clipboard.writeText(txt);
        return true;
      }catch(_){
        try{
          const ta = document.createElement("textarea");
          ta.value = txt;
          ta.setAttribute("readonly", "");
          ta.style.position = "fixed";
          ta.style.top = "-9999px";
          document.body.appendChild(ta);
          ta.select();
          const ok = document.execCommand("copy");
          ta.remove();
          return ok;
        }catch(__){
          return false;
        }
      }
    }

    /* =============================
       SLUG
    ============================= */
    const url = new URL(location.href);
    const slug = (url.searchParams.get("slug") || "").trim();

    $("pillSlugVal").textContent = slug || "‚Äî";

    if(!slug){
      showStatus("GO PIN introuvable ou inactif.\n‚û°Ô∏è Il manque ?slug=.... dans l‚ÄôURL", "bad");
    }

    /* =============================
       LOAD GO PIN (RPC -> fallback table)
    ============================= */
    async function loadGoPin(){
      if(!slug) return;

      showStatus("‚è≥ Chargement‚Ä¶", "warn");

      // 1) RPC (id√©al si RLS)
      try{
        const { data, error } = await SB.rpc(RPC_NAME, { p_slug: slug });
        if(!error && data){
          // data peut √™tre objet, tableau, ou JSON string
          let out = data;
          if(typeof out === "string"){
            try{ out = JSON.parse(out); }catch(_){}
          }
          if(Array.isArray(out)) out = out[0];

          if(out?.ok === false){
            throw new Error(out.reason || "NOT_FOUND");
          }

          const pin = out?.pin_code || out?.pin || out?.code || "0000";

          return renderGoPin({
            slug: out.slug || slug,
            title: out.title || "‚Äî",
            category: out.category || "‚Äî",
            phone: out.phone || out.whatsapp || "",
            whatsapp: out.whatsapp || out.phone || "",
            lat: out.lat ?? null,
            lng: out.lng ?? null,
            pin_code: pin
          });
        }
      }catch(e){
        // continue vers fallback
      }

      // 2) Fallback direct table (si RLS permet select)
      try{
        const { data, error } = await SB
          .from("go_pins")
          .select("slug,title,category,phone,whatsapp,lat,lng,pin_code,is_active")
          .eq("slug", slug)
          .eq("is_active", true)
          .limit(1)
          .maybeSingle();

        if(error) throw error;
        if(!data) throw new Error("NOT_FOUND");
        return renderGoPin(data);
      }catch(err){
        console.error(err);
        showStatus(
          "‚ùå GO PIN introuvable ou non autoris√©.\n" +
          "‚û°Ô∏è V√©rifie: slug, is_active=true, et/ou RPC.\n" +
          "D√©tail: " + (err?.message || err),
          "bad"
        );
      }
    }

    /* =============================
       RENDER + ACTIONS (iPhone safe)
    ============================= */
    function renderGoPin(p){
      const title = p.title || "‚Äî";
      const cat = p.category || "‚Äî";
      const rawPin = String(p.pin_code || "0000").trim();
      const pin = rawPin.replace(/\s+/g,"").slice(0,8);

      const phone = normPhone(p.phone);
      const wa = normPhone(p.whatsapp || p.phone);

      $("tTitle").textContent = title;
      $("tCat").textContent = cat;
      $("tPin").textContent = (pin || "0000").padStart(4,"0");

      // Call
      if(phone){
        $("btnCall").href = "tel:" + phone.replace(/\s/g,"");
        setDisabled("btnCall", false);
      }else{
        $("btnCall").href = "#";
        setDisabled("btnCall", true);
      }

      // WhatsApp
      if(wa){
        const msg = `DIGIY ‚Ä¢ ${title}\nSalut, je viens via DIGIY.`;
        $("btnWA").href = waLink(wa, msg);
        setDisabled("btnWA", false);
      }else{
        $("btnWA").href = "#";
        setDisabled("btnWA", true);
      }

      // Map
      const hasMap = Number.isFinite(+p.lat) && Number.isFinite(+p.lng);
      if(hasMap){
        $("btnMap").href = mapsLink(+p.lat, +p.lng, title);
        setDisabled("btnMap", false);
      }else{
        $("btnMap").href = "#";
        setDisabled("btnMap", true);
      }

      // Share
      $("btnShare").onclick = async ()=>{
        const shareUrl = location.origin + location.pathname + "?slug=" + encodeURIComponent(p.slug || slug);
        const txt = `DIGIY ‚Ä¢ ${title}\nCat√©gorie: ${cat}\nPIN: ${pin || "0000"}\n`;

        try{
          if(navigator.share){
            await navigator.share({ title: `DIGIY ‚Ä¢ ${title}`, text: txt, url: shareUrl });
            return;
          }
          const ok = await copyText(shareUrl);
          showStatus(ok ? "‚úÖ Lien copi√©." : "‚ö†Ô∏è Copie impossible sur ce navigateur.", ok ? "ok" : "warn");
          setTimeout(()=>showStatus("", ""), 900);
        }catch(e){
          // si l‚Äôutilisateur annule, on ne crie pas
          console.log(e);
        }
      };

      showStatus("‚úÖ Pr√™t. Touch OK.", "ok");
    }

    loadGoPin();
  </script>
</body>
</html>

