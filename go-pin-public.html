<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>DIGIY GO PIN ‚ôæÔ∏è ‚Äî Fiche publique</title>
  <meta name="theme-color" content="#0b1020"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#020617; --bg2:#0b1020; --line:#1f2937;
      --ink:#f9fafb; --muted:#cbd5f5;
      --gold:#facc15; --green:#22c55e; --danger:#ef4444;
      --shadow:0 22px 50px rgba(0,0,0,.55);
      --card:rgba(255,255,255,.03);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      min-height:100vh;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      color:var(--ink);
      background:
        radial-gradient(900px 520px at 12% -10%, rgba(250,204,21,.16), transparent 60%),
        radial-gradient(900px 520px at 90% 0%, rgba(34,197,94,.12), transparent 60%),
        linear-gradient(180deg, var(--bg2), var(--bg));
      padding:16px;
    }
    a{color:inherit;text-decoration:none}
    .wrap{max-width:900px;margin:0 auto}
    .top{
      display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap;
      padding:12px;border:1px solid var(--line);border-radius:18px;background:var(--card);
      box-shadow:var(--shadow);
    }
    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:46px;height:46px;border-radius:16px;
      background:linear-gradient(135deg, rgba(250,204,21,.35), rgba(34,197,94,.2));
      border:1px solid rgba(250,204,21,.35);
      box-shadow:0 0 22px rgba(250,204,21,.12);
      display:grid;place-items:center;color:#061b14;font-weight:1100;
    }
    h1{font-size:1.15rem;margin:0}
    .sub{color:var(--muted);font-weight:800;margin-top:4px;line-height:1.35}
    .pill{
      border:1px solid rgba(148,163,184,.35);
      padding:7px 10px;border-radius:999px;background:rgba(255,255,255,.02);
      color:var(--muted);font-weight:900;font-size:.86rem;
    }
    .pill.ok{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.10);color:#bbf7d0}
    .pill.warn{border-color:rgba(250,204,21,.35);background:rgba(250,204,21,.10);color:#fde68a}
    .grid{display:grid;grid-template-columns:1.15fr .85fr;gap:14px;margin-top:14px}
    @media (max-width:900px){ .grid{grid-template-columns:1fr} }
    .card{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      border-radius:20px;box-shadow:var(--shadow);
      overflow:hidden;
    }
    .head{
      padding:12px 14px;border-bottom:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.01));
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
    }
    .head b{font-size:1rem}
    .body{padding:14px}
    .hero{
      border:1px solid rgba(148,163,184,.22);
      background:rgba(255,255,255,.02);
      border-radius:18px;
      padding:12px;
    }
    .title{font-weight:1100;font-size:1.25rem}
    .meta{color:var(--muted);font-weight:850;margin-top:6px;line-height:1.4}
    .tags{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .tag{
      display:inline-flex;align-items:center;gap:7px;
      padding:6px 9px;border-radius:999px;
      border:1px solid rgba(148,163,184,.25);
      color:var(--muted);font-weight:950;font-size:.82rem;
      background:rgba(255,255,255,.02);
    }
    .tag.dot::before{content:"";width:9px;height:9px;border-radius:99px;background:#94a3b8;display:inline-block}
    .tag.live{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.10);color:#bbf7d0}
    .tag.live.dot::before{background:var(--green);box-shadow:0 0 10px rgba(34,197,94,.75)}
    .tag.nd{border-color:rgba(250,204,21,.35);background:rgba(250,204,21,.10);color:#fde68a}
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{
      flex:1;min-width:180px;
      border-radius:16px;border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:#fff;font-weight:1100;font-size:16px;
      padding:12px 12px;
      cursor:pointer;text-align:center;
      transition:.2s ease;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
    }
    .btn:hover{filter:brightness(1.08);transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn.whats{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.35)}
    .btn.call{background:rgba(250,204,21,.10);border-color:rgba(250,204,21,.35)}
    .btn.loc{background:rgba(255,255,255,.03)}
    .btn.pay{background:rgba(34,197,94,.10);border-color:rgba(34,197,94,.35)}
    .btn.declare{background:rgba(250,204,21,.10);border-color:rgba(250,204,21,.35)}
    .box{
      border:1px solid rgba(148,163,184,.22);
      background:rgba(255,255,255,.02);
      border-radius:18px;
      padding:12px;
    }
    .kv{display:grid;grid-template-columns:120px 1fr;gap:10px;margin-top:8px}
    .k{color:var(--muted);font-weight:950;font-size:.9rem}
    .v{font-weight:950;word-break:break-word}
    .note{
      margin-top:12px;padding:10px 12px;border-radius:14px;border:1px solid rgba(148,163,184,.25);
      background:rgba(255,255,255,.03);color:var(--muted);font-weight:900;white-space:pre-wrap;display:none;
    }
    .note.ok{display:block;border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.09);color:#bbf7d0}
    .note.bad{display:block;border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.09);color:#fecaca}
    .note.warn{display:block;border-color:rgba(250,204,21,.35);background:rgba(250,204,21,.09);color:#fde68a}
    .footer{
      margin-top:14px;
      padding:10px 12px;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(255,255,255,.02);
      border-radius:16px;
      display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;
      color:var(--muted);
      font-weight:850;font-size:.9rem;
    }
    code{background:rgba(0,0,0,.25);padding:2px 6px;border-radius:10px;border:1px solid rgba(148,163,184,.18)}
    .small{font-size:.9rem;color:var(--muted);font-weight:850;line-height:1.4}
    input{
      width:100%;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(0,0,0,.18);
      color:var(--ink);
      border-radius:14px;
      padding:11px 12px;
      font-weight:900;
      outline:none;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo">‚àû</div>
        <div>
          <h1>DIGIY GO PIN ‚Äî Fiche publique</h1>
          <div class="sub">Lien officiel du lieu ‚Ä¢ Contact direct ‚Ä¢ Paiement Wave ‚Ä¢ 0% commission</div>
        </div>
      </div>
      <div class="pill" id="pillSlug">slug: ‚Äî</div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="head">
          <b>üìç Le lieu</b>
          <span class="pill" id="pillStatus">‚è≥ Chargement‚Ä¶</span>
        </div>
        <div class="body">
          <div class="hero">
            <div class="title" id="tTitle">‚Äî</div>
            <div class="meta" id="tMeta">‚Äî</div>

            <div class="tags" id="tagsRow">
              <span class="tag dot live" id="tCat">Cat√©gorie</span>
              <span class="tag" id="tPhone">üìû ‚Äî</span>
              <span class="tag" id="tWhats">üí¨ ‚Äî</span>
            </div>

            <div class="btnRow">
              <a class="btn whats" id="btnWhats" href="#" target="_blank" rel="noopener">üí¨ WhatsApp</a>
              <a class="btn call" id="btnCall" href="#">üìû Appeler</a>
              <a class="btn loc" id="btnLoc" href="#">üè° Galerie</a>
            </div>

            <div class="note warn" id="note"></div>
          </div>

          <div class="box" style="margin-top:12px">
            <div style="font-weight:1100">üí≥ Paiement Wave (direct propri√©taire)</div>
            <div class="small" style="margin-top:6px">
              DIGIY ne touche pas l‚Äôargent. Paiement direct au propri√©taire.
            </div>

            <div class="kv">
              <div class="k">Wave</div><div class="v" id="waveNum">‚Äî</div>
              <div class="k">Montant</div><div class="v"><input id="amount" inputmode="numeric" placeholder="ex: 30000"></div>
            </div>

            <div class="btnRow" style="margin-top:10px">
              <a class="btn pay" id="btnPay" href="#" target="_blank" rel="noopener">üí≥ Ouvrir Wave</a>
              <button class="btn declare" id="btnDeclare" type="button">‚úÖ J‚Äôai pay√© (d√©clarer)</button>
            </div>

            <div class="small" style="margin-top:8px">
              Astuce : apr√®s paiement, clique <b>‚ÄúJ‚Äôai pay√©‚Äù</b> pour que le propri√©taire voie ton paiement dans son cockpit.
            </div>
          </div>

          <div class="box" style="margin-top:12px">
            <div style="font-weight:1100">üîó Partage</div>
            <div class="small" style="margin-top:6px">
              Copie ce lien et envoie-le sur WhatsApp / SMS. Le QR peut pointer ici.
            </div>
            <div class="kv">
              <div class="k">Lien</div>
              <div class="v"><code id="shareUrl">‚Äî</code></div>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="head">
          <b>üßæ Infos</b>
          <span class="pill">Public</span>
        </div>
        <div class="body">
          <div class="box">
            <div style="font-weight:1100">üß© D√©tails</div>
            <div class="kv">
              <div class="k">Slug</div><div class="v" id="dSlug">‚Äî</div>
              <div class="k">Titre</div><div class="v" id="dTitle">‚Äî</div>
              <div class="k">Cat√©gorie</div><div class="v" id="dCat">‚Äî</div>
              <div class="k">T√©l√©phone</div><div class="v" id="dPhone">‚Äî</div>
              <div class="k">WhatsApp</div><div class="v" id="dWhats">‚Äî</div>
            </div>
          </div>

          <div class="box" style="margin-top:12px">
            <div style="font-weight:1100">üîê Propri√©taire</div>
            <div class="small" style="margin-top:6px">
              Acc√®s r√©serv√© au propri√©taire du lieu.
            </div>
            <a class="btn" id="btnPin" href="#" style="display:block;margin-top:10px">
              üîê Ouvrir le cockpit (PIN)
            </a>
          </div>

          <div class="box" style="margin-top:12px">
            <div style="font-weight:1100">üåô NDIMBAL</div>
            <div class="small" style="margin-top:6px">
              Si activ√© sur le logement, tu verras un badge NDIMBAL (bonus).
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      <div>¬© DIGIYLYFE ‚ôæÔ∏è ‚Äî Paiement direct, 0% commission.</div>
      <div>Astuce : ajoute <code>?slug=ton-lieu</code> √† l‚ÄôURL.</div>
    </div>
  </div>

<script>
(function(){
  "use strict";

  // ========== SUPABASE ==========
  const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";
  const SB = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const $ = (id)=>document.getElementById(id);

  function setNote(msg, cls){
    const el = $("note");
    el.className = "note " + (cls || "warn");
    el.textContent = msg || "";
    el.style.display = msg ? "block" : "none";
  }

  function digitsOnly(p){ return String(p||"").replace(/\D/g,""); }

  function normPhone(p){
    p = String(p||"").trim().replace(/\s+/g,"").replace(/[^\d+]/g,"");
    if (p.startsWith("00221")) p = "+221" + p.slice(5);
    if (!p.startsWith("+") && p.startsWith("221")) p = "+" + p;
    if (!p.startsWith("+221") && /^\d{9}$/.test(p)) p = "+221" + p;
    return p;
  }

  // slug
  const u = new URL(location.href);
  const SLUG = (u.searchParams.get("slug") || "").trim().replace(/\/+$/,"").toLowerCase();
  $("pillSlug").textContent = "slug: " + (SLUG || "‚Äî");

  function withSlug(path){
    if(!SLUG) return path;
    const x = new URL(path, location.href);
    if(!x.searchParams.get("slug")) x.searchParams.set("slug", SLUG);
    return x.toString();
  }

  // liens internes repo
  $("btnLoc").href = withSlug("./index.html");  // Galerie
  $("btnPin").href = withSlug("./pin.html");

  async function load(){
    $("shareUrl").textContent = location.href;

    if(!SLUG){
      $("pillStatus").textContent = "‚ùå Slug manquant";
      setNote("‚ö†Ô∏è Il manque le slug.\n‚û°Ô∏è Exemple: go-pin.html?slug=chez-astou-saly", "bad");
      return;
    }

    $("pillStatus").textContent = "‚è≥ V√©rification‚Ä¶";
    setNote("‚è≥ Chargement du GO PIN‚Ä¶", "warn");

    try{
      const { data, error } = await SB
        .from("go_pins")
        .select("slug,title,category,phone,whatsapp,address_label,ndimbal_enabled,is_public,is_active")
        .eq("slug", SLUG)
        .eq("is_public", true)
        .eq("is_active", true)
        .single();

      if(error) throw error;

      const title = data.title || "Lieu DIGIY";
      const cat = (data.category || "loc").toString();
      const phone = normPhone(data.phone || "");
      const whats = normPhone(data.whatsapp || data.phone || "");
      const nd = (data.ndimbal_enabled === true);

      $("pillStatus").textContent = "‚úÖ En ligne";
      setNote("", "");

      $("tTitle").textContent = title;
      $("tMeta").textContent = data.address_label ? ("üìå " + data.address_label) : "üìå Lieu v√©rifi√© ‚Äî contact direct";

      $("tCat").textContent = "üè∑Ô∏è " + cat.toUpperCase();
      $("tPhone").textContent = "üìû " + (phone || "‚Äî");
      $("tWhats").textContent = "üí¨ " + (whats || "‚Äî");

      $("dSlug").textContent = SLUG;
      $("dTitle").textContent = title;
      $("dCat").textContent = cat.toUpperCase();
      $("dPhone").textContent = phone || "‚Äî";
      $("dWhats").textContent = whats || "‚Äî";

      // Badge NDIMBAL
      if(nd){
        const tagsRow = $("tagsRow");
        const ndSpan = document.createElement("span");
        ndSpan.className = "tag nd";
        ndSpan.textContent = "ü§ç NDIMBAL LOC ¬∑ 1‚Üí2 ‚Ä¢ 2‚Üí3";
        tagsRow.appendChild(ndSpan);
        setNote("ü§ç NDIMBAL activ√© ‚Äî bonus +1 nuit : 1‚Üí2 ‚Ä¢ 2‚Üí3", "ok");
      }

      // Actions WA/CALL
      const waMsg = `Bonjour ${title} üëã\nJe viens via DIGIY. Je veux des infos / r√©server.`;
      $("btnWhats").href = whats ? ("https://wa.me/" + digitsOnly(whats) + "?text=" + encodeURIComponent(waMsg)) : "#";
      $("btnCall").href  = phone ? ("tel:" + digitsOnly(phone)) : "#";
      if(!whats) $("btnWhats").style.opacity = 0.6;
      if(!phone) $("btnCall").style.opacity = 0.6;

      // Share canonique
      const share = new URL(location.href);
      share.searchParams.set("slug", SLUG);
      $("shareUrl").textContent = share.toString();

      // ===== WAVE =====
      const wavePhone = phone || whats || "";
      $("waveNum").textContent = wavePhone ? wavePhone : "‚Äî";

      // "Ouvrir Wave" => on met un lien WhatsApp fallback si pas Wave deep link
      // (Wave n'a pas toujours un sch√©ma universel web)
      const waveHint = wavePhone ? digitsOnly(wavePhone) : "";
      $("btnPay").href = waveHint
        ? ("https://wa.me/" + waveHint + "?text=" + encodeURIComponent(`Bonjour üëã Je vais effectuer un paiement Wave pour "${title}".`))
        : "#";

      // Declare (client) -> RPC declare (owner_phone = phone du go_pin)
      $("btnDeclare").onclick = async ()=>{
        const amtRaw = $("amount").value || "";
        const amt = parseInt(String(amtRaw).replace(/\D/g,""), 10);

        if(!amt || amt <= 0){
          setNote("‚ö†Ô∏è Mets un montant (ex: 30000) puis clique ‚ÄúJ‚Äôai pay√©‚Äù.", "warn");
          return;
        }

        if(!phone){
          setNote("‚ùå Ce GO PIN n‚Äôa pas de t√©l√©phone propri√©taire (champ phone).", "bad");
          return;
        }

        // Infos client (l√©ger)
        const clientName = prompt("Ton nom (optionnel) :") || "";
        const clientPhone = prompt("Ton t√©l√©phone (optionnel) :") || "";

        setNote("‚è≥ D√©claration du paiement‚Ä¶", "warn");

        try{
          const { data: r, error: e } = await SB.rpc("loc_wave_payment_declare", {
            p_slug: SLUG,
            p_owner_phone: phone,          // IMPORTANT: ownership = go_pins.phone
            p_amount: amt,
            p_client_name: clientName,
            p_client_phone: clientPhone,
            p_note: `D√©clar√© depuis GO PIN public`,
            p_proof_url: null
          });
          if(e) throw e;
          if(!r || r.ok !== true) throw new Error(r?.reason || "declare_failed");

          setNote("‚úÖ Paiement d√©clar√© ! Le propri√©taire le voit dans son cockpit.", "ok");
        }catch(err){
          setNote("‚ùå D√©claration impossible.\nD√©tail: " + (err?.message || err), "bad");
        }
      };

    }catch(e){
      console.error(e);
      $("pillStatus").textContent = "‚ö†Ô∏è Erreur";
      setNote("‚ùå Impossible de charger le GO PIN.\nD√©tail: " + (e?.message || e), "bad");
    }
  }

  load();
})();
</script>
</body>
</html>
