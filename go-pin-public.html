<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>DIGIY LOC ‚Äî GO PIN (ULTRA)</title>
<meta name="theme-color" content="#020617">

<style>
  :root{
    --bg:#020617;
    --card:#0b1224;
    --line:#1f2937;
    --ink:#f9fafb;
    --muted:#9ca3af;
    --accent:#facc15;
    --ok:#22c55e;
    --danger:#ef4444;
    --soft:rgba(255,255,255,.04);
    --shadow:0 20px 45px rgba(0,0,0,.55);
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{
    min-height:100vh;
    font-family:system-ui,-apple-system,Segoe UI,Roboto;
    color:var(--ink);
    background:
      radial-gradient(circle at top, rgba(34,197,94,.10) 0, transparent 55%),
      radial-gradient(circle at 15% 85%, rgba(250,204,21,.10) 0, transparent 55%),
      linear-gradient(135deg,#020617,#0b1020);
  }
  .app{max-width:980px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column}
  header{padding:14px 16px;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
  .brand{font-weight:950;font-size:18px}
  .brand span{color:var(--accent)}
  .tag{font-size:12px;color:var(--muted);border:1px solid rgba(148,163,184,.35);padding:6px 10px;border-radius:999px;white-space:nowrap}
  main{flex:1;padding:0 12px 16px}

  .hero{
    background:linear-gradient(135deg,rgba(255,255,255,.06),rgba(255,255,255,.02));
    border-radius:18px;
    padding:16px;
    border:1px solid rgba(250,204,21,.25);
    box-shadow:var(--shadow);
    display:grid;
    grid-template-columns:minmax(0,1.3fr) minmax(0,1fr);
    gap:16px;
    align-items:flex-start;
  }
  @media(max-width:900px){.hero{grid-template-columns:1fr}}
  .hero h1{font-size:22px;margin:0 0 6px}
  .hero p{font-size:13px;color:#cbd5e1;line-height:1.45;margin:0 0 10px}

  .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
  .chip{font-size:11px;color:#cbd5e1;border:1px solid rgba(148,163,184,.35);padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.02)}

  .hero-media{margin-top:10px}
  .hero-photo{
    width:100%;
    max-height:230px;
    border-radius:14px;
    object-fit:cover;
    display:block;
    border:1px solid var(--line);
    background:#0b1224;
  }
  .hero-caption{margin-top:6px;font-size:11px;color:var(--muted);display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .mini{font-size:11px;color:var(--muted);padding:6px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.25);background:rgba(255,255,255,.02)}
  .miniBtn{
    border:1px solid rgba(148,163,184,.25);
    background:rgba(255,255,255,.03);
    color:#e5e7eb;
    border-radius:999px;
    padding:7px 10px;
    font-weight:950;
    cursor:pointer;
    display:inline-flex;gap:7px;align-items:center;
  }
  .miniBtn:hover{filter:brightness(1.08)}

  .price-block{
    background:rgba(0,0,0,.18);
    border-radius:14px;
    border:1px solid var(--line);
    padding:10px 12px;
    font-size:13px;
  }
  .price-block h2{margin:0 0 6px;font-size:14px;color:var(--accent)}
  .tarifs{display:flex;flex-direction:column;gap:6px}
  .tarifs span{display:flex;justify-content:space-between;gap:10px}
  .tarifs strong{color:#e5e7eb}

  .wave-card{
    margin-top:12px;
    padding:14px;
    border-radius:16px;
    background:rgba(34,197,94,.08);
    border:2px solid rgba(34,197,94,.85);
    box-shadow:0 0 18px rgba(34,197,94,.20);
  }
  .wave-top{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
  .wave-title{font-size:16px;font-weight:950}
  .wave-num{font-size:22px;font-weight:950;color:var(--ok);letter-spacing:.3px}
  .wave-note{margin-top:6px;font-size:12px;color:#bbf7d0;line-height:1.4}
  .owner-line{margin-top:8px;font-size:13px;color:#e5e7eb}
  .owner-line strong{color:#fff}

  .cta-col{display:flex;flex-direction:column;gap:10px;margin-top:12px}
  .btn{
    border:none;border-radius:999px;padding:11px 12px;
    font-size:14px;font-weight:900;cursor:pointer;
    display:flex;justify-content:center;align-items:center;gap:8px;
    text-decoration:none;
  }
  .btn-wa{background:var(--ok);color:#052e16}
  .btn-call{background:#111827;color:#e5e7eb;border:1px solid var(--line)}
  .btn-partner{background:#0f172a;color:#e5e7eb;border:1px solid rgba(148,163,184,.35)}
  .btn-video{background:#0f172a;color:#e5e7eb;border:1px solid rgba(148,163,184,.35);display:none}
  .btn-pay{background:rgba(250,204,21,.14);border:1px solid rgba(250,204,21,.35);color:#fde68a}
  .btn-ghost{background:rgba(255,255,255,.03);border:1px solid rgba(148,163,184,.25);color:#e5e7eb}

  .payBox{
    margin-top:12px;
    border-radius:16px;
    border:1px solid rgba(148,163,184,.25);
    background:rgba(255,255,255,.03);
    padding:12px;
  }
  .payBox h3{margin:0;font-size:13px;color:#e5e7eb}
  .payBox p{margin:6px 0 0;font-size:12px;color:var(--muted);line-height:1.45}
  .payRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .payRow input{
    flex:1;min-width:160px;
    padding:10px 12px;border-radius:12px;
    border:1px solid rgba(148,163,184,.25);
    background:rgba(2,6,23,.65);
    color:#fff;font-weight:900;outline:none;
  }

  .note{
    margin-top:10px;
    padding:10px 12px;border-radius:14px;
    border:1px solid rgba(148,163,184,.25);
    background:rgba(255,255,255,.03);
    color:var(--muted);
    white-space:pre-wrap;
    display:none;
    font-size:12px;
    line-height:1.4;
  }
  .note.ok{display:block;border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.09);color:#bbf7d0}
  .note.bad{display:block;border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.09);color:#fecaca}
  .note.warn{display:block;border-color:rgba(250,204,21,.35);background:rgba(250,204,21,.09);color:#fde68a}

  .ndBox{
    margin-top:12px;
    padding:12px;
    border-radius:16px;
    border:1px solid rgba(250,204,21,.35);
    background:rgba(250,204,21,.08);
  }
  .ndTitle{font-size:13px;font-weight:950;color:#fde68a}
  .ndTxt{margin-top:6px;font-size:12px;color:#e5e7eb;line-height:1.45}

  footer{padding:10px 14px 14px;font-size:11px;color:var(--muted);text-align:center}

  /* ===== MODAL ===== */
  .overlay{
    position:fixed;inset:0;
    background:rgba(0,0,0,.55);
    display:none;
    align-items:center;
    justify-content:center;
    padding:14px;
    z-index:9999;
  }
  .overlay.show{display:flex}
  .modal{
    width:100%;
    max-width:540px;
    border-radius:18px;
    border:1px solid rgba(148,163,184,.25);
    background:linear-gradient(135deg, rgba(2,6,23,.92), rgba(2,8,24,.92));
    box-shadow:0 30px 80px rgba(0,0,0,.65);
    overflow:hidden;
  }
  .mTop{
    padding:14px;
    border-bottom:1px solid rgba(148,163,184,.18);
    display:flex;justify-content:space-between;gap:10px;align-items:flex-start;
    background:
      radial-gradient(circle at 0% 0%, rgba(250,204,21,.14), transparent 55%),
      radial-gradient(circle at 100% 100%, rgba(34,197,94,.12), transparent 50%),
      rgba(2,6,23,.65);
  }
  .mTitle{font-weight:1100;color:#fde68a}
  .mSub{margin-top:6px;color:#e5e7eb;font-weight:650;font-size:13px;line-height:1.45}
  .mClose{
    border-radius:999px;
    padding:8px 10px;
    border:1px solid rgba(148,163,184,.22);
    background:rgba(15,23,42,.55);
    color:#e5e7eb;
    font-weight:950;
    cursor:pointer;
    white-space:nowrap;
  }
  .mBody{padding:14px}
  .mBody .row{display:flex;gap:10px;flex-wrap:wrap}
  .mBody input, .mBody textarea{
    width:100%;
    padding:10px 12px;border-radius:12px;
    border:1px solid rgba(148,163,184,.25);
    background:rgba(2,6,23,.65);
    color:#fff;font-weight:900;outline:none;
  }
  .mBody textarea{min-height:86px;resize:vertical;font-weight:750}
  .mActions{
    padding:12px 14px;
    border-top:1px solid rgba(148,163,184,.18);
    background:rgba(2,6,23,.55);
    display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;
  }
  .mBtn{
    border-radius:999px;
    padding:10px 12px;
    font-weight:950;
    cursor:pointer;
    border:1px solid rgba(148,163,184,.22);
    background:rgba(15,23,42,.55);
    color:#e5e7eb;
  }
  .mBtn.gold{border-color:rgba(250,204,21,.35);background:rgba(250,204,21,.12);color:#fde68a}
  .mBtn.green{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.12);color:#bbf7d0}

  @media(max-width:720px){
    header{padding:12px}
  }
</style>
</head>

<body>
<div class="app">
  <header>
    <div class="brand" id="brandTop">DIGIY <span>LOC</span></div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <div class="tag" id="tagTop">0% commission ¬∑ Paiement direct</div>
      <button class="miniBtn" id="btnCopyLink" type="button">üîó Copier le lien</button>
    </div>
  </header>

  <main>
    <section class="hero">
      <!-- gauche -->
      <div>
        <h1 id="title">‚Äî</h1>
        <p id="desc">‚Äî</p>

        <div class="chips" id="chips"></div>

        <div class="hero-media">
          <img id="photo" class="hero-photo" src="" alt="Photo du logement">
          <div class="hero-caption">
            <span class="mini" id="caption">‚Äî</span>
            <button class="miniBtn" id="btnCopyWave" type="button">üìã Copier Wave</button>
          </div>
        </div>

        <div class="ndBox" id="ndBox" style="display:none">
          <div class="ndTitle">üåô NDIMBAL ‚Äî nuits offertes (Lun‚ÜíJeu)</div>
          <div class="ndTxt">
            Offre locale : <b>2 nuits pay√©es = 3·µâ offerte</b> (selon disponibilit√©).<br>
            Tu restes +1 nuit ‚Üí tu fais vivre le quartier (restos, taxis, march√©‚Ä¶).
          </div>
          <div style="margin-top:10px">
            <button class="btn btn-ghost" id="btnNdimbal" type="button">üåô D√©tails NDIMBAL</button>
          </div>
        </div>
      </div>

      <!-- droite -->
      <div>
        <div class="price-block">
          <h2>Tarifs</h2>
          <div class="tarifs">
            <span><span>Nuit :</span><strong id="pNight">Sur demande</strong></span>
            <span><span>Semaine :</span><strong id="pWeek">Sur demande</strong></span>
            <span><span>Mois :</span><strong id="pMonth">Sur demande</strong></span>
          </div>
          <div style="margin-top:8px;font-size:11px;color:var(--muted)" id="notes">Contact direct ¬∑ Paiement Wave ¬∑ 0% commission</div>
        </div>

        <div class="wave-card">
          <div class="wave-top">
            <div class="wave-title">üí≥ Paiement direct propri√©taire ‚Äî Wave</div>
            <button class="miniBtn" id="btnCopyWave2" type="button">üìã Copier</button>
          </div>
          <div class="wave-num" id="wave">‚Äî</div>
          <div class="wave-note" id="waveNote">‚úî √Ä coller dans votre application Wave</div>
          <div class="owner-line">Propri√©taire : <strong id="ownerName">‚Äî</strong></div>
          <div class="owner-line" style="color:var(--muted)" id="ownerPhone">‚Äî</div>
        </div>

        <div class="payBox">
          <h3>‚úÖ Apr√®s paiement Wave</h3>
          <p>
            Si tu as pay√©, d√©clare le montant ici. √áa aide le propri√©taire √† confirmer vite.
            (DIGIY ne prend pas l‚Äôargent.)
          </p>

          <div class="payRow">
            <input id="cName" placeholder="Ton nom (optionnel)" autocomplete="name">
            <input id="cPhone" placeholder="Ton t√©l√©phone (optionnel)" autocomplete="tel">
          </div>
          <div class="payRow">
            <input id="cAmt" placeholder="Montant pay√© (FCFA) ex: 30000" inputmode="numeric">
            <input id="cNote" placeholder="Note (optionnel) ex: acompte / solde">
          </div>

          <div class="payRow" style="margin-top:12px">
            <button class="btn btn-pay" id="btnPaid" type="button">üíõ D√©clarer mon paiement</button>
          </div>

          <div class="note" id="payNote"></div>
        </div>

        <div class="cta-col">
          <button class="btn btn-wa" id="btnWa">üí¨ R√©server par WhatsApp</button>
          <button class="btn btn-call" id="btnCall">üìû Appeler le propri√©taire</button>
          <button class="btn btn-partner" id="btnPartner">üìÑ Fiche partenaire (d√©tails + vid√©o)</button>
          <button class="btn btn-video" id="btnVideo">üé• Voir la vid√©o</button>
        </div>

        <div class="tag" style="margin-top:10px">
          ‚úÖ Contact direct ¬∑ üí≥ Wave ¬∑ üîí Acc√®s propri√©taire (PIN)
        </div>
      </div>
    </section>
  </main>

  <footer id="foot">DIGIY LOC ‚ôæÔ∏è</footer>
</div>

<!-- MODAL NDIMBAL -->
<div class="overlay" id="ndOverlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="NDIMBAL">
    <div class="mTop">
      <div>
        <div class="mTitle">üåô NDIMBAL ‚Äî le pouvoir des nuits offertes</div>
        <div class="mSub">
          Tu restes +1 nuit ‚Üí tu consommes +1 jour dans le quartier (retomb√©es).<br>
          R√®gle simple : <b>2 nuits pay√©es = 3·µâ offerte</b> (Lun‚ÜíJeu).
        </div>
      </div>
      <button class="mClose" type="button" id="ndClose">‚úï Fermer</button>
    </div>
    <div class="mBody">
      <div class="mSub" style="margin:0">
        ‚úÖ Comment faire :
        <div style="margin-top:8px;line-height:1.55">
          1) Choisis tes dates<br>
          2) √âcris au propri√©taire sur WhatsApp<br>
          3) Dis : <b>‚ÄúJe veux profiter de NDIMBAL‚Äù</b>
        </div>
      </div>
    </div>
    <div class="mActions">
      <button class="mBtn gold" type="button" id="ndOk">‚úÖ J‚Äôai compris</button>
      <button class="mBtn green" type="button" id="ndTalk">üí¨ Parler √† DIGIY</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
(() => {
  /* =========================
     SUPABASE
  ========================= */
  const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const FALLBACK_PHOTO = "https://digiylyfe.com/wp-content/uploads/2025/06/042-BAPTISTE.png";

  // RPC (Option A ‚Äî phone-only)
  const RPC_DECL = "loc_wave_payment_declare";

  // contact digiy
  const TEAM_WA = "+221771342889";

  const pick = (o, keys, d=null) => {
    for (const k of keys) if (o && o[k] !== null && o[k] !== undefined && o[k] !== "") return o[k];
    return d;
  };
  const digits = (v) => (v ?? "").toString().replace(/\D/g,"");
  const money = (v) => {
    const n = Number(v);
    if (Number.isFinite(n) && n > 0) return n.toLocaleString("fr-FR") + " F";
    if (typeof v === "string" && v.trim()) {
      const d = v.replace(/[^\d]/g,"");
      if (d) return Number(d).toLocaleString("fr-FR") + " F";
      return v;
    }
    return "Sur demande";
  };

  const showPayNote = (msg, cls) => {
    const el = document.getElementById("payNote");
    el.className = "note " + (cls || "warn");
    el.textContent = msg || "";
    el.style.display = msg ? "block" : "none";
  };

  async function copyText(txt){
    try{
      await navigator.clipboard.writeText(txt);
      return true;
    }catch(_){
      // fallback
      const ta = document.createElement("textarea");
      ta.value = txt;
      ta.style.position="fixed";
      ta.style.opacity="0";
      document.body.appendChild(ta);
      ta.select();
      try{ document.execCommand("copy"); }catch(e){}
      document.body.removeChild(ta);
      return true;
    }
  }

  const slug = new URLSearchParams(location.search).get("slug");
  if (!slug) { alert("Slug manquant. Exemple: go-pin.html?slug=chez-astou-saly"); return; }

  // state
  let OWNER_WAVE = "";
  let OWNER_PHONE = "";
  let OWNER_NAME = "";
  let CITY = "";
  let TITLE = "";
  let IS_NDIMBAL = false;

  function waLink(phone, message){
    const d = digits(phone);
    if(!d) return "#";
    return "https://wa.me/" + d + (message ? "?text=" + encodeURIComponent(message) : "");
  }

  // NDIMBAL modal
  const ndOverlay = document.getElementById("ndOverlay");
  const openNd = ()=>{ ndOverlay.classList.add("show"); ndOverlay.setAttribute("aria-hidden","false"); };
  const closeNd = ()=>{ ndOverlay.classList.remove("show"); ndOverlay.setAttribute("aria-hidden","true"); };

  document.getElementById("ndClose").onclick = closeNd;
  document.getElementById("ndOk").onclick = closeNd;
  ndOverlay.addEventListener("click",(e)=>{ if(e.target===ndOverlay) closeNd(); });
  document.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closeNd(); });

  document.getElementById("ndTalk").onclick = ()=>{
    const m = `Bonjour DIGIY üëã\nJe veux en savoir plus sur NDIMBAL LOC (2 nuits pay√©es = 3·µâ offerte Lun‚ÜíJeu).`;
    window.open(waLink(TEAM_WA, m), "_blank", "noopener,noreferrer");
  };

  // Copy link
  document.getElementById("btnCopyLink").addEventListener("click", async ()=>{
    const ok = await copyText(location.href);
    const btn = document.getElementById("btnCopyLink");
    const old = btn.textContent;
    btn.textContent = ok ? "‚úÖ Lien copi√©" : "‚ö†Ô∏è Copie manuelle";
    setTimeout(()=>btn.textContent=old, 1200);
  });

  // Copy wave (buttons wired later)
  async function copyWave(){
    if(!OWNER_WAVE) return;
    const ok = await copyText(OWNER_WAVE);
    const b1 = document.getElementById("btnCopyWave");
    const b2 = document.getElementById("btnCopyWave2");
    const old1 = b1.textContent, old2 = b2.textContent;
    b1.textContent = ok ? "‚úÖ Copi√©" : "‚ö†Ô∏è";
    b2.textContent = ok ? "‚úÖ Copi√©" : "‚ö†Ô∏è";
    setTimeout(()=>{ b1.textContent=old1; b2.textContent=old2; }, 1200);
  }
  document.getElementById("btnCopyWave").addEventListener("click", copyWave);
  document.getElementById("btnCopyWave2").addEventListener("click", copyWave);

  window.addEventListener("DOMContentLoaded", async () => {
    const { data, error } = await sb.from("go_pins").select("*").eq("slug", slug).single();
    if (error || !data) { alert("Lieu introuvable."); console.error(error); return; }

    const title = pick(data, ["title","name","label","nom","titre"], "DIGIY LOC");
    const city  = pick(data, ["address_label","city","ville","location","localite"], "");
    const desc  = pick(data, ["description","desc","about","resume"], "");
    const notes = pick(data, ["notes","note","details","infos"], "Contact direct ¬∑ Paiement Wave ¬∑ 0% commission");

    const maxGuests = pick(data, ["max_guests","guests","capacity","capacite"], "");
    const photo = pick(data, ["photo_url","cover_url","image_url","photo","img","image"], null);
    const video = pick(data, ["video_url","video","video_link","tour_video","youtube","drive_video"], null);

    const pNight = pick(data, ["price_night","night_price","prix_nuit","tarif_nuit","nuit","price_per_night","prix"], null);
    const pWeek  = pick(data, ["price_week","week_price","prix_semaine","tarif_semaine","semaine","price_per_week"], null);
    const pMonth = pick(data, ["price_month","month_price","prix_mois","tarif_mois","mois","price_per_month"], null);

    const ownerName = pick(data, ["owner_name","owner_full_name","proprietaire","proprietaire_nom","nom_proprio","contact_name","contact_nom","host_name"], "Propri√©taire");
    const ownerPhoneRaw = pick(data, ["owner_phone","phone","telephone","tel","call_phone","phone_call","contact_phone","contact_tel","host_phone"], "");
    const ownerWaRaw    = pick(data, ["owner_whatsapp","whatsapp","wa","whatsapp_phone","wa_phone","contact_whatsapp","contact_wa","host_whatsapp"], ownerPhoneRaw);
    const waveRaw       = pick(data, ["wave_phone","wave","payment_wave","paiement_wave","wave_tel"], ownerPhoneRaw);
    const partnerUrl    = pick(data, ["partner_url","partner_link","partner_page_url","public_url","fiche_url"], null);
    const ndEnabled     = (pick(data, ["ndimbal_enabled","ndimbal","ndimbal_loc"], false) === true);

    const phoneDigits = digits(ownerPhoneRaw);
    const waDigits = digits(ownerWaRaw);

    // save state
    OWNER_WAVE = waveRaw || ownerPhoneRaw || "";
    OWNER_PHONE = ownerPhoneRaw || "";
    OWNER_NAME = ownerName || "Propri√©taire";
    CITY = city || "";
    TITLE = title || "DIGIY LOC";
    IS_NDIMBAL = !!ndEnabled;

    // UI
    document.title = `${title} ‚Äî DIGIY LOC`;
    document.getElementById("brandTop").innerHTML = `${title} ‚Äî <span>LOC</span>`;
    document.getElementById("title").textContent = `${title}${city ? " ‚Äî " + city : ""}`;
    document.getElementById("desc").textContent = desc || "";
    document.getElementById("notes").textContent = notes || "";

    // Chips
    const chips = [];
    if (maxGuests) chips.push(`${maxGuests} pers max`);
    chips.push("0% commission");
    chips.push("Paiement Wave");
    chips.push("WhatsApp direct");
    if (ndEnabled) chips.push("NDIMBAL üåô");
    document.getElementById("chips").innerHTML = chips.map(t => `<span class="chip">${t}</span>`).join("");

    // Photo
    const img = document.getElementById("photo");
    img.src = (photo && photo !== "‚Äî") ? photo : FALLBACK_PHOTO;
    img.onerror = () => { img.onerror=null; img.src = FALLBACK_PHOTO; };
    document.getElementById("caption").textContent = `Lieu: ${slug}`;

    // Prices
    document.getElementById("pNight").textContent = money(pNight);
    document.getElementById("pWeek").textContent  = money(pWeek);
    document.getElementById("pMonth").textContent = money(pMonth);

    // Wave + owner
    document.getElementById("wave").textContent = OWNER_WAVE || "‚Äî";
    document.getElementById("ownerName").textContent = OWNER_NAME;
    document.getElementById("ownerPhone").textContent = OWNER_PHONE ? `üìû ${OWNER_PHONE}` : "‚Äî";
    if(!OWNER_WAVE){
      document.getElementById("waveNote").textContent = "‚ö†Ô∏è Num√©ro Wave non renseign√© pour ce lieu.";
    }

    // NDIMBAL
    if (ndEnabled){
      document.getElementById("ndBox").style.display = "block";
      document.getElementById("btnNdimbal").onclick = openNd;
    }

    // CTA
    document.getElementById("btnCall").onclick = () => { if (phoneDigits) location.href = `tel:${phoneDigits}`; };
    document.getElementById("btnWa").onclick = () => {
      if (!waDigits) return;
      const msg = `Bonjour, je souhaite r√©server ${title}${city ? " √† " + city : ""}.`;
      window.open(`https://wa.me/${waDigits}?text=${encodeURIComponent(msg)}`, "_blank", "noopener,noreferrer");
    };

    // Partner
    const btnPartner = document.getElementById("btnPartner");
    if (partnerUrl) btnPartner.onclick = () => window.open(partnerUrl, "_blank", "noopener,noreferrer");
    else btnPartner.onclick = () => showPayNote("Fiche partenaire non renseign√©e (partner_url).", "warn");

    // Video
    const btnVideo = document.getElementById("btnVideo");
    if (video) {
      btnVideo.style.display = "flex";
      btnVideo.onclick = () => window.open(video, "_blank", "noopener,noreferrer");
    } else {
      btnVideo.style.display = "none";
    }

    document.getElementById("foot").textContent = `${title} ¬∑ DIGIY LOC ‚ôæÔ∏è`;

    // Pay declare
    document.getElementById("btnPaid").addEventListener("click", declarePaid);
  });

  async function declarePaid(){
    showPayNote("", "");

    const amtRaw = (document.getElementById("cAmt").value || "").trim();
    const amt = Number(amtRaw.replace(/\D/g,""));

    if(!amt || amt <= 0){
      showPayNote("Montant invalide. Exemple: 30000", "warn");
      return;
    }
    if(!OWNER_WAVE){
      showPayNote("Num√©ro Wave introuvable pour ce logement.", "bad");
      return;
    }

    const clientName = (document.getElementById("cName").value || "").trim();
    const clientPhone = (document.getElementById("cPhone").value || "").trim();
    const note = (document.getElementById("cNote").value || "").trim();

    const btn = document.getElementById("btnPaid");
    const old = btn.textContent;
    btn.disabled = true;
    btn.textContent = "‚è≥ Envoi‚Ä¶";

    try{
      const { data, error } = await sb.rpc(RPC_DECL, {
        p_slug: slug,
        p_owner_phone: OWNER_PHONE || OWNER_WAVE,  // ownership phone match go_pins.phone
        p_amount: amt,
        p_client_name: clientName || null,
        p_client_phone: clientPhone || null,
        p_note: note || null,
        p_proof_url: null
      });
      if(error) throw error;

      if(!data || data.ok !== true){
        showPayNote("‚õî Refus: " + (data?.reason || "not_owner_phone"), "bad");
        btn.disabled = false; btn.textContent = old;
        return;
      }

      showPayNote(
        "‚úÖ Merci ! Paiement d√©clar√©.\n" +
        "Le propri√©taire pourra confirmer plus vite.\n" +
        "Astuce : envoie aussi le message WhatsApp ci-dessous.",
        "ok"
      );

      const msg =
        `Bonjour ${TITLE} üëã\n` +
        `J‚Äôai pay√© ${amt.toLocaleString("fr-FR")} FCFA sur Wave (${OWNER_WAVE}).\n` +
        (clientName ? `Nom: ${clientName}\n` : "") +
        (clientPhone ? `Tel: ${clientPhone}\n` : "") +
        (note ? `Note: ${note}\n` : "") +
        `Je confirme via DIGIY LOC.`;

      const wa = waLink(OWNER_PHONE || OWNER_WAVE, msg);
      if(wa !== "#") window.open(wa, "_blank", "noopener,noreferrer");

      btn.disabled = false; btn.textContent = "‚úÖ D√©clar√©";
      setTimeout(()=>{ btn.textContent = old; }, 1400);

    }catch(e){
      console.error(e);
      showPayNote("‚ùå Erreur : " + (e?.message || e), "bad");
      btn.disabled = false;
      btn.textContent = old;
    }
  }
})();
</script>
</body>
</html>
