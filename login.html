<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>DIGIY LOC ‚Ä¢ PRO ‚Äî Connexion</title>
  <meta name="theme-color" content="#16a34a"/>

  <style>
    :root{
      --bg:#061b14; --card:#0b2a1f; --line:rgba(255,255,255,.14);
      --text:#eafff1; --muted:rgba(234,255,241,.75);
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --radius:18px;
    }
    body{
      margin:0; min-height:100vh; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background:radial-gradient(900px 500px at 10% -10%, rgba(34,197,94,.20), transparent 60%), var(--bg);
      color:var(--text);
      display:flex; align-items:center; justify-content:center;
      padding:18px;
    }
    .wrap{width:min(720px, 100%);}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:18px;
      box-shadow:0 20px 55px rgba(0,0,0,.35);
    }
    h1{margin:4px 0 6px; font-size:20px}
    .muted{color:var(--muted)}
    .grid{display:grid; grid-template-columns:1fr; gap:12px; margin-top:14px}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    input{
      width:100%;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
      font-weight:700;
    }
    input::placeholder{color:rgba(234,255,241,.55)}
    button{
      cursor:pointer;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.08);
      color:var(--text);
      font-weight:900;
    }
    button.primary{
      border-color:rgba(34,197,94,.55);
      background:rgba(34,197,94,.16);
    }
    button:disabled{opacity:.55; cursor:not-allowed}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      font-size:12px;
      font-weight:800;
    }
    .ok{border-color:rgba(34,197,94,.55); background:rgba(34,197,94,.12)}
    .bad{border-color:rgba(239,68,68,.55); background:rgba(239,68,68,.12)}
    .warn{border-color:rgba(245,158,11,.55); background:rgba(245,158,11,.12)}
    .small{font-size:12px}
    .sep{height:1px; background:var(--line); margin:14px 0}
    code{background:rgba(0,0,0,.25); padding:2px 6px; border-radius:8px}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>üîê DIGIY LOC ‚Ä¢ PRO ‚Äî Connexion</h1>
      <div class="muted">
        Connexion s√©curis√©e par <b>Magic Link</b> (email) + t√©l√©phone.
        Une fois connect√©, LOC est verrouill√© par abonnement.
      </div>

      <div class="sep"></div>

      <div class="grid">
        <div class="row">
          <div class="pill" id="authPill">Auth: ‚Ä¶</div>
          <div class="pill warn" id="hintPill">Astuce: utilise ton email pro</div>
        </div>

        <div>
          <label class="small muted">Email</label>
          <input id="email" type="email" placeholder="ex: toi@domaine.com" autocomplete="email"/>
        </div>

        <div>
          <label class="small muted">T√©l√©phone (S√©n√©gal)</label>
          <input id="phone" type="tel" placeholder="+221771234567" inputmode="tel" autocomplete="tel"/>
          <div class="muted small">Format conseill√©: <code>+221XXXXXXXXX</code></div>
        </div>

        <div class="row">
          <button class="primary" id="btnSend">üì© Envoyer le Magic Link</button>
          <button id="btnLogout">üö™ Logout</button>
        </div>

        <div class="muted small" id="msg"></div>

        <div class="sep"></div>

        <div class="muted small">
          Apr√®s clic sur le lien re√ßu, tu reviens ici <b>1 seconde</b> (pour cr√©er la session),
          puis redirection automatique vers <code>planning.html</code>.
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  "use strict";

  // =============================
  // SUPABASE
  // =============================
  const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // =============================
  // UI
  // =============================
  const $ = (id)=>document.getElementById(id);
  const emailInput = $("email");
  const phoneInput = $("phone");
  const msg = $("msg");
  const authPill = $("authPill");
  const btnSend = $("btnSend");
  const btnLogout = $("btnLogout");

  function setPill(ok, text){
    authPill.className = "pill " + (ok ? "ok" : "bad");
    authPill.textContent = text;
  }

  function goPlanning(){ location.replace("./planning.html"); }

  // =============================
  // PHONE CACHE (local)
  // =============================
  function normPhone(p){
    p = String(p||"").trim().replace(/\s+/g,"").replace(/[^\d+]/g,"");
    if(p.startsWith("00221")) p = "+221" + p.slice(5);
    if(!p.startsWith("+") && p.startsWith("221")) p = "+" + p;
    if(!p.startsWith("+221") && /^\d{9}$/.test(p)) p = "+221" + p;
    return p;
  }
  function savePhone(phone){
    const p = normPhone(phone);
    sessionStorage.setItem("digiy_phone", p);
    sessionStorage.setItem("digiy_driver_phone", p);
    try{
      localStorage.setItem("digiy_access_pin", JSON.stringify({ phone: p }));
      localStorage.setItem("digiy_driver_access_pin", JSON.stringify({ phone: p }));
    }catch(_){}
    return p;
  }
  function loadPhone(){
    const s = sessionStorage.getItem("digiy_phone") || sessionStorage.getItem("digiy_driver_phone");
    if(s) return s;
    try{
      const a = JSON.parse(localStorage.getItem("digiy_access_pin")||"null");
      return a?.phone || "";
    }catch(_){ return ""; }
  }

  // =============================
  // MAGIC LINK: consume ?code=
  // =============================
  async function consumeMagicLinkIfAny(){
    const url = new URL(window.location.href);
    const code = url.searchParams.get("code");
    if(!code) return false;

    msg.textContent = "Validation du lien‚Ä¶";
    const { error } = await sb.auth.exchangeCodeForSession(window.location.href);

    if(error){
      msg.textContent = "Erreur validation: " + error.message;
      return false;
    }

    // Nettoie URL
    url.searchParams.delete("code");
    window.history.replaceState({}, "", url.toString());

    msg.textContent = "Connexion r√©ussie ‚úÖ";
    return true;
  }

  // =============================
  // SESSION CHECK
  // =============================
  async function refreshAuth(){
    const { data } = await sb.auth.getSession();
    if(data?.session){
      setPill(true, "Auth: ‚úÖ connect√©");
      msg.textContent = "Session OK. Redirection‚Ä¶";
      setTimeout(goPlanning, 350);
      return true;
    }
    setPill(false, "Auth: ‚ùå Auth session missing!");
    return false;
  }

  // =============================
  // SEND MAGIC LINK
  // =============================
  async function sendMagicLink(){
    const email = (emailInput.value || "").trim();
    const phoneRaw = (phoneInput.value || "").trim();

    if(!email) return alert("Email requis");
    if(!phoneRaw) return alert("T√©l√©phone requis");

    const phone = savePhone(phoneRaw);
    msg.textContent = "Envoi du lien‚Ä¶ (" + phone + ")";

    btnSend.disabled = true;

    const { error } = await sb.auth.signInWithOtp({
      email,
      options: {
        // ‚úÖ Forcer le retour exact sur LOC PRO (GitHub Pages)
        emailRedirectTo: "https://beauville.github.io/digiy-loc-pro/login.html"
      }
    });

    btnSend.disabled = false;

    if(error){
      msg.textContent = "Erreur: " + error.message;
      return;
    }
    msg.textContent = "Lien envoy√© ‚úÖ Ouvre ton email et clique.";
  }

  // =============================
  // LOGOUT
  // =============================
  async function logout(){
    await sb.auth.signOut();
    setPill(false, "Auth: ‚ùå d√©connect√©");
    msg.textContent = "D√©connect√©.";
  }

  // =============================
  // INIT
  // =============================
  btnSend.addEventListener("click", sendMagicLink);
  btnLogout.addEventListener("click", logout);

  phoneInput.value = loadPhone();

  (async ()=>{
    await consumeMagicLinkIfAny(); // cr√©e la session si ?code=
    await refreshAuth();           // redirige planning si session
  })();

})();
</script>
</body>
</html>
