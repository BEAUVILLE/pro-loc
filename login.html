<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>DIGIY ‚ôæÔ∏è ‚Äî GO PIN</title>
  <meta name="theme-color" content="#064e3b"/>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg0:#02130f;
      --bg1:#022c22;
      --bg2:#065f46;

      --glass:rgba(2,44,34,.35);
      --line:rgba(148,163,184,.24);

      --text:#ecfdf5;
      --muted:rgba(236,253,245,.74);

      --gold:#facc15;
      --ok:#22c55e;
      --bad:#ef4444;

      --shadow:0 22px 60px rgba(0,0,0,.55);
      --radius:22px;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 520px at 15% -10%, rgba(250,204,21,.14), transparent 60%),
        radial-gradient(900px 520px at 90% 10%, rgba(34,197,94,.12), transparent 60%),
        radial-gradient(700px 420px at 30% 90%, rgba(245,158,11,.10), transparent 60%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
      padding:16px;
      -webkit-font-smoothing: antialiased;
      -webkit-text-size-adjust: 100%;
    }

    /* ‚úÖ iOS touch safe */
    *{ -webkit-tap-highlight-color: transparent; }
    a,button{ touch-action: manipulation; }
    body::before, body::after, .fx, .overlay, .glow { pointer-events:none !important; }
    .wrap, .top, .card, .btnRow, .btn, .pill, .cta { position:relative; z-index:2; }

    .wrap{max-width:560px;margin:0 auto;padding:4px}

    .top{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      padding:12px 12px;
    }

    .brand{
      display:flex;align-items:center;gap:10px;min-width:0;
    }
    .logo{
      width:44px;height:44px;border-radius:16px;
      background:linear-gradient(135deg, rgba(250,204,21,.28), rgba(34,197,94,.14));
      border:1px solid rgba(250,204,21,.35);
      box-shadow:0 0 24px rgba(250,204,21,.12);
      display:grid;place-items:center;
      font-weight:1100;color:#062e22;
    }
    .brandTxt{min-width:0}
    .brandTitle{
      font-weight:1100;
      font-size:18px;
      letter-spacing:.04em;
      line-height:1.1;
      white-space:nowrap;
      overflow:hidden;text-overflow:ellipsis;
    }
    .brandSub{
      margin-top:3px;
      font-size:12px;
      color:var(--muted);
      font-weight:900;
    }

    .pill{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      padding:9px 12px;
      border-radius:999px;
      font-weight:1000;
      font-size:12px;
      color:var(--muted);
      display:inline-flex;gap:8px;align-items:center;
      max-width:100%;
    }
    .pill strong{color:#fff}
    .pill.tag{
      background:rgba(250,204,21,.12);
      border-color:rgba(250,204,21,.30);
      color:#fff;
    }

    .card{
      margin-top:8px;
      border-radius:var(--radius);
      border:1px solid rgba(148,163,184,.18);
      background:linear-gradient(180deg, rgba(2,44,34,.42), rgba(2,44,34,.20));
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .cardInner{padding:16px}

    .title{
      font-size:34px;
      font-weight:1200;
      letter-spacing:-.02em;
      line-height:1.05;
    }
    .meta{
      margin-top:8px;
      color:var(--muted);
      font-weight:900;
      font-size:15px;
    }

    .pinRow{
      margin-top:14px;
      display:flex;align-items:center;gap:12px;flex-wrap:wrap;
    }
    .pinLabel{
      color:var(--muted);
      font-weight:1000;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-size:12px;
    }

    .pinInputRow{
      margin-top:12px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .pinInput{
      flex:1 1 220px;
      min-height:54px;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid rgba(250,204,21,.30);
      background:rgba(250,204,21,.08);
      color:#fff;
      font-weight:1100;
      font-size:18px;
      letter-spacing:.18em;
      outline:none;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    .pinInput:focus{
      border-color:rgba(250,204,21,.55);
      box-shadow:0 0 0 3px rgba(250,204,21,.12);
    }

    .btnMini{
      min-height:54px;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid rgba(250,204,21,.35);
      background:rgba(250,204,21,.12);
      color:#fff;
      font-weight:1100;
      font-size:16px;
      cursor:pointer;
      user-select:none;
    }
    .btnMini:active{transform:scale(.99)}
    .btnMini[disabled]{opacity:.55;cursor:not-allowed}

    .hint{
      margin-top:8px;
      color:rgba(236,253,245,.70);
      font-weight:900;
      font-size:13px;
      line-height:1.35;
    }

    .btnRow{margin-top:14px;display:flex;flex-direction:column;gap:12px}

    .btn{
      width:100%;
      min-height:56px;
      border-radius:18px;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(255,255,255,.04);
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      color:#fff;
      font-weight:1100;
      font-size:18px;
      display:flex;align-items:center;justify-content:center;gap:12px;
      text-decoration:none;
      user-select:none;
      cursor:pointer;
      transform: translateZ(0);
      -webkit-transform: translateZ(0);
    }
    .btn:active{transform:scale(.99)}
    .btn.primary{
      border-color:rgba(34,197,94,.35);
      background:rgba(34,197,94,.10);
    }
    .btn.gold{
      border-color:rgba(250,204,21,.35);
      background:rgba(250,204,21,.12);
    }
    .btn.disabled{
      opacity:.45;
      filter:saturate(.7);
      cursor:not-allowed;
      pointer-events:none;
    }
    .btn .ico{
      width:30px;height:30px;border-radius:999px;
      display:grid;place-items:center;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(148,163,184,.18);
      font-size:16px;
    }

    .footer{
      margin-top:14px;
      padding:14px 16px;
      border-top:1px solid rgba(148,163,184,.14);
      background:rgba(0,0,0,.12);
      color:rgba(236,253,245,.70);
      font-weight:900;
      text-align:center;
      letter-spacing:.02em;
    }

    .status{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      font-weight:1000;
      font-size:13px;
      white-space:pre-wrap;
      display:none;
    }
    .status.ok{display:block;border-color:rgba(34,197,94,.30);background:rgba(34,197,94,.10);color:#bbf7d0}
    .status.bad{display:block;border-color:rgba(239,68,68,.30);background:rgba(239,68,68,.10);color:#fecaca}
    .status.warn{display:block;border-color:rgba(250,204,21,.30);background:rgba(250,204,21,.10);color:#fde68a}

    @media (max-width:420px){
      body{padding:12px}
      .title{font-size:30px}
      .btn{min-height:54px;font-size:17px}
      .pinInput,.btnMini{min-height:52px}
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="top">
      <div class="brand">
        <div class="logo">‚àû</div>
        <div class="brandTxt">
          <div class="brandTitle">DIGIY ‚ôæÔ∏è ‚Äî GO PIN</div>
          <div class="brandSub">Terrain ‚Ä¢ Rapide ‚Ä¢ Direct</div>
        </div>
      </div>

      <div class="pill tag" id="pillSlug">
        slug: <strong id="pillSlugVal">‚Äî</strong>
      </div>
    </div>

    <div class="card">
      <div class="cardInner">
        <div class="title" id="tTitle">‚Äî</div>
        <div class="meta">Cat√©gorie: <strong id="tCat">‚Äî</strong></div>

        <div class="pinRow">
          <div class="pinLabel">D√©bloque avec ton PIN</div>
        </div>

        <div class="pinInputRow">
          <input class="pinInput" id="pinInput" type="password" inputmode="numeric" autocomplete="one-time-code"
                 placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="8" />
          <button class="btnMini" id="btnUnlock" type="button">GO</button>
        </div>

        <div class="hint" id="hint">
          ‚ö†Ô∏è Tant que le PIN n‚Äôest pas valid√©, les boutons restent bloqu√©s.
        </div>

        <div class="btnRow">
          <a class="btn primary disabled" id="btnCall" href="#">
            <span class="ico">üìû</span>
            Appeler
          </a>

          <a class="btn primary disabled" id="btnWA" href="#">
            <span class="ico">üí¨</span>
            WhatsApp
          </a>

          <a class="btn gold disabled" id="btnMap" href="#" target="_blank" rel="noopener">
            <span class="ico">üìç</span>
            Itin√©raire
          </a>

          <button class="btn" id="btnShare" type="button">
            <span class="ico">üîó</span>
            Partager
          </button>
        </div>

        <div class="status warn" id="status"></div>
      </div>

      <div class="footer">0% commission ‚Ä¢ Contact direct ‚Ä¢ DIGIYLYFE</div>
    </div>
  </div>

  <script>
    /* =============================
       CONFIG
    ============================= */

    const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

    // RPCs (mode PROD secure)
    const RPC_GET = "go_pin_get_by_slug";  // doit renvoyer ok,true + infos (sans pin_code)
    const RPC_VERIFY = "go_pin_verify";    // params: p_slug, p_pin -> {ok:true|false}

    const SB = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* =============================
       HELPERS
    ============================= */
    const $ = (id)=>document.getElementById(id);

    function setDisabled(id, on){
      const el = $(id);
      if(!el) return;
      el.classList.toggle("disabled", !!on);
      if(el.tagName === "A"){
        el.setAttribute("aria-disabled", on ? "true" : "false");
      }else{
        el.disabled = !!on;
      }
    }

    function showStatus(msg, cls){
      const el = $("status");
      const text = String(msg || "").trim();
      if(!text){
        el.textContent = "";
        el.style.display = "none";
        el.className = "status";
        return;
      }
      el.className = "status " + (cls || "warn");
      el.textContent = text;
      el.style.display = "block";
    }

    function normPhone(p){
      let s = String(p||"").trim();
      if(!s) return "";
      s = s.replace(/[^\d+]/g,"");
      if(s.startsWith("00")) s = "+" + s.slice(2);
      if(s.startsWith("221") && !s.startsWith("+221")) s = "+221" + s.slice(3);
      if(/^\d{9}$/.test(s)) s = "+221" + s;
      return s;
    }

    function waLink(phone, text){
      const num = String(phone||"").replace(/[^\d]/g,"");
      return "https://wa.me/" + num + (text ? ("?text=" + encodeURIComponent(text)) : "");
    }

    function isIOS(){
      return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    }

    function mapsLink(lat, lng, label){
      const q = (label ? label : (lat + "," + lng));
      if(isIOS()){
        return "https://maps.apple.com/?q=" + encodeURIComponent(q) + "&ll=" + encodeURIComponent(lat + "," + lng);
      }
      return "https://www.google.com/maps?q=" + encodeURIComponent(q) + "&ll=" + encodeURIComponent(lat + "," + lng);
    }

    async function copyText(txt){
      try{
        await navigator.clipboard.writeText(txt);
        return true;
      }catch(_){
        try{
          const ta = document.createElement("textarea");
          ta.value = txt;
          ta.setAttribute("readonly", "");
          ta.style.position = "fixed";
          ta.style.top = "-9999px";
          document.body.appendChild(ta);
          ta.select();
          const ok = document.execCommand("copy");
          ta.remove();
          return ok;
        }catch(__){
          return false;
        }
      }
    }

    function lockActions(){
      setDisabled("btnCall", true);
      setDisabled("btnWA", true);
      setDisabled("btnMap", true);
      $("btnCall").href = "#";
      $("btnWA").href = "#";
      $("btnMap").href = "#";
      $("hint").textContent = "‚ö†Ô∏è Tant que le PIN n‚Äôest pas valid√©, les boutons restent bloqu√©s.";
    }

    function unlockActions(){
      $("hint").textContent = "‚úÖ PIN valid√©. Tu peux contacter directement.";
    }

    /* =============================
       SLUG
    ============================= */
    const url = new URL(location.href);
    const slug = (url.searchParams.get("slug") || "").trim();
    $("pillSlugVal").textContent = slug || "‚Äî";

    // state data (rempli apr√®s load)
    let GO = null;

    lockActions();

    if(!slug){
      showStatus("GO PIN introuvable.\n‚û°Ô∏è Il manque ?slug=.... dans l‚ÄôURL", "bad");
    }

    /* =============================
       LOAD GO PIN (RPC GET)
    ============================= */
    async function loadGoPin(){
      if(!slug) return;

      showStatus("‚è≥ Chargement‚Ä¶", "warn");

      try{
        const { data, error } = await SB.rpc(RPC_GET, { p_slug: slug });
        if(error) throw error;

        let out = data;
        if(typeof out === "string"){
          try{ out = JSON.parse(out); }catch(_){}
        }
        if(Array.isArray(out)) out = out[0];

        if(!out || out.ok === false){
          showStatus("‚ùå GO PIN introuvable ou inactif.", "bad");
          return;
        }

        GO = {
          slug: out.slug || slug,
          title: out.title || "‚Äî",
          category: out.category || "‚Äî",
          phone: normPhone(out.phone),
          whatsapp: normPhone(out.whatsapp || out.phone),
          lat: out.lat,
          lng: out.lng
        };

        $("tTitle").textContent = GO.title;
        $("tCat").textContent = GO.category;

        showStatus("üîí Entre le PIN pour d√©bloquer.", "warn");

        // Share fonctionne m√™me sans unlock (le lien est public)
        wireShare();

        // UX: focus direct
        setTimeout(()=> $("pinInput").focus(), 150);

      }catch(err){
        console.error(err);
        showStatus("‚ùå Erreur chargement.\nD√©tail: " + (err?.message || err), "bad");
      }
    }

    function wireShare(){
      $("btnShare").onclick = async ()=>{
        const shareUrl = location.origin + location.pathname + "?slug=" + encodeURIComponent((GO && GO.slug) ? GO.slug : slug);
        const title = GO?.title ? `DIGIY ‚Ä¢ ${GO.title}` : "DIGIY ‚Ä¢ GO PIN";
        const txt = GO?.title ? `DIGIY ‚Ä¢ ${GO.title}\nCat√©gorie: ${GO.category}\n` : "DIGIY ‚Ä¢ GO PIN\n";

        try{
          if(navigator.share){
            await navigator.share({ title, text: txt, url: shareUrl });
            return;
          }
          const ok = await copyText(shareUrl);
          showStatus(ok ? "‚úÖ Lien copi√©." : "‚ö†Ô∏è Copie impossible sur ce navigateur.", ok ? "ok" : "warn");
          setTimeout(()=>showStatus("üîí Entre le PIN pour d√©bloquer.", "warn"), 900);
        }catch(e){
          console.log(e);
        }
      };
    }

    /* =============================
       VERIFY PIN (RPC VERIFY)
    ============================= */
    function cleanPin(v){
      return String(v||"").trim().replace(/[^\d]/g,"").slice(0,8);
    }

    async function verifyPin(){
      if(!GO){
        showStatus("‚ö†Ô∏è On charge d‚Äôabord la fiche‚Ä¶", "warn");
        return;
      }

      const pin = cleanPin($("pinInput").value);
      $("pinInput").value = pin;

      if(pin.length < 4){
        showStatus("‚ö†Ô∏è Mets au moins 4 chiffres.", "warn");
        return;
      }

      $("btnUnlock").disabled = true;
      showStatus("‚è≥ V√©rification du PIN‚Ä¶", "warn");

      try{
        const { data, error } = await SB.rpc(RPC_VERIFY, { p_slug: GO.slug, p_pin: pin });
        if(error) throw error;

        let out = data;
        if(typeof out === "string"){
          try{ out = JSON.parse(out); }catch(_){}
        }
        if(Array.isArray(out)) out = out[0];

        if(out && out.ok === true){
          // ‚úÖ unlock actions
          unlockActions();
          showStatus("‚úÖ PIN valid√©. Tu peux contacter.", "ok");

          // Call
          if(GO.phone){
            $("btnCall").href = "tel:" + GO.phone.replace(/\s/g,"");
            setDisabled("btnCall", false);
          }else{
            setDisabled("btnCall", true);
          }

          // WhatsApp
          if(GO.whatsapp){
            const msg = `DIGIY ‚Ä¢ ${GO.title}\nSalut, je viens via DIGIY.`;
            $("btnWA").href = waLink(GO.whatsapp, msg);
            setDisabled("btnWA", false);
          }else{
            setDisabled("btnWA", true);
          }

          // Map
          const hasMap = Number.isFinite(+GO.lat) && Number.isFinite(+GO.lng);
          if(hasMap){
            $("btnMap").href = mapsLink(+GO.lat, +GO.lng, GO.title);
            setDisabled("btnMap", false);
          }else{
            // fallback: recherche par nom si pas de coords
            $("btnMap").href = isIOS()
              ? ("https://maps.apple.com/?q=" + encodeURIComponent(GO.title))
              : ("https://www.google.com/maps?q=" + encodeURIComponent(GO.title));
            setDisabled("btnMap", false);
          }

          return;
        }

        showStatus("‚ùå PIN incorrect.", "bad");
        lockActions();

      }catch(err){
        console.error(err);
        showStatus("‚ùå Erreur v√©rif PIN.\nD√©tail: " + (err?.message || err), "bad");
        lockActions();
      }finally{
        $("btnUnlock").disabled = false;
      }
    }

    $("btnUnlock").addEventListener("click", verifyPin);
    $("pinInput").addEventListener("keydown", (e)=>{
      if(e.key === "Enter") verifyPin();
    });

    // Init
    loadGoPin();
  </script>
</body>
</html>
