<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>DIGIY LOC PRO â€” Health</title>
  <meta name="theme-color" content="#16a34a" />

  <style>
    :root{
      --bg:#061b14; --card:#0b2a1f; --line:rgba(255,255,255,.14);
      --text:#eafff1; --muted:rgba(234,255,241,.75);
      --ok:#22c55e; --bad:#ef4444; --warn:#f59e0b;
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background:radial-gradient(900px 500px at 10% -10%, rgba(34,197,94,.20), transparent 60%),var(--bg);
      color:var(--text);
    }
    .wrap{max-width:980px;margin:0 auto;padding:18px;}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:16px;
      margin:12px 0
    }
    h1{margin:6px 0 2px;font-size:20px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;align-items:center}
    .pill{
      padding:8px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(0,0,0,.18);font-weight:800;font-size:12px
    }
    .ok{border-color:rgba(34,197,94,.55);background:rgba(34,197,94,.12)}
    .bad{border-color:rgba(239,68,68,.55);background:rgba(239,68,68,.12)}
    .warn{border-color:rgba(245,158,11,.55);background:rgba(245,158,11,.12)}
    code{background:rgba(0,0,0,.25);padding:2px 6px;border-radius:8px}
    .grid{display:grid;grid-template-columns:220px 1fr;gap:10px;margin-top:12px}
    .k{color:var(--muted);font-weight:800;font-size:12px}
    .v{word-break:break-word}
    button{
      cursor:pointer;border:1px solid var(--line);
      background:rgba(255,255,255,.06);color:var(--text);
      padding:10px 12px;border-radius:14px;font-weight:900
    }
    button:hover{background:rgba(255,255,255,.09)}
    .small{font-size:12px;color:var(--muted);line-height:1.35}
  </style>

  <!-- Supabase (CDN) + Guard -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./guard.js?v=locpro-final"></script>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>DIGIY LOC PRO â€” Health</h1>
      <div class="muted">
        ContrÃ´le qualitÃ© PRO (preuve â€œCLEANâ€). Module: <b id="pillModule">LOC</b> Â· slug: <b id="pillSlug">â€”</b>
      </div>

      <div class="row" id="pills" style="margin-top:10px"></div>

      <div class="row" style="margin-top:12px">
        <button id="btnRun">ğŸ” Re-tester</button>
        <button id="btnClear">ğŸ§¹ Clear cache</button>
        <button id="btnGoApp">ğŸ  APP</button>
        <button id="btnGoPlanning">ğŸ—“ï¸ Planning</button>
        <button id="btnGoLinks">ğŸ”— Manage Links</button>
        <button id="btnGoLogin">ğŸ” PIN</button>
        <button id="btnGoPay">ğŸ’³ Paiement</button>
        <button id="btnLogout">ğŸšª Logout</button>
      </div>

      <div class="muted" id="msg" style="margin-top:10px"></div>
      <div class="small" style="margin-top:8px">
        Astuce : si tu vois â€œslug â€”â€, ouvre cette page via un lien avec <code>?slug=chez-astou-saly</code>.
      </div>
    </div>

    <div class="card">
      <div class="grid" id="grid"></div>
    </div>
  </div>

<script>
(function(){
  "use strict";

  // =============================
  // CONFIG
  // =============================
  const MODULE = "loc";
  const PAY_URL = "https://beauville.github.io/commencer-a-payer/";

  const $ = (id)=>document.getElementById(id);
  const msg = $("msg");

  function setMsg(t){ msg.textContent = t || ""; }

  const hasGuard = !!(window.DIGIY_GUARD && typeof window.DIGIY_GUARD.withSlug === "function");

  function safeWithSlug(url){
    return hasGuard ? window.DIGIY_GUARD.withSlug(url) : url;
  }

  function getSlug(){
    try{
      const s = window.DIGIY_GUARD?.getSlug?.();
      if(s) return String(s||"").trim();
    }catch(_){}
    try{ return (new URL(location.href).searchParams.get("slug") || "").trim(); }catch(_){ return ""; }
  }

  function pill(text, kind){
    const el = document.createElement("div");
    el.className = "pill " + (kind||"");
    el.textContent = text;
    return el;
  }
  function setPills(items){
    const host = $("pills");
    host.innerHTML = "";
    items.forEach(x => host.appendChild(pill(x.text, x.kind)));
  }
  function setGrid(rows){
    const g = $("grid");
    g.innerHTML = "";
    rows.forEach(r=>{
      const k = document.createElement("div");
      k.className = "k";
      k.textContent = r.k;
      const v = document.createElement("div");
      v.className = "v";
      v.textContent = r.v;
      g.appendChild(k); g.appendChild(v);
    });
  }

  function normPhone(p){
    p = String(p||"").trim().replace(/\s+/g,"").replace(/[^\d+]/g,"");
    if(p.startsWith("00221")) p = "+221" + p.slice(5);
    if(!p.startsWith("+") && p.startsWith("221")) p = "+" + p;
    if(!p.startsWith("+221") && /^\d{9}$/.test(p)) p = "+221" + p;
    return p;
  }

  function clearCache(){
    // cache legacy
    sessionStorage.removeItem("digiy_phone");
    sessionStorage.removeItem("digiy_driver_phone");
    localStorage.removeItem("digiy_access_pin");
    localStorage.removeItem("digiy_driver_access_pin");
    localStorage.removeItem("digiy_loc_pro_session");
    // cache session V1 (nouveau)
    localStorage.removeItem("DIGIY_LOC_PRO_SESSION_V1");
    // cache abo guard
    localStorage.removeItem("digiy_loc_subs_cache_v1");
  }

  function guardLogout(){
    const go = safeWithSlug("./pin.html");
    try{
      window.DIGIY_GUARD?.logout?.(go);
      return;
    }catch(_){}
    try{ window.DIGIY_GUARD?.clearSession?.(); }catch(_){}
    location.replace(go);
  }

  function goPay(){
    const slug = getSlug();
    const sess = window.DIGIY_GUARD?.getSession?.() || null;
    const phone = normPhone(sess?.phone || "");
    const from = location.href;

    const url =
      PAY_URL
      + "?module=" + encodeURIComponent("LOC")
      + (phone ? "&phone=" + encodeURIComponent(phone) : "")
      + "&from=" + encodeURIComponent(from)
      + (slug ? "&slug=" + encodeURIComponent(slug) : "");

    location.href = url;
  }

  // =============================
  // RUN CHECKS (GUARD FIRST)
  // =============================
  async function run(){
    const rows = [];
    const pills = [];

    $("pillModule").textContent = "LOC";
    const slug = getSlug();
    $("pillSlug").textContent = slug || "â€”";

    rows.push({k:"URL", v: location.href});
    rows.push({k:"slug", v: slug || "â€”"});
    rows.push({k:"Guard trouvÃ©", v: String(hasGuard)});

    if(!hasGuard){
      pills.push({text:"GUARD âŒ", kind:"bad"});
      setPills(pills);
      setGrid(rows);
      setMsg("âŒ guard.js manquant ou non chargÃ©.");
      return;
    }

    setMsg("â³ Boot guardâ€¦");

    const guardRes = await window.DIGIY_GUARD.boot({
      module: MODULE,
      dashboard: "./app.html",
      login: "./pin.html",
      pay: PAY_URL,
      requireSlug: true,
      checkSubscription: true
    });

    if(!guardRes?.ok){
      pills.push({text:"BOOT âš ï¸", kind:"warn"});
      rows.push({k:"boot", v: JSON.stringify(guardRes || {})});
      setPills(pills);
      setGrid(rows);
      setMsg("âš ï¸ boot non OK (redirection possible).");
      return;
    }

    pills.push({text:"GUARD âœ…", kind:"ok"});

    const sess = window.DIGIY_GUARD.getSession?.() || null;
    const sb = window.DIGIY_GUARD.getSb?.() || window.DIGIY_GUARD.sb || null;

    rows.push({k:"Session ok", v: String(!!sess?.ok)});
    rows.push({k:"Phone", v: sess?.phone || "â€”"});
    rows.push({k:"Owner ID", v: sess?.owner_id || "â€”"});
    rows.push({k:"Business code", v: sess?.business_code || sess?.businessCode || "â€”"});
    rows.push({k:"Supabase (guard)", v: sb?.from ? "OK" : "NO"});

    if(sess?.ok && sess?.owner_id) pills.push({text:"SESSION âœ…", kind:"ok"});
    else pills.push({text:"SESSION âŒ", kind:"bad"});

    if(guardRes?.subscription_ok === true) pills.push({text:"ABO âœ…", kind:"ok"});
    else if(guardRes?.subscription_ok === false) pills.push({text:"ABO âŒ", kind:"bad"});
    else pills.push({text:"ABO â€”", kind:"warn"});

    // Optional: test RPC is_module_active (si disponible)
    try{
      const phone = normPhone(sess?.phone || "");
      if(sb?.rpc && phone){
        const { data, error } = await sb.rpc("is_module_active", { p_phone: phone, p_module: "LOC" });
        if(error) throw error;
        rows.push({k:"is_module_active", v: String(!!data)});
        pills.push({text: data ? "LOC âœ… ACTIVE" : "LOC âŒ INACTIVE", kind: data ? "ok" : "bad"});
      }else{
        rows.push({k:"is_module_active", v: "SkippÃ© (sb/phone)"});
      }
    }catch(e){
      rows.push({k:"is_module_active", v: "Erreur: " + (e?.message || e)});
      pills.push({text:"RPC âš ï¸", kind:"warn"});
    }

    rows.push({k:"Date/heure", v: new Date().toString()});

    setPills(pills);
    setGrid(rows);
    setMsg("âœ… OK. Health validÃ©.");
  }

  // =============================
  // ACTIONS
  // =============================
  $("btnRun").addEventListener("click", run);

  $("btnClear").addEventListener("click", function(){
    clearCache();
    alert("Cache effacÃ©. Recharge / reconnecte si besoin.");
    run();
  });

  $("btnGoApp").addEventListener("click", ()=> location.href = safeWithSlug("./app.html"));
  $("btnGoPlanning").addEventListener("click", ()=> location.href = safeWithSlug("./planning.html"));

  // âœ… ICI : Manage Links = manage-links.html (slug conservÃ©)
  $("btnGoLinks").addEventListener("click", ()=> location.href = safeWithSlug("./manage-links.html"));

  // âœ… Login PRO = PIN (pas login email)
  $("btnGoLogin").addEventListener("click", ()=> location.href = safeWithSlug("./pin.html"));

  $("btnGoPay").addEventListener("click", goPay);

  $("btnLogout").addEventListener("click", guardLogout);

  run();
})();
</script>
</body>
</html>
